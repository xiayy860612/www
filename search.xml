<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>MySQL备份和恢复</title>
    <url>/2021/06/MySQL/backup-rollback/</url>
    <content><![CDATA[<p>本文主要针对MySQL的InnoDB数据库，本文的目标:</p>
<ul>
<li>对数据进行备份</li>
<li>将数据恢复到某一个时间点</li>
</ul>
<a id="more"></a>

<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>规划备份和恢复策略时, 可以根据一些需求来考虑:</p>
<ul>
<li>恢复点目标(RPO), 指恢复到哪个时间点, 可以容许丢失多少数据</li>
<li>恢复时间目标(RTO), 指恢复可以容许的恢复时间长度</li>
<li>备份到目的地的时间, 比如本地, NFS等</li>
</ul>
<p>备份的内容：</p>
<ul>
<li>MySQL配置</li>
<li>schema和数据</li>
<li>二进制日志</li>
</ul>
<p>Innodb是一个ACID系统， 任何时刻， 每个提交的事务<br>要么在<strong>Innodb数据文件</strong>中， 要么在<strong>二进制日志文件</strong>中。<br>所以为了保证一致性， 即属于同一个时间点， 备份Innodb时需要对数据和二进制日志都进行备份。</p>
<p>关闭MySQL备份是最简单安全的, 也是获取一致性的最好的方法, 并且损坏的风险最小.<br>但对于在线系统来说, 停机备份的代价太大.</p>
<p>如果使用了全局读锁<code>FLUSH TABLE WITH READ LOCK</code>, 并且备份的事务执行需要很长的时间,<br>则全局读锁需要等待备份的事务完成提交后才释放, 在这期间的所有操作很可能会被阻塞和积压,<br>即当发生一些修改操作需要等待表的写锁时, 之后的所有读写操作都会被阻塞.<br>而**<em>避免全局读锁的最好方法就是只使用InnoDB, 如果使用少量的MyISAM表, 则只需要锁住它们即可**</em>，<br>因为InnoDB支持事务， 能报保证在一个事务中的的数据的一致性。</p>
<p>建议混合使用物理和逻辑两种方式进行备份:<br>先使用物理复制, 然后启动一个测试的MySQL实例并运行mysqlcheck来检查;<br>然后周期性的使用mysqldump来执行逻辑备份.</p>
<h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><h3 id="逻辑备份"><a href="#逻辑备份" class="headerlink" title="逻辑备份"></a>逻辑备份</h3><p>逻辑备份只用于数据备份, 通过<strong>MySQL服务器</strong>将存储引擎中的数据导出, 与存储引擎无关,<br>并且可以对备份的数据进行裁剪.</p>
<p>缺点： 需要通过MySQL加载, 转为存储格式, 并且需要重建索引, 过程很慢,<br>尤其在加载一个巨大的导出文件的代价很大</p>
<p>需要尽量控制导出的数据文件大小，在保证一致性的前提下，<br>按照业务逻辑导出到多个文件中，以控制导出到粒度。</p>
<p>导出方式:</p>
<ul>
<li>导出sql格式的schema和数据</li>
<li>导出sql格式的schema和csv格式的数据,<br>必须保证<code>secure_file_priv</code>变量不为NULL, 以及相应的路径必须存在.<br>需要在MySQL启动前在my.conf中配置</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 将schema导出</span></span><br><span class="line">$ mysqldump <span class="comment">--single-transaction -d --databases &lt;database_name&gt; &gt; schema.sql</span></span><br><span class="line"><span class="comment">-- 将相关连的表的数据导到sql文件中</span></span><br><span class="line">$ mysqldump <span class="comment">--single-transaction -t --databases &lt;database_name&gt; &gt; data.sql</span></span><br><span class="line"><span class="comment">-- 每张表都会导出一个sql格式的表结构文件, csv格式的数据导文件</span></span><br><span class="line">$ mysqldump <span class="comment">--single-transaction --tab=&lt;backup_dirname&gt; &lt;database_name&gt; [table1, ...]</span></span><br></pre></td></tr></table></figure>

<h3 id="物理备份"><a href="#物理备份" class="headerlink" title="物理备份"></a>物理备份</h3><p>优点:</p>
<ul>
<li>物理备份的方式更加简单高效</li>
<li>恢复往往要比逻辑备份要快, 省去了加载和重建过程</li>
</ul>
<p>缺点:</p>
<ul>
<li>往往备份的大小要比逻辑备份大得多</li>
</ul>
<p>物理备份方式:</p>
<ul>
<li>基于文件拷贝的备份, 适用于关机下备份， 配置文件备份， 日志备份等</li>
<li>通过快照进行备份, </li>
</ul>
<h4 id="快照备份"><a href="#快照备份" class="headerlink" title="快照备份"></a>快照备份</h4><p>物理数据存放在<code>/var/lib/mysql</code>目录下， 每个数据库存储在相同名字的目录下，<br>同时也包含服务器配置和二进制日志文件。</p>
<p>快照备份是非常好的在线备份方法, 并且可以减少持有锁的时间。<br>又分为：</p>
<ul>
<li>最小化锁快照备份, 只锁MyISAM表，InnoDB不需要锁    </li>
<li>无锁快照备份, 如果MyISAM不会发生修改, 就可以不锁表</li>
</ul>
<p>快照备份后， 通过挂在快照， 拷贝数据文件到备份的地方。</p>
<p>但使用快照备份需要额外的磁盘空间， 用于快照需要的写时复制空间。<br>并且要求将MySQL的数据相关文件（<code>/var/lib/mysql/</code>）部署在同一个专有卷上。<br>而且会导致原始卷和快照比正常读写性能要差， 尤其在过多使用写时复制空间时。</p>
<p>对数据进行物理快照备份后, 需要构建一个MySQL实例并加载物理备份,<br>然后使用mysqlcheck可以对所有的表执行<code>CHECK TABLES</code>操作,<br>检查物理备份的正确性.</p>
<h4 id="MySQL配置备份"><a href="#MySQL配置备份" class="headerlink" title="MySQL配置备份"></a>MySQL配置备份</h4><ul>
<li>/etc/mysql/my.cnf, 默认配置文件</li>
<li>/etc/mysql/conf.d, 自定义配置目录, 会覆盖默认配置中的设置.</li>
</ul>
<h4 id="二进制日志备份"><a href="#二进制日志备份" class="headerlink" title="二进制日志备份"></a>二进制日志备份</h4><p>二进制日志默认存储在<code>/var/lib/mysql/</code>目录下, 格式为<code>binlog.*</code>,<br>可通过命令<code>mysqlbinlog -d &lt;database_name&gt; &lt;binlog&gt;</code>来查看指定数据库的二进制日志</p>
<p>常用命令：</p>
<ul>
<li>查看二进制日志， <code>show binary logs;</code></li>
<li>创建新的二进制日志文件, <code>flush logs;</code></li>
<li>清理指定二进制日志文件之前的日志文件, <code>purge binary logs to &#39;binlog.000005&#39;;</code></li>
</ul>
<p>在备份数据之前， 建议<code>flush logs</code>生成新的日志，<br>可保证备份期间的操作被清楚的记录在最新的日志文件里。</p>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>一般情况下备份策略采用<code>长周期的逻辑全备份（保底恢复，但加载慢） + 短周期的快照物理备份（快速恢复） + 二进制日志文件定时备份（恢复到某个时间点）</code>。<br>如果数据量不大， 则只需要<code>逻辑全备份 + 二进制日志文件备份</code>就可以。</p>
<p>逻辑全备份流程：</p>
<ol>
<li>在进行全备份之前， 创建新二进制日志， 保证在备份期间的操作会被记录到新二进制日志中</li>
<li>进行全备份</li>
<li>清理老的二进制日志， 只保留最新二进制日志</li>
<li>在下一次全备份之前， 定时备份二进制日志</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysql -e <span class="string">&quot;flush logs;&quot;</span></span><br><span class="line">$ mysql -e <span class="string">&quot;show binary logs;&quot;</span></span><br><span class="line">$ mkdir &lt;backup_dir_path&gt;</span><br><span class="line">$ mysqldump --single-transaction -d &lt;database_name&gt;</span><br><span class="line">$ mysqldump --single-transaction --tab=&lt;backup_dir_path&gt; &lt;database_name&gt;</span><br><span class="line">$ mysql -e <span class="string">&quot;purge binary logs to ‘&lt;最新的二进制日志&gt;&#x27;&quot;</span></span><br></pre></td></tr></table></figure>
<hr>
<p>二进制日志文件备份流程：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysql -e <span class="string">&quot;flush logs;&quot;</span></span><br><span class="line">$ cp binlog.* &lt;backup_dir_path&gt;</span><br><span class="line">$ mysql -e <span class="string">&quot;purge binary logs to ‘&lt;最新的二进制日志&gt;&#x27;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h2><p>在恢复过程中， 要保证MySQL除了恢复进程外不接受其他访问， 直到恢复并检测完毕， 重新提供服务为止。</p>
<h3 id="基于时间点的逻辑备份的恢复"><a href="#基于时间点的逻辑备份的恢复" class="headerlink" title="基于时间点的逻辑备份的恢复"></a>基于时间点的逻辑备份的恢复</h3><p>基于时间点的恢复要求建立日常备份, 并保证所需要的二进制日志有效.<br>这样才能基于某一次全备份, 然后从那个时间点开始重放二进制日志,<br>将数据来恢复到指定时间.</p>
<p>基于逻辑备份恢复和二进制重放都是一个很慢的过程, 在开始恢复之前， 建议通过<code>set sql_log_bin=0;</code>关闭二进制日志。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 禁用二进制日志</span></span><br><span class="line">$ mysql -e <span class="string">&quot;set sql_log_bin=0;&quot;</span></span><br><span class="line"><span class="comment"># 创建schema</span></span><br><span class="line">$ mysql &lt; schema.sql</span><br><span class="line"><span class="comment"># 导入数据, mysqlimporter是对load data infile命令的封装</span></span><br><span class="line">$ mysqlimportor &lt;database_name&gt; &lt;csv数据文件路径&gt;</span><br><span class="line"><span class="comment"># 重放从那个时间点之后的二进制日志</span></span><br><span class="line">$ mysqlbinlog --database=&lt;database_name&gt; &lt;binlog二进制文件路径&gt; | mysql</span><br><span class="line"><span class="comment"># 打开二进制日志</span></span><br><span class="line">$ mysql -e <span class="string">&quot;set sql_log_bin=1;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li>高性能MySQL — 第15章备份与恢复</li>
</ul>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>备份</tag>
        <tag>恢复</tag>
      </tags>
  </entry>
  <entry>
    <title>传统的CI/CD流程概述</title>
    <url>/2018/11/CI-CD/traditional-workflow/</url>
    <content><![CDATA[<ul>
<li>了解传统CI/CD流程中的各个环节</li>
</ul>
<a id="more"></a>

<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="752px" preserveAspectRatio="none" style="width:1672px;height:752px;background:#FFFFFF;" version="1.1" viewBox="0 0 1672 752" width="1672px" zoomAndPan="magnify"><defs/><g><rect height="26.2969" style="stroke:#00000000;stroke-width:1.0;fill:none;" width="223" x="720.5" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="213" x="725.5" y="27.9951">traditional CI/CD workflow</text><rect height="46.2656" style="stroke:#000000;stroke-width:1.5;fill:none;" width="753.5" x="901.5" y="608.3203"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="22" x2="22" y1="118.5938" y2="671.5859"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="151" x2="151" y1="118.5938" y2="671.5859"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="321" x2="321" y1="118.5938" y2="671.5859"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="621.5" x2="621.5" y1="118.5938" y2="671.5859"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1003.5" x2="1003.5" y1="118.5938" y2="671.5859"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1417" x2="1417" y1="118.5938" y2="671.5859"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1578" x2="1578" y1="118.5938" y2="671.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="28" x="5" y="115.292">Dev</text><ellipse cx="22" cy="50.7969" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M22,58.7969 L22,85.7969 M9,66.7969 L35,66.7969 M22,85.7969 L9,100.7969 M22,85.7969 L35,100.7969 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="28" x="5" y="683.5811">Dev</text><ellipse cx="22" cy="695.3828" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M22,703.3828 L22,730.3828 M9,711.3828 L35,711.3828 M22,730.3828 L9,745.3828 M22,730.3828 L35,745.3828 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="146" x="78" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="132" x="85" y="107.292">Source Repository</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="146" x="78" y="670.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="132" x="85" y="690.5811">Source Repository</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="175" x="234" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="161" x="241" y="107.292">Continious Integration</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="175" x="234" y="670.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="161" x="241" y="690.5811">Continious Integration</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="547.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="554.5" y="107.292">Deploy Repository</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="547.5" y="670.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="554.5" y="690.5811">Deploy Repository</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="184" x="911.5" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="170" x="918.5" y="107.292">Continious Deployment</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="184" x="911.5" y="670.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="170" x="918.5" y="690.5811">Continious Deployment</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="169" x="1333" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="155" x="1340" y="107.292">Release Test Machine</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="169" x="1333" y="670.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="155" x="1340" y="690.5811">Release Test Machine</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="133" x="1512" y="87.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="119" x="1519" y="107.292">Release Machine</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="133" x="1512" y="670.5859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="119" x="1519" y="690.5811">Release Machine</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1665" x="0" y="149.1602"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1665" y1="149.1602" y2="149.1602"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1665" y1="152.1602" y2="152.1602"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="114" x="775.5" y="138.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="100" x="781.5" y="154.6606">Development</text><polygon fill="#181818" points="139,188.8594,149,192.8594,139,196.8594,143,192.8594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="22" x2="145" y1="192.8594" y2="192.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="29" y="187.7935">Commit sources</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1665" x="0" y="221.4258"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1665" y1="221.4258" y2="221.4258"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1665" y1="224.4258" y2="224.4258"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="213" x="726" y="210.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="199" x="732" y="226.9263">CI: test &amp; Build &amp; Package</text><polygon fill="#181818" points="162,261.125,152,265.125,162,269.125,158,265.125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="156" x2="320.5" y1="265.125" y2="265.125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="168" y="260.0591">pull sources</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="321.5" x2="363.5" y1="294.2578" y2="294.2578"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="363.5" x2="363.5" y1="294.2578" y2="307.2578"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="322.5" x2="363.5" y1="307.2578" y2="307.2578"/><polygon fill="#181818" points="332.5,303.2578,322.5,307.2578,332.5,311.2578,328.5,307.2578" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="286" x="328.5" y="289.1919">run test for sources to make sure it's correct</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="321.5" x2="363.5" y1="336.3906" y2="336.3906"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="363.5" x2="363.5" y1="336.3906" y2="349.3906"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="322.5" x2="363.5" y1="349.3906" y2="349.3906"/><polygon fill="#181818" points="332.5,345.3906,322.5,349.3906,332.5,353.3906,328.5,349.3906" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="328.5" y="331.3247">update build config for specific environment</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="321.5" x2="363.5" y1="378.5234" y2="378.5234"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="363.5" x2="363.5" y1="378.5234" y2="391.5234"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="322.5" x2="363.5" y1="391.5234" y2="391.5234"/><polygon fill="#181818" points="332.5,387.5234,322.5,391.5234,332.5,395.5234,328.5,391.5234" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="328.5" y="373.4575">make deployable package</text><polygon fill="#181818" points="609.5,416.6563,619.5,420.6563,609.5,424.6563,613.5,420.6563" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="321.5" x2="615.5" y1="420.6563" y2="420.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="328.5" y="415.5903">Upload to deploy repo</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1665" x="0" y="449.2227"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1665" y1="449.2227" y2="449.2227"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1665" y1="452.2227" y2="452.2227"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="145" x="760" y="438.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="131" x="766" y="454.7231">CD: Deploy &amp; Run</text><polygon fill="#181818" points="632.5,488.9219,622.5,492.9219,632.5,496.9219,628.5,492.9219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="626.5" x2="1002.5" y1="492.9219" y2="492.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="358" x="638.5" y="487.856">pull package for specific environment in specific version</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1003.5" x2="1045.5" y1="522.0547" y2="522.0547"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1045.5" x2="1045.5" y1="522.0547" y2="535.0547"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1004.5" x2="1045.5" y1="535.0547" y2="535.0547"/><polygon fill="#181818" points="1014.5,531.0547,1004.5,535.0547,1014.5,539.0547,1010.5,535.0547" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="316" x="1010.5" y="516.9888">update external infrastructure config for package</text><polygon fill="#181818" points="1405.5,560.1875,1415.5,564.1875,1405.5,568.1875,1409.5,564.1875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1003.5" x2="1411.5" y1="564.1875" y2="564.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244" x="1010.5" y="559.1216">run package with infrastructure config</text><polygon fill="#181818" points="1405.5,589.3203,1415.5,593.3203,1405.5,597.3203,1409.5,593.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1003.5" x2="1411.5" y1="593.3203" y2="593.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="390" x="1010.5" y="588.2544">run test for running package, make sure features are correct</text><path d="M901.5,608.3203 L967.5,608.3203 L967.5,615.4531 L957.5,625.4531 L901.5,625.4531 L901.5,608.3203 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="46.2656" style="stroke:#000000;stroke-width:1.5;" width="753.5" x="901.5" y="608.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="21" x="916.5" y="621.3872">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="73" x="982.5" y="620.5308">[no errors]</text><polygon fill="#181818" points="1566.5,642.5859,1576.5,646.5859,1566.5,650.5859,1570.5,646.5859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1003.5" x2="1572.5" y1="646.5859" y2="646.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244" x="1010.5" y="641.52">run package with infrastructure config</text><!--MD5=[497113daf594bd3b58e39e3561c9ed2b]
@startuml
title traditional CI/CD workflow
actor Dev
participant "Source Repository" as SrcRepo
participant "Continious Integration" as CI
participant "Deploy Repository" as DeployRepo
participant "Continious Deployment" as CD
participant "Release Test Machine" as RTM
participant "Release Machine" as RM

==Development==
Dev - -> SrcRepo: Commit sources

==CI: test & Build & Package==
CI - -> SrcRepo: pull sources
CI - -> CI: run test for sources to make sure it's correct
CI - -> CI: update build config for specific environment
CI - -> CI: make deployable package
CI - -> DeployRepo: Upload to deploy repo

==CD: Deploy & Run==
CD - -> DeployRepo: pull package for specific environment in specific version
CD - -> CD: update external infrastructure config for package
CD - -> RTM: run package with infrastructure config
CD - -> RTM: run test for running package, make sure features are correct
alt no errors
CD - -> RM: run package with infrastructure config
end
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<h2 id="CI"><a href="#CI" class="headerlink" title="CI"></a>CI</h2><p>CI的目的在于保证生成<strong>可用的</strong>包, 即能够满足以下的要求:</p>
<ul>
<li>能够<strong>正确</strong>的生成包, 即没有任何编译错误</li>
<li>包针对具体的环境具有<strong>通用性</strong>, 即针对具体环境,<br>不需要对功能配置进行更新的情况下任意部署</li>
<li>提供当前<strong>版本要求的所有功能</strong></li>
<li>通过<strong>测试</strong>验证</li>
</ul>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>CI阶段的测试针对的是<strong>包</strong>的<strong>自动化测试</strong>, 一般包含:</p>
<ul>
<li>Unit Test</li>
<li>Integration Test</li>
</ul>
<p>CI阶段的测试用来验证该版本的修改是否对原有功能造成影响, 甚至产生错误.</p>
<h3 id="功能配置的更新"><a href="#功能配置的更新" class="headerlink" title="功能配置的更新"></a>功能配置的更新</h3><p>CI阶段的配置更新用于保证提供版本要求的所有功能, 主要涉及以下几个方面:</p>
<ul>
<li>包的版本设置</li>
<li>相关功能的开启和关闭</li>
<li>相同版本不同环境的功能策略的配置</li>
</ul>
<p>该阶段的配置涉及的都是和包的功能切身相关的配置, 不包括外部服务以及基础设施的配置.</p>
<p>如果工程本身支持多环境的配置, 则可在那里进行分别配置,<br>在CI阶段只要指定相应的环境, 然后进行打包即可.</p>
<h2 id="CD"><a href="#CD" class="headerlink" title="CD"></a>CD</h2><p>CD阶段的目标是将包部署到相应的机器上, 并正确运行起来.</p>
<h2 id="基础设施配置的更新"><a href="#基础设施配置的更新" class="headerlink" title="基础设施配置的更新"></a>基础设施配置的更新</h2><p>CD阶段的配置更新涉及以下的几个方面:</p>
<ul>
<li>服务所依赖的基础设施的配置<ul>
<li>LoadBalance(nginx, …)</li>
<li>Database(MySQL, …)</li>
<li>Cache(redis, …)</li>
</ul>
</li>
<li>依赖服务的相关配置</li>
<li>外部服务的相关配置</li>
</ul>
<p>这块的配置往往取决于整体的架构设计.</p>
<p>由于部署环境的多变性, 所以这部分配置必须可以在部署阶段, 根据具体的环境进行配置.</p>
<p>往往同一个<strong>可用区</strong>的基础设施的配置是相同的.</p>
<h2 id="可扩展的自定义配置"><a href="#可扩展的自定义配置" class="headerlink" title="可扩展的自定义配置"></a>可扩展的自定义配置</h2><p>在基础配置的基础之上, 根据具体的环境对配置进行自定义.</p>
<p><strong>TODO</strong></p>
<h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><p>CD阶段的测试往往是<strong>端到端</strong>的<strong>自动化测试</strong>, 一般包含:</p>
<ul>
<li>功能测试</li>
<li>压力测试</li>
</ul>
<p>这部分的测试所针对的测试环境往往和正式环境一致</p>
<h2 id="关于项目的配置"><a href="#关于项目的配置" class="headerlink" title="关于项目的配置"></a>关于项目的配置</h2><ul>
<li>静态配置<ul>
<li>服务初始化时就要加载的功能配置, 往往加载后不会变化,<br>往往在项目中或CI阶段配置</li>
<li>CD阶段外部环境相关的配置, 在CD阶段进行配置</li>
</ul>
</li>
<li>动态配置<ul>
<li>运行时可进行切换的功能配置, 在存储(DB, Cache)中配置, 可在运行时更新</li>
</ul>
</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://book.douban.com/subject/10769596/">持续集成: 软件质量改进和风险降低之道</a></li>
</ul>
]]></content>
      <categories>
        <category>CI/CD</category>
      </categories>
      <tags>
        <tag>CI/CD</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL Schema与数据类型优化</title>
    <url>/2018/06/MySQL/schema-data-type/</url>
    <content><![CDATA[<ul>
<li>学习如何选择合适的数据类型</li>
<li>特殊数据的类型选择</li>
<li>Schema的设计</li>
</ul>
<a id="more"></a>

<h2 id="数据类型的选择"><a href="#数据类型的选择" class="headerlink" title="数据类型的选择"></a>数据类型的选择</h2><p>MySQL基础数据类型</p>
<ul>
<li>数字<ul>
<li>整数<ul>
<li>tinyint/smallint/mediumint/int/bigint</li>
<li>unsigned可选</li>
</ul>
</li>
<li>实数<ul>
<li>Float/Double, 浮点计算</li>
<li>DECIMAL, 存储精确的小数, 一般可使用bigint来代替decimal, 通过乘以相应的倍数即可</li>
</ul>
</li>
</ul>
</li>
<li>字符串<ul>
<li>char, 定长, 适合更新频繁的列或者长度固定的列</li>
<li>varchar, 变长, 需要额外的1或2个字节来存储长度, 小于等于255则1个字节, 大于则2个字节; 不适合更新频繁的列, 会导致碎片化</li>
<li>text, 很长的字符串</li>
</ul>
</li>
<li>二进制字符串, 比较时以<strong>字节</strong>为单位进行比较, 效率要比普通字符串要高<ul>
<li>binary, 定长</li>
<li>varbinary, 变长</li>
<li>blob, 很长的二进制字符串</li>
</ul>
</li>
<li>时间<ul>
<li>datetime, 从1001到9999年, 精度为秒, 把日期和时间封装到格式为<strong>YYYYMMDDHHMMSS</strong>的<strong>整数</strong>中, 显示<strong>与时区无关</strong>, <strong>使用8字节存储</strong></li>
<li>timestamp, 同unit时间戳, 从新纪元时间(1970-01-01T00:00:00)以来的秒数, <strong>使用4字节存储</strong>, 只能表示1970到2038年, 显示依赖于时区, 会根据时区不同, 显示对应的时间; 对应的列默认为NOT NULL.</li>
</ul>
</li>
</ul>
<h3 id="特殊数据类型的处理"><a href="#特殊数据类型的处理" class="headerlink" title="特殊数据类型的处理"></a>特殊数据类型的处理</h3><p><strong>uuid</strong>数据的处理:</p>
<ol>
<li>移除uuid中的**-**</li>
<li>使用unhex函数将uuid字符串转换为16字节的数字, 存储到binary(16)中</li>
<li>使用hex函数将16字节的数字转换为uuid字符串</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select uuid();</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| uuid()                               |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| e8dc60bb-6df3-11e8-8915-0800273063ab |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">1 row in set</span><br><span class="line"></span><br><span class="line">mysql&gt; select unhex(&#39;e8dc60bb6df311e889150800273063ab&#39;);</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| unhex(&#39;e8dc60bb6df311e889150800273063ab&#39;) |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| ��&#96;�m��</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">1 row in set</span><br><span class="line"></span><br><span class="line">mysql&gt; select hex(unhex(&#39;e8dc60bb6df311e889150800273063ab&#39;));</span><br><span class="line">+------------------------------------------------+</span><br><span class="line">| hex(unhex(&#39;e8dc60bb6df311e889150800273063ab&#39;)) |</span><br><span class="line">+------------------------------------------------+</span><br><span class="line">| E8DC60BB6DF311E889150800273063AB               |</span><br><span class="line">+------------------------------------------------+</span><br><span class="line">1 row in set</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p><strong>ip</strong>数据需要转换为数字存储:</p>
<ol>
<li>使用<strong>无符号整数</strong>存储ip列</li>
<li>使用inet_aton将ip字符串转换为整数</li>
<li>使用inet_ntoa将数字转换为ip字符串</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select inet_aton(&#39;192.168.0.1&#39;);</span><br><span class="line">+--------------------------+</span><br><span class="line">| inet_aton(&#39;192.168.0.1&#39;) |</span><br><span class="line">+--------------------------+</span><br><span class="line">|               3232235521 |</span><br><span class="line">+--------------------------+</span><br><span class="line">1 row in set</span><br><span class="line"></span><br><span class="line">mysql&gt; select inet_ntoa(3232235521);</span><br><span class="line">+-----------------------+</span><br><span class="line">| inet_ntoa(3232235521) |</span><br><span class="line">+-----------------------+</span><br><span class="line">| 192.168.0.1           |</span><br><span class="line">+-----------------------+</span><br><span class="line">1 row in set</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p><strong>id列</strong>的数据类型尽量选择<strong>递增型整数</strong></p>
<p>因为随机值会分布在很大的空间中, 导致insert和select变慢.<br>而且随机值的插入会随机写到索引的不同位置, 导致insert语句变慢;<br>由于数据分布在很大的空间中, 也就导致了select指定的数据会变慢;<br>还会导致缓存失效.</p>
<p><strong>由于InnoDB的索引是一个B+Tree, 所以按顺序的插入能够保证数据很快插入,<br>并保证数据集中在一定的范围之内. 递增插入是比较好的选择.</strong></p>
<p>不建议使用字符串类型作为id列, 查询性能很差.</p>
<p>一般情况下尽量使用默认值方案来替换NULL, 因为NULL会增加查询的复杂度.</p>
<h2 id="Schema的设计"><a href="#Schema的设计" class="headerlink" title="Schema的设计"></a>Schema的设计</h2><h3 id="范式与反范式"><a href="#范式与反范式" class="headerlink" title="范式与反范式"></a>范式与反范式</h3><p>范式的主要目的:</p>
<ul>
<li>减少数据冗余</li>
<li>消除插入/删除/更新的异常</li>
</ul>
<p>关键概念:</p>
<ul>
<li>码/键(候选码), 表中的一个或多个属性组K, 除开K中的属性外的其他所有属性都完全函数依赖于K, 则K为候选码; 一个表可能存在多个码</li>
<li>主属性, 包含在各个候选码中的属性, 主属性不可为空</li>
</ul>
<p>通常使用的范式:</p>
<ul>
<li>1NF(Normal Form)第一范式, 属性的原子性保证不可再分割, 每个属性都只能存储一个值</li>
<li>2NF第二范式, 基于1NF, 定义候选码, 非主属性必须<strong>完全依赖</strong>于候选码, 即通过候选码可以确定实体的唯一性</li>
<li>3NF第三范式, 基于2NF, 消除<strong>传递依赖</strong>, 即任何非主属性不能由其他属性派生, 要求<strong>属性没有冗余</strong></li>
<li>BCNF, 基于3NF的改进范式, 消除<strong>主属性对码的部分与传递依赖</strong></li>
</ul>
<p>一般情况下, 关系型数据库的表设计只要达到<strong>3NF/BCNF</strong>就够了.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; 不符合1NF, 电话列可继续拆分</span><br><span class="line">学生|课程|老师|电话(手机, 座机)|教材|教室|上课时间 </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 符合1NF, 候选码为(学生, 课程), 但不符合2NF, 教材只部分依赖于主键列中的课程</span><br><span class="line">学生|课程|老师|手机|座机|教材|教室|上课时间 </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 符合2NF, 但不符合3NF, (学生, 课程) &#x3D;&gt; 老师 &#x3D;&gt; 手机|座机, 存在传递依赖</span><br><span class="line">学生|课程|老师|手机|座机|教室|上课时间</span><br><span class="line"></span><br><span class="line">课程|教材</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 符合3NF</span><br><span class="line">学生|课程|老师|教室|上课时间</span><br><span class="line"></span><br><span class="line">课程|教材</span><br><span class="line"></span><br><span class="line">老师|手机|座机</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面例子中的关系图:</p>
<p><img src="/2018/06/MySQL/schema-data-type/example.jpg"></p>
<p>针对<strong>写密集</strong>的场景尤其需要对schema进行范式化, 而针对读密集的场景可以使用反范式.</p>
<p>范式化的表能够更好更快的进行更新操作, 但是查询往往需要多表join;<br>然而单独的表能够更有效的利用索引.</p>
<h3 id="缓存表-amp-amp-汇总表"><a href="#缓存表-amp-amp-汇总表" class="headerlink" title="缓存表 &amp;&amp; 汇总表"></a>缓存表 &amp;&amp; 汇总表</h3><p>通过缓存表和汇总表来缓存源数据经过逻辑计算后的冗余数据, 可以提升相应业务逻辑场景的查询性能.</p>
<ul>
<li>非实时性数据, <strong>定时</strong>计算更新的不严格计数</li>
<li>实时性数据, 通过<strong>小范围查询填满间隙</strong>的严格计数</li>
</ul>
<p>在使用缓存表和汇总表时, 对数据的维护有两种方式:</p>
<ul>
<li>实时维护, 成本较高, 数据容易碎片化</li>
<li>定期重建, 可以保持表不会有很多碎片, 而且能保证顺序组织索引, 更加高效</li>
</ul>
<p>重建表可以通过<strong>影子表</strong>的技巧</p>
<ol>
<li>创建相同结构的新表, <code>create table test_table_new like test_table</code></li>
<li>填充数据, 数据有可能时老数据, 也可能时重新整理后的数据</li>
<li>通过重命名来交换新表和旧表的名字, <code>rename table test_table to test_table_old, test_table_new to test_table</code></li>
<li>如果出问题了, 可以很容易回滚旧表</li>
</ol>
<h3 id="计数表"><a href="#计数表" class="headerlink" title="计数表"></a>计数表</h3><p>为了提升技术表的并发处理能力, 在更新时随机到相应的slot行插入, 查询时汇总结果.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 多slot的计数表</span><br><span class="line"></span><br><span class="line">create table if not exists counter_tb (</span><br><span class="line">slot tinyint unsigned not null primary key, </span><br><span class="line">cnt int unsigned not null</span><br><span class="line">) engine&#x3D;InnoDB default charset&#x3D;utf8mb4;</span><br><span class="line"></span><br><span class="line">-- 更新时随机slot更新</span><br><span class="line">insert into counter_tb (slot, cnt)</span><br><span class="line">values (rand() * 10, 1)</span><br><span class="line">on duplicate key update cnt &#x3D; cnt + 1;</span><br><span class="line"></span><br><span class="line">-- 查询时汇总</span><br><span class="line"></span><br><span class="line">select * from counter_tb;</span><br><span class="line"></span><br><span class="line">select sum(cnt)</span><br><span class="line">from counter_tb;</span><br></pre></td></tr></table></figure>
<h3 id="schema的修改"><a href="#schema的修改" class="headerlink" title="schema的修改"></a>schema的修改</h3><p>MySQL中大部分执行alter table来修改表结构的操作都会导致重建表, 即用新的结构创建新表, 将旧表数据导入新表, 最后删除旧表.<br>这对大表来说需要花费很大的时间和代价.</p>
<p>大部分的alter table操作都会导致MySQL服务中断.<br>对于在生产环境中修改表结构, 一般可采用以下方法:</p>
<ul>
<li>在备用数据库上修改结构后, 和主库进行切换</li>
<li>影子拷贝, 操作同创建影子表的操作; 也可借助一些第三方工具来进行影子拷贝</li>
</ul>
<p>.frm文件存储着表的结构, 它存放在mysql的data目录下对应的schema目录里, 默认的data目录为/var/lib/mysql.<br>以下情况可通过修改**.frm文件**的结构来更新表结构, 但对.frm文件的修改存在风险, 需要做好备份:</p>
<ul>
<li>列的默认值</li>
<li>NULL/NOT Null</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://github.com/xiayy860612/example/tree/master/mysql_demo/schema">Demo</a></li>
<li><a href="https://book.douban.com/subject/23008813/">高性能MySQL</a>, 第4章 Schema与数据类型优化</li>
<li><a href="https://www.zhihu.com/question/24696366">解释一下关系数据库的第一第二第三范式</a></li>
<li><a href="https://www.cnblogs.com/ybwang/archive/2010/06/04/1751279.html">数据库设计三大范式与BCNF，学习笔记</a></li>
</ul>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ 开发实践</title>
    <url>/2021/12/rabbitmq/best-practice/</url>
    <content><![CDATA[<p>快速熟悉RabbitMQ的元素, 以及开发相关的最佳实践总结.</p>
<p><a href="https://github.com/xiayy860612/study/tree/release/rabbitmq/mq/rabbitmq/rabbitmq-practice">Demo</a></p>
<a id="more"></a>

<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="490px" preserveAspectRatio="none" style="width:156px;height:490px;background:#FFFFFF;" version="1.1" viewBox="0 0 156 490" width="156px" zoomAndPan="magnify"><defs/><g><!--MD5=[56e484d7730c16735b991f559d809855]
cluster Broker--><g id="cluster_Broker"><rect height="202" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:1.0;fill:none;" width="135" x="7" y="144.5"/><path d="M70,144.5 L70,153.7969 L60,163.7969 L7,163.7969 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="53" x="10" y="158.4951">Broker</text></g><!--MD5=[fd29c16a61755d2f0d64abb16841689f]
entity Exchange--><g id="elem_Exchange"><ellipse cx="58" cy="195.5" fill="#F1F1F1" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#181818" points="54,183.5,60,178.5,58,183.5,60,188.5,54,183.5" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69" x="23.5" y="224.4951">Exchange</text></g><!--MD5=[9762e67b79b719797c568dcdd43c32f7]
entity Queue--><g id="elem_Queue"><path d="M30.5,304.5 L85.5,304.5 C90.5,304.5 90.5,317.6484 90.5,317.6484 C90.5,317.6484 90.5,330.7969 85.5,330.7969 L30.5,330.7969 C25.5,330.7969 25.5,317.6484 25.5,317.6484 C25.5,317.6484 25.5,304.5 30.5,304.5 " fill="#F1F1F1" style="stroke:#181818;stroke-width:0.5;"/><path d="M85.5,304.5 C80.5,304.5 80.5,317.6484 80.5,317.6484 C80.5,330.7969 85.5,330.7969 85.5,330.7969 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="30.5" y="322.4951">Queue</text></g><!--MD5=[b9060e1352b009711fbb9730f967b58f]
entity Publisher--><g id="elem_Publisher"><ellipse cx="58" cy="14" fill="#F1F1F1" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M58,22 L58,49 M45,30 L71,30 M58,49 L45,64 M58,49 L71,64 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="25" y="78.4951">Publisher</text></g><!--MD5=[4d65782647d64e21a92b473b2db819be]
entity Consumer--><g id="elem_Consumer"><ellipse cx="58" cy="418" fill="#F1F1F1" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M58,426 L58,453 M45,434 L71,434 M58,453 L45,468 M58,453 L71,468 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72" x="22" y="482.4951">Consumer</text></g><!--MD5=[ec0bc6194014de8722040e3d7398696c]
link Publisher to Exchange--><g id="link_Publisher_Exchange"><path d="M58,81.544 C58,109.933 58,148.506 58,174.39 " fill="none" id="Publisher-to-Exchange" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="58,179.391,62,170.391,58,174.391,54,170.391,58,179.391" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="63" x="59" y="124.5669">send msg</text></g><!--MD5=[925a1ff948043f059fc1cc49ee959e06]
link Exchange to Queue--><g id="link_Exchange_Queue"><path d="M58,227.706 C58,249.025 58,280.133 58,299.305 " fill="none" id="Exchange-to-Queue" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="58,304.378,62,295.378,58,299.378,54,295.378,58,304.378" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="59" y="270.5669">route msg</text></g><!--MD5=[28a3b4ef112e063d12b360875d46ff94]
link Queue to Consumer--><g id="link_Queue_Consumer"><path d="M58,336.232 C58,353.75 58,381.202 58,404.3323 " fill="none" id="Queue-Consumer" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="58,409.4999,62,400.4999,58,404.4999,54,400.4999,58,409.4999" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="58,330.773,54,339.773,58,335.773,62,339.773,58,330.773" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="59" y="375.5669">push/pull msg</text></g><!--MD5=[4b285eb93048fd86d6244a71f51e1ef7]
@startuml
actor Publisher
actor Consumer
frame Broker {
    control Exchange
    queue Queue
}

Publisher - -> Exchange: send msg
Exchange - -> Queue: route msg
Queue <- -> Consumer: push/pull msg
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<h2 id="声明Exchange和Queue"><a href="#声明Exchange和Queue" class="headerlink" title="声明Exchange和Queue"></a>声明Exchange和Queue</h2><p>Exchange负责对消息的路由, 而Queue负责对消息的存储.</p>
<h3 id="Exchange"><a href="#Exchange" class="headerlink" title="Exchange"></a>Exchange</h3><p>Exchange主要有以下几种路由方式:</p>
<ul>
<li>fanout, 分发到<strong>所有绑定</strong>的Queue中</li>
<li>direct, 只分发到<strong>路由键完全匹配</strong>的Queue中</li>
<li>topic, 分发到和<strong>路由键匹配</strong>的Queue中</li>
</ul>
<p>Exchange的常用属性:</p>
<ul>
<li>durable, 对于长期使用的交换器设置为true, 保证服务重启后仍然存在.</li>
<li>auto delete, 对于长期使用的交换器设置为false</li>
<li>internal, 用于Broker内部的路由, 对于同客户端连接的交换器设置为false, AE可设置为true.</li>
</ul>
<h3 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h3><p>交换器的使用并不真正消耗服务器的性能,<br>但队列会, 所以需要更加关注队列的设计,<br>需要对队列的流量, 内存占用以及网卡占用要有一个清晰的评估,<br>预估其平均值和峰值, 以便合理分配硬件资源.</p>
<p>Queue的主要属性:</p>
<ul>
<li>durable, 设置为true, 则服务重启后队列信息仍然存在;<br>配合消息的持久化, 可以保证服务重启后消息不丢失.</li>
<li>exclusive, true则仅对声明它的连接可见, 断开时自动删除;<br>一般情况下设置为false</li>
<li>auto delete, 一般设置为false</li>
<li>队列中消息的TTL, 通过x-message-ttl来设置,<br>最终消息的TTL=min(队列中消息的TTL, 消息设置的TTL),<br>消息过期后则变为死信(Dead Message)</li>
</ul>
<p>当一个队列有多个消费者时, 队列中的消息会被平均分摊(Round-Robin, 即轮询)<br>给多个消费者进行处理, 而不是每个消费者都收到所有的消息并处理.</p>
<p>通过路由键(Route Key)将Exchange和Queue进行绑定.</p>
<p>Queue的应用:</p>
<ul>
<li>死信队列, 需要配合死信交换器(DLX), 当消息过期后会被路由到死信队列</li>
<li>延迟队列, 通过<strong>死信队列+消息的TTL</strong>来实现</li>
<li>优先级队列</li>
<li>RPC队列</li>
</ul>
<h3 id="备用交换器-AE-Alternate-Exchange"><a href="#备用交换器-AE-Alternate-Exchange" class="headerlink" title="备用交换器(AE, Alternate Exchange)"></a>备用交换器(AE, Alternate Exchange)</h3><p>为了防止消息丢失, 一般建议配置AE,<br>当交换器无法路由消息到指定的队列时, 会将消息路由到AE,<br>由AE保存到与它绑定的队列中,<br>之后在修复后, 通过工具将这些丢失的消息重新入队.</p>
<h3 id="基本模板"><a href="#基本模板" class="headerlink" title="基本模板"></a>基本模板</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AE声明</span></span><br><span class="line">channel.exchangeDeclare(RabbitMQConfig.AE, BuiltinExchangeType.FANOUT,</span><br><span class="line">    <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">channel.queueDeclare(RabbitMQConfig.AE_QUEUE,</span><br><span class="line">    <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">channel.queueBind(RabbitMQConfig.AE_QUEUE, RabbitMQConfig.AE, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Exchange和Queue声明</span></span><br><span class="line">Map&lt;String, Object&gt; args = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">args.put(<span class="string">&quot;alternate-exchange&quot;</span>, RabbitMQConfig.AE);</span><br><span class="line">channel.exchangeDeclare(RabbitMQConfig.EX, BuiltinExchangeType.DIRECT,</span><br><span class="line">    <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, args);</span><br><span class="line">channel.queueDeclare(RabbitMQConfig.EX_QUEUE,</span><br><span class="line">    <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">channel.queueBind(RabbitMQConfig.EX_QUEUE, RabbitMQConfig.EX, </span><br><span class="line">    RabbitMQConfig.EX_QUEUE_ROUTE_KEY);</span><br></pre></td></tr></table></figure>
<h3 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h3><p>生产者创建的消息分为两部分:</p>
<ul>
<li>消息标签, 包含路由相关的信息</li>
<li>消息体, 消息的内容, 可以被Queue保存</li>
</ul>
<p>消息的常用属性:</p>
<ul>
<li>durable, 通过设置deliverMode为2, 可实现消息的持久化;<br>对于可靠性/重要性不是那么高的消息不采用持久化处理, 以提高系统的吞吐量</li>
<li>消息的TTL, 通过设置expiration参数</li>
</ul>
<h3 id="Connect-amp-amp-Channel"><a href="#Connect-amp-amp-Channel" class="headerlink" title="Connect &amp;&amp; Channel"></a>Connect &amp;&amp; Channel</h3><p>客户端需要和RabbitMQ建立TCP Connection, 建立后会创建AMQP信道(Channel),<br>并被指派一个唯一的ID.<br>Channel是建立在Connection上的虚拟连接, 用于处理AMQP指令.</p>
<p>建立/销毁TCP连接是非常大的开销, 高峰时, 性能瓶颈也就随之出现.<br>所以RabbitMQ采用类似NIO的做法, 对TCP连接进行复用.</p>
<p>建议客户端采用连接池, 将Channel均摊到池中的Connection上;<br>每个线程持有一个Channel.</p>
<p>为了当发生阻塞时可以在阻止生产者的同时, 又不影响消费者的运行,<br>建议生产者和消费者的逻辑使用不同的Connection.</p>
<h2 id="实现Publisher"><a href="#实现Publisher" class="headerlink" title="实现Publisher"></a>实现Publisher</h2><p>为了避免发送方的消息丢失, RabbitMQ提供了以下几种机制:</p>
<ul>
<li>发送消息时设置mandatory, 当交换器无法找到复合条件的队列时, 通过Basic.Return将消息返回给生产者;<br>如果交换器存在AE, 则mandatory失效.</li>
<li>事务机制, txSelect/txCommit/txRollback, 每次只能处理一条消息,<br>在消息发送后会<strong>阻塞</strong>发送端, 等待RabbitMQ的回应,<br>回应提交成功, 则表明消息已经到达RabbitMQ;<br>如果发生任何异常, 发送端可以捕获异常并进行回滚;<br>它<strong>严重降低了RabbitMQ的消息吞吐量</strong>.</li>
<li>发送方确认机制, confirmSelect该模式下, 发布的消息都会被指派唯一ID,<br>消息到达匹配队列后, RabbitMQ会发送Basic.Ack并携带消息的唯一ID, 使发送方知道消息已经正确到达;<br>如果内部发生错误, 则会发送Basic.Nack告知发送方.</li>
</ul>
<p>推荐使用<strong>异步的发送方确认机制</strong>的方式来批量发送消息.</p>
<h2 id="实现Consumer"><a href="#实现Consumer" class="headerlink" title="实现Consumer"></a>实现Consumer</h2><p>消费端有两种消费模式:</p>
<ul>
<li>Push模式, RabbitMQ主动向订阅的消费者推送消息, 适用于吞吐量大的情况;<br>不同的订阅消费者采用唯一标签(consumerTag)来区分.</li>
<li>Pull模式, 消费者从RabbitMQ拉取消息, 适用于吞吐量少的情况</li>
</ul>
<p>为了保证消息从队列可靠的到达消费者, RabbitMQ提供了消息确认机制(Message Acknowledge).<br>通过设置auto ack为false, 让消费者有足够的时间处理消息,<br>处理完毕后再显式的发送Basic.Ack给RabbitMQ,<br>然后RabbitMQ才从内存/磁盘中移除消息(实际上是先打上删除标记, 之后再删除).<br>如果设置为true, 则RabbitMQ发送消息后就会将其从内存/磁盘中移除.</p>
<p>RabbitMQ队列中的消息分为两个部分:</p>
<ul>
<li>Ready, 等待投递给消费者的消息</li>
<li>Unacked, 已经投递给消费者, 但还没有收到确认信号的消息</li>
</ul>
<p>如果一直没有收到消费者的确认信号, 并且消费者断开了连接,<br>RabbitMQ则会安排该消息重新进入队列, 等待投递给下一个消费者,<br>确保消息被正确的消费.</p>
<p>RabbitMQ判断此消息是否重新投递给消费者的唯一依据是消费该消息的消费者连接是否断开,<br>因为RabbitMQ允许消费者消费一条消息的时间可以很久.</p>
<p>通过Basic.Qos来对消费者端的吞吐量进行控制,</p>
<ul>
<li>global为false模式时, 针对每个消费者进行限制</li>
<li>global为true模式时, 针对一个Channle中所有的消费者做限制</li>
</ul>
<p>如果同时设置了两种模式, 则同时生效,<br>即对信道中的每一个消费者做限制, 也对信道中的总数做限制.<br>一般需要根据节点的性能进行配置.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://book.douban.com/subject/27591386/">RabbitMQ实战指南</a></li>
<li><a href="https://www.rabbitmq.com/getstarted.html">RabbitMQ Tutorials</a></li>
</ul>
]]></content>
      <categories>
        <category>RabbitMQ</category>
      </categories>
      <tags>
        <tag>MQ</tag>
        <tag>RabbitMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring --- 请求处理流程</title>
    <url>/2018/05/spring/request-workflow/</url>
    <content><![CDATA[<ul>
<li>了解Spring请求的处理流程</li>
<li>了解其中的核心元素</li>
</ul>
<a id="more"></a>

<h2 id="核心设计"><a href="#核心设计" class="headerlink" title="核心设计"></a>核心设计</h2><ul>
<li>Filter</li>
<li>DispatcherServlet</li>
<li>Interceptor</li>
<li>HandlerAdapter</li>
</ul>
<p>web程序启动时的初始化顺序: ServletContext -&gt; listener -&gt; filter -&gt; servlet</p>
<p>spring bean的初始化是在listener中声明的, 可以在后面使用.</p>
<p><img src="/2018/05/spring/request-workflow/request-workflow.jpg" alt="workflow"></p>
<p><img src="/2018/05/spring/request-workflow/request-workflow-seq.jpg" alt="workflow-seq"></p>
<h2 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h2><ul>
<li>Servlet规范规定的，只能用于Web程序中, 由Servlet容器提供支持</li>
<li>作用于Servlet执行前后</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Order(1)</span><br><span class="line">@WebFilter(filterName &#x3D; &quot;customized&quot;, urlPatterns &#x3D; &quot;&#x2F;*&quot;)</span><br><span class="line">public class CustomizedFilter implements Filter &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void init(FilterConfig filterConfig) throws ServletException &#123;</span><br><span class="line">        log.info(&quot;CustomizedFilter Init&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123;</span><br><span class="line">        log.info(&quot;CustomizedFilter doFilter before&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 执行Servlet</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line"></span><br><span class="line">        log.info(&quot;CustomizedFilter doFilter after&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void destroy() &#123;</span><br><span class="line">        log.info(&quot;CustomizedFilter destroy&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>必须要注解<strong>ServletComponentScan</strong>才能让自定义的Filter其效果.</p>
<p>在filterChain.doFilter调用的前后来执行操作, 作用于Servlet之前的前后.</p>
<h2 id="DispatcherServlet"><a href="#DispatcherServlet" class="headerlink" title="DispatcherServlet"></a>DispatcherServlet</h2><p>为Spring框架定制的Servlet, 用来对请求进行处理</p>
<ul>
<li>获取请求处理链HandlerExecutionChain</li>
<li>通过HandlerAdapter将请求发送给Controller进行处理</li>
<li>对视图进行解析并将Model传递给视图View, 生成response</li>
</ul>
<h2 id="Interceptor"><a href="#Interceptor" class="headerlink" title="Interceptor"></a>Interceptor</h2><ul>
<li>作用于Handler/Controller前后执行</li>
<li>不能修改request</li>
</ul>
<p>在spring中优先使用Interceptor</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class CustomizedInterceptor extends HandlerInterceptorAdapter &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)</span><br><span class="line">            throws Exception &#123;</span><br><span class="line">        log.info(&quot;CustomizedInterceptor prehandle&quot;);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">	public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler,</span><br><span class="line">			@Nullable ModelAndView modelAndView) throws Exception &#123;</span><br><span class="line">		log.info(&quot;CustomizedInterceptor postHandle&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler,</span><br><span class="line">			@Nullable Exception ex) throws Exception &#123;</span><br><span class="line">		log.info(&quot;CustomizedInterceptor afterCompletion&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 添加interceptor</span><br><span class="line">@Configuration</span><br><span class="line">public class AppServiceConfig extends WebMvcConfigurationSupport &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private CustomizedInterceptor customizedInterceptor;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void addInterceptors(InterceptorRegistry registry) &#123;</span><br><span class="line">        registry.addInterceptor(customizedInterceptor).addPathPatterns(&quot;&#x2F;**&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="HandlerAdapter"><a href="#HandlerAdapter" class="headerlink" title="HandlerAdapter"></a>HandlerAdapter</h2><p><img src="/2018/05/spring/request-workflow/handleradapter-workflow.jpg" alt="workflow"></p>
<ul>
<li>请求流到POJO对象的转换</li>
<li>请求的handler方法调用</li>
<li>ExceptionHandler异常统一处理</li>
</ul>
<p>当使用<strong>RequestBoddy/ResponseBody</strong>注解时, Spring将使用<strong>HttpMessageConverter</strong><br>对用户请求以及Handler的处理结果进行<strong>请求流和POJO对象</strong>之间的转换.</p>
<p>POJO对象转换的处理方式:</p>
<ul>
<li>HttpMessageConverter, spring框架的组件, 用于对body进行转换</li>
<li>WebDataBinder的PropertyEditor, JDK的组件, 从字符串转换到具体的类型, 主要用于对PathVariable参数进行转换</li>
<li>自定义<strong>HandlerMethodArgumentResolver和HandlerMethodReturnValueHandler</strong>来映射Controller中的方法参数和返回结果</li>
</ul>
<p>当所有的参数没解析完毕后, POJO对象列表会被传递给handler方法, 用于获取handler方法中的对应参数.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://github.com/xiayy860612/JavaResearch/tree/master/spring/spring-request-workflow">源码</a></p>
<p>Servlet规范:</p>
<ul>
<li><a href="https://jcp.org/en/jsr/detail?id=340">JSR 340: Java Servlet 3.1 Specification</a></li>
<li><a href="https://waylau.gitbooks.io/servlet-3-1-specification/content/">中文翻译</a></li>
</ul>
<p>参考文章:</p>
<ul>
<li><a href="https://blog.csdn.net/zhaolijing2012/article/details/41596803">SpringMVC系列（一）核心：处理请求流程</a></li>
<li><a href="http://www.cnblogs.com/cnndevelop/p/7255622.html">Spring Boot :Request请求处理流程</a></li>
<li><a href="http://www.51gjie.com/javaweb/909.html">Spring MVC工作流程以及请求处理流程</a></li>
<li><a href="https://blog.csdn.net/u012881904/article/details/51292211">码农小汪-Spring MVC -DispatcherServlet 详解</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-servlet/index.html">Servlet 工作原理解析</a></li>
<li><a href="https://www.cnblogs.com/ycpanda/p/3637312.html">Spring filter和拦截器(Interceptor)的区别和执行顺序</a></li>
<li><a href="http://fanlychie.github.io/post/spring-boot-servlet-filter-listener-usage.html">Spring Boot 使用 Servlet、Filter、Listener</a></li>
<li><a href="https://my.oschina.net/lichhao/blog/172562">SpringMVC源码剖析（五)-消息转换器HttpMessageConverter</a></li>
<li><a href="https://leokongwq.github.io/2015/04/17/springMVCOutlines.html">Spring MVC HandlerMapping HandlerAdapter</a></li>
<li><a href="https://blog.csdn.net/hongxingxiaonan/article/details/50282001">SpringMVC中WebDataBinder的应用及原理</a></li>
<li><a href="https://blog.csdn.net/u010913106/article/details/50855691">说说Spring中的WebDataBinder</a></li>
<li><a href="https://www.jianshu.com/p/ffe56d9553fd">Spring Boot：定制HTTP消息转换器</a></li>
</ul>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Security --- Architecture</title>
    <url>/2021/01/spring-security/architecture/</url>
    <content><![CDATA[<h2 id="同Spring的集成"><a href="#同Spring的集成" class="headerlink" title="同Spring的集成"></a>同Spring的集成</h2><p>Spring Security的架构是完全基于标准的Servlet过滤器进行实现的,<br>所以只要是基于Java Servlet框架就可以集成它.</p>
<p>整个Spring Security的入口为FilterChainProxy.</p>
<p><img src="/2021/01/spring-security/architecture/spring-security-integrate-to-spring.png"></p>
<p>在Spring中定义名为<strong>springSecurityFilterChain</strong>的FilterChainProxy的bean实例,<br>然后通过DelegatingFilterProxy获取它, 并将它插入到Servlet的过滤器链中.</p>
<h2 id="过滤器链的设计"><a href="#过滤器链的设计" class="headerlink" title="过滤器链的设计"></a>过滤器链的设计</h2><p>FilterChainProxy的内部维护了多个过滤器链(SecurityFilterChain),<br>会按照Order注解定义的顺序, 每个SecurityFilterChain通过<strong>RequestMatcher</strong>对请求url进行匹配,<br>并使用第一个匹配的SecurityFilterChain对请求进行处理.<br>所以每个SecurityFilterChain的匹配规则和顺序.</p>
<ul>
<li>AutowiredWebSecurityConfigurersIgnoreParents#getWebSecurityConfigurers,<br>获取所有实现了<strong>WebSecurityConfigurer接口</strong>的SecurityFilterChain的配置</li>
<li>WebSecurityConfiguration#setFilterChainProxySecurityConfigurer,<br>对所有的SecurityFilterChain的配置根据Order注解进行排序,<br>并加载到WebSecurity中用于生成SecurityFilterChain.</li>
<li>WebSecurityConfiguration#springSecurityFilterChain,<br>定义了名为<strong>springSecurityFilterChain</strong>的FilterChainProxy的bean实例</li>
</ul>
<p><img src="/2021/01/spring-security/architecture/filter-chain-design.png"></p>
<h2 id="怎样配置过滤器链"><a href="#怎样配置过滤器链" class="headerlink" title="怎样配置过滤器链"></a>怎样配置过滤器链</h2><p>Spring Security通过实现WebSecurityConfigurer接口来进行相关的配置,<br>并且它提供了一个默认的抽象实现WebSecurityConfigurerAdapter,<br>它主要提供了3个方面的配置:</p>
<ul>
<li>WebSecurityConfigurerAdapter#configure(WebSecurity), 对FilterChainProxy进行配置</li>
<li>WebSecurityConfigurerAdapter#configure(HttpSecurity), 对SecurityFilterChain进行配置</li>
<li>WebSecurityConfigurerAdapter#configure(AuthenticationManagerBuilder), 对认证相关进行配置</li>
</ul>
<h2 id="核心的过滤器介绍"><a href="#核心的过滤器介绍" class="headerlink" title="核心的过滤器介绍"></a>核心的过滤器介绍</h2><p>每个SecurityFilterChain中都包含多个过滤器(Filter),<br>下面是一般默认加载的Filter.</p>
<p><img src="/2021/01/spring-security/architecture/chain-default-filters.png"></p>
<h3 id="SecurityContextPersistenceFilter"><a href="#SecurityContextPersistenceFilter" class="headerlink" title="SecurityContextPersistenceFilter"></a>SecurityContextPersistenceFilter</h3><p>检查当前请求是否有相关的session存在, 如果存在, 则获取保存的SecurityContext;<br>不存在, 则创建新的SecurityContext.</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="296px" preserveAspectRatio="none" style="width:1911px;height:296px;background:#FFFFFF;" version="1.1" viewBox="0 0 1911 296" width="1911px" zoomAndPan="magnify"><defs/><g><!--MD5=[86b30c3e0fe779331a576db045bd0856]
class SecurityContext--><g id="elem_SecurityContext"><rect codeLine="1" fill="#F1F1F1" height="48" id="SecurityContext" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="145" x="574.5" y="241"/><ellipse cx="589.5" cy="257" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M590.4531,253.7813 L592.1719,253.7813 C592.5625,253.7813 592.75,253.75 592.875,253.6719 C593.1406,253.5156 593.2813,253.2344 593.2813,252.9375 C593.2813,252.6719 593.1719,252.4063 592.9375,252.2344 C592.7656,252.125 592.625,252.0938 592.1719,252.0938 L587.0313,252.0938 C586.5938,252.0938 586.4688,252.1094 586.3125,252.2031 C586.0625,252.3594 585.9063,252.6563 585.9063,252.9375 C585.9063,253.2188 586.0469,253.4688 586.2656,253.6406 C586.4219,253.75 586.6094,253.7813 587.0313,253.7813 L588.75,253.7813 L588.75,260.2969 L587.0313,260.2969 C586.5938,260.2969 586.4688,260.3125 586.3125,260.4219 C586.0625,260.5781 585.9063,260.8594 585.9063,261.1563 C585.9063,261.4063 586.0469,261.6719 586.2656,261.8281 C586.4219,261.9531 586.625,262 587.0313,262 L592.1719,262 C592.9219,262 593.2813,261.7188 593.2813,261.1563 C593.2813,260.875 593.1719,260.625 592.9375,260.4531 C592.7656,260.3281 592.625,260.2969 592.1719,260.2969 L590.4531,260.2969 L590.4531,253.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="113" x="603.5" y="261.8467">SecurityContext</text><line style="stroke:#181818;stroke-width:0.5;" x1="575.5" x2="718.5" y1="273" y2="273"/><line style="stroke:#181818;stroke-width:0.5;" x1="575.5" x2="718.5" y1="281" y2="281"/></g><!--MD5=[9a99cb9a334c3f5f64071e0b1ceb1139]
class SecurityContextRepository--><g id="elem_SecurityContextRepository"><rect codeLine="3" fill="#F1F1F1" height="48" id="SecurityContextRepository" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="221" x="295.5" y="116"/><ellipse cx="310.5" cy="132" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M311.4531,128.7813 L313.1719,128.7813 C313.5625,128.7813 313.75,128.75 313.875,128.6719 C314.1406,128.5156 314.2813,128.2344 314.2813,127.9375 C314.2813,127.6719 314.1719,127.4063 313.9375,127.2344 C313.7656,127.125 313.625,127.0938 313.1719,127.0938 L308.0313,127.0938 C307.5938,127.0938 307.4688,127.1094 307.3125,127.2031 C307.0625,127.3594 306.9063,127.6563 306.9063,127.9375 C306.9063,128.2188 307.0469,128.4688 307.2656,128.6406 C307.4219,128.75 307.6094,128.7813 308.0313,128.7813 L309.75,128.7813 L309.75,135.2969 L308.0313,135.2969 C307.5938,135.2969 307.4688,135.3125 307.3125,135.4219 C307.0625,135.5781 306.9063,135.8594 306.9063,136.1563 C306.9063,136.4063 307.0469,136.6719 307.2656,136.8281 C307.4219,136.9531 307.625,137 308.0313,137 L313.1719,137 C313.9219,137 314.2813,136.7188 314.2813,136.1563 C314.2813,135.875 314.1719,135.625 313.9375,135.4531 C313.7656,135.3281 313.625,135.2969 313.1719,135.2969 L311.4531,135.2969 L311.4531,128.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="189" x="324.5" y="136.8467">SecurityContextRepository</text><line style="stroke:#181818;stroke-width:0.5;" x1="296.5" x2="515.5" y1="148" y2="148"/><line style="stroke:#181818;stroke-width:0.5;" x1="296.5" x2="515.5" y1="156" y2="156"/></g><!--MD5=[c0e9df09858c93831bec50f6f100df88]
class HttpSessionSecurityContextRepository--><g id="elem_HttpSessionSecurityContextRepository"><rect codeLine="4" fill="#F1F1F1" height="48" id="HttpSessionSecurityContextRepository" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="317" x="222.5" y="241"/><ellipse cx="237.5" cy="257" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M239.8438,252.6719 C238.9063,252.2344 238.3125,252.0938 237.4375,252.0938 C234.8125,252.0938 232.8125,254.1719 232.8125,256.8906 L232.8125,258.0156 C232.8125,260.5938 234.9219,262.4844 237.8125,262.4844 C239.0313,262.4844 240.1875,262.1875 240.9375,261.6406 C241.5156,261.2344 241.8438,260.7813 241.8438,260.3906 C241.8438,259.9375 241.4531,259.5469 240.9844,259.5469 C240.7656,259.5469 240.5625,259.625 240.375,259.8125 C239.9219,260.2969 239.9219,260.2969 239.7344,260.3906 C239.3125,260.6563 238.625,260.7813 237.8594,260.7813 C235.8125,260.7813 234.5156,259.6875 234.5156,257.9844 L234.5156,256.8906 C234.5156,255.1094 235.7656,253.7969 237.5,253.7969 C238.0781,253.7969 238.6875,253.9531 239.1563,254.2031 C239.6406,254.4844 239.8125,254.7031 239.9063,255.1094 C239.9688,255.5156 240,255.6406 240.1406,255.7656 C240.2813,255.9063 240.5156,256.0156 240.7344,256.0156 C241,256.0156 241.2656,255.875 241.4375,255.6563 C241.5469,255.5 241.5781,255.3125 241.5781,254.8906 L241.5781,253.4688 C241.5781,253.0313 241.5625,252.9063 241.4688,252.75 C241.3125,252.4844 241.0313,252.3438 240.7344,252.3438 C240.4375,252.3438 240.2344,252.4375 240.0156,252.75 L239.8438,252.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="285" x="251.5" y="261.8467">HttpSessionSecurityContextRepository</text><line style="stroke:#181818;stroke-width:0.5;" x1="223.5" x2="538.5" y1="273" y2="273"/><line style="stroke:#181818;stroke-width:0.5;" x1="223.5" x2="538.5" y1="281" y2="281"/></g><g id="elem_GMN53185"><path d="M6,127.5 L6,152.6328 A0,0 0 0 0 6,152.6328 L260,152.6328 A0,0 0 0 0 260,152.6328 L260,145.5 L295.487,140 L260,137.5 L260,137.5 L250,127.5 L6,127.5 A0,0 0 0 0 6,127.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M250,127.5 L250,137.5 L260,137.5 L250,127.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233" x="12" y="144.5669">通过http session关联SecurityContext</text></g><!--MD5=[434a86a25993eeeea880c43cffc3083d]
class SecurityContextHolder--><g id="elem_SecurityContextHolder"><rect codeLine="11" fill="#F1F1F1" height="48" id="SecurityContextHolder" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="197" x="962.5" y="7"/><ellipse cx="977.5" cy="23" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M979.8438,18.6719 C978.9063,18.2344 978.3125,18.0938 977.4375,18.0938 C974.8125,18.0938 972.8125,20.1719 972.8125,22.8906 L972.8125,24.0156 C972.8125,26.5938 974.9219,28.4844 977.8125,28.4844 C979.0313,28.4844 980.1875,28.1875 980.9375,27.6406 C981.5156,27.2344 981.8438,26.7813 981.8438,26.3906 C981.8438,25.9375 981.4531,25.5469 980.9844,25.5469 C980.7656,25.5469 980.5625,25.625 980.375,25.8125 C979.9219,26.2969 979.9219,26.2969 979.7344,26.3906 C979.3125,26.6563 978.625,26.7813 977.8594,26.7813 C975.8125,26.7813 974.5156,25.6875 974.5156,23.9844 L974.5156,22.8906 C974.5156,21.1094 975.7656,19.7969 977.5,19.7969 C978.0781,19.7969 978.6875,19.9531 979.1563,20.2031 C979.6406,20.4844 979.8125,20.7031 979.9063,21.1094 C979.9688,21.5156 980,21.6406 980.1406,21.7656 C980.2813,21.9063 980.5156,22.0156 980.7344,22.0156 C981,22.0156 981.2656,21.875 981.4375,21.6563 C981.5469,21.5 981.5781,21.3125 981.5781,20.8906 L981.5781,19.4688 C981.5781,19.0313 981.5625,18.9063 981.4688,18.75 C981.3125,18.4844 981.0313,18.3438 980.7344,18.3438 C980.4375,18.3438 980.2344,18.4375 980.0156,18.75 L979.8438,18.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="165" x="991.5" y="27.8467">SecurityContextHolder</text><line style="stroke:#181818;stroke-width:0.5;" x1="963.5" x2="1158.5" y1="39" y2="39"/><line style="stroke:#181818;stroke-width:0.5;" x1="963.5" x2="1158.5" y1="47" y2="47"/></g><g id="elem_M1"><path d="M601,127.5 L601,152.6328 L855,152.6328 L855,137.5 L845,127.5 L601,127.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M845,127.5 L845,137.5 L855,137.5 L845,127.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233" x="607" y="144.5669">对当前请求的SecurityContext进行代理</text></g><!--MD5=[be780c5fb7e3c3d02d75cf2b549e3215]
class SecurityContextHolderStrategy--><g id="elem_SecurityContextHolderStrategy"><rect codeLine="16" fill="#F1F1F1" height="48" id="SecurityContextHolderStrategy" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="253" x="1142.5" y="116"/><ellipse cx="1157.5" cy="132" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1158.4531,128.7813 L1160.1719,128.7813 C1160.5625,128.7813 1160.75,128.75 1160.875,128.6719 C1161.1406,128.5156 1161.2813,128.2344 1161.2813,127.9375 C1161.2813,127.6719 1161.1719,127.4063 1160.9375,127.2344 C1160.7656,127.125 1160.625,127.0938 1160.1719,127.0938 L1155.0313,127.0938 C1154.5938,127.0938 1154.4688,127.1094 1154.3125,127.2031 C1154.0625,127.3594 1153.9063,127.6563 1153.9063,127.9375 C1153.9063,128.2188 1154.0469,128.4688 1154.2656,128.6406 C1154.4219,128.75 1154.6094,128.7813 1155.0313,128.7813 L1156.75,128.7813 L1156.75,135.2969 L1155.0313,135.2969 C1154.5938,135.2969 1154.4688,135.3125 1154.3125,135.4219 C1154.0625,135.5781 1153.9063,135.8594 1153.9063,136.1563 C1153.9063,136.4063 1154.0469,136.6719 1154.2656,136.8281 C1154.4219,136.9531 1154.625,137 1155.0313,137 L1160.1719,137 C1160.9219,137 1161.2813,136.7188 1161.2813,136.1563 C1161.2813,135.875 1161.1719,135.625 1160.9375,135.4531 C1160.7656,135.3281 1160.625,135.2969 1160.1719,135.2969 L1158.4531,135.2969 L1158.4531,128.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="221" x="1171.5" y="136.8467">SecurityContextHolderStrategy</text><line style="stroke:#181818;stroke-width:0.5;" x1="1143.5" x2="1394.5" y1="148" y2="148"/><line style="stroke:#181818;stroke-width:0.5;" x1="1143.5" x2="1394.5" y1="156" y2="156"/></g><g id="elem_GMN53194"><path d="M914.5,120 L914.5,160.2656 A0,0 0 0 0 914.5,160.2656 L1107.5,160.2656 A0,0 0 0 0 1107.5,160.2656 L1107.5,144 L1142.39,140 L1107.5,136 L1107.5,130 L1097.5,120 L914.5,120 A0,0 0 0 0 914.5,120 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1097.5,120 L1097.5,130 L1107.5,130 L1097.5,120 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="920.5" y="137.0669">SecurityContext的存储策略,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="920.5" y="152.1997">默认为ThreadLocal</text></g><!--MD5=[7a03ac347b7eb35ecfc2fc99aff3260a]
class GlobalSecurityContextHolderStrategy--><g id="elem_GlobalSecurityContextHolderStrategy"><rect codeLine="21" fill="#F1F1F1" height="48" id="GlobalSecurityContextHolderStrategy" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="306" x="755" y="241"/><ellipse cx="770" cy="257" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M772.3438,252.6719 C771.4063,252.2344 770.8125,252.0938 769.9375,252.0938 C767.3125,252.0938 765.3125,254.1719 765.3125,256.8906 L765.3125,258.0156 C765.3125,260.5938 767.4219,262.4844 770.3125,262.4844 C771.5313,262.4844 772.6875,262.1875 773.4375,261.6406 C774.0156,261.2344 774.3438,260.7813 774.3438,260.3906 C774.3438,259.9375 773.9531,259.5469 773.4844,259.5469 C773.2656,259.5469 773.0625,259.625 772.875,259.8125 C772.4219,260.2969 772.4219,260.2969 772.2344,260.3906 C771.8125,260.6563 771.125,260.7813 770.3594,260.7813 C768.3125,260.7813 767.0156,259.6875 767.0156,257.9844 L767.0156,256.8906 C767.0156,255.1094 768.2656,253.7969 770,253.7969 C770.5781,253.7969 771.1875,253.9531 771.6563,254.2031 C772.1406,254.4844 772.3125,254.7031 772.4063,255.1094 C772.4688,255.5156 772.5,255.6406 772.6406,255.7656 C772.7813,255.9063 773.0156,256.0156 773.2344,256.0156 C773.5,256.0156 773.7656,255.875 773.9375,255.6563 C774.0469,255.5 774.0781,255.3125 774.0781,254.8906 L774.0781,253.4688 C774.0781,253.0313 774.0625,252.9063 773.9688,252.75 C773.8125,252.4844 773.5313,252.3438 773.2344,252.3438 C772.9375,252.3438 772.7344,252.4375 772.5156,252.75 L772.3438,252.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="274" x="784" y="261.8467">GlobalSecurityContextHolderStrategy</text><line style="stroke:#181818;stroke-width:0.5;" x1="756" x2="1060" y1="273" y2="273"/><line style="stroke:#181818;stroke-width:0.5;" x1="756" x2="1060" y1="281" y2="281"/></g><!--MD5=[032766fa7dbad1ac191509830aade588]
class InheritableThreadLocalSecurityContextHolderStrategy--><g id="elem_InheritableThreadLocalSecurityContextHolderStrategy"><rect codeLine="22" fill="#F1F1F1" height="48" id="InheritableThreadLocalSecurityContextHolderStrategy" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="426" x="1096" y="241"/><ellipse cx="1111" cy="257" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1113.3438,252.6719 C1112.4063,252.2344 1111.8125,252.0938 1110.9375,252.0938 C1108.3125,252.0938 1106.3125,254.1719 1106.3125,256.8906 L1106.3125,258.0156 C1106.3125,260.5938 1108.4219,262.4844 1111.3125,262.4844 C1112.5313,262.4844 1113.6875,262.1875 1114.4375,261.6406 C1115.0156,261.2344 1115.3438,260.7813 1115.3438,260.3906 C1115.3438,259.9375 1114.9531,259.5469 1114.4844,259.5469 C1114.2656,259.5469 1114.0625,259.625 1113.875,259.8125 C1113.4219,260.2969 1113.4219,260.2969 1113.2344,260.3906 C1112.8125,260.6563 1112.125,260.7813 1111.3594,260.7813 C1109.3125,260.7813 1108.0156,259.6875 1108.0156,257.9844 L1108.0156,256.8906 C1108.0156,255.1094 1109.2656,253.7969 1111,253.7969 C1111.5781,253.7969 1112.1875,253.9531 1112.6563,254.2031 C1113.1406,254.4844 1113.3125,254.7031 1113.4063,255.1094 C1113.4688,255.5156 1113.5,255.6406 1113.6406,255.7656 C1113.7813,255.9063 1114.0156,256.0156 1114.2344,256.0156 C1114.5,256.0156 1114.7656,255.875 1114.9375,255.6563 C1115.0469,255.5 1115.0781,255.3125 1115.0781,254.8906 L1115.0781,253.4688 C1115.0781,253.0313 1115.0625,252.9063 1114.9688,252.75 C1114.8125,252.4844 1114.5313,252.3438 1114.2344,252.3438 C1113.9375,252.3438 1113.7344,252.4375 1113.5156,252.75 L1113.3438,252.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="394" x="1125" y="261.8467">InheritableThreadLocalSecurityContextHolderStrategy</text><line style="stroke:#181818;stroke-width:0.5;" x1="1097" x2="1521" y1="273" y2="273"/><line style="stroke:#181818;stroke-width:0.5;" x1="1097" x2="1521" y1="281" y2="281"/></g><!--MD5=[bcc8d52e431d3d51980519b26057fde1]
class ThreadLocalSecurityContextHolderStrategy--><g id="elem_ThreadLocalSecurityContextHolderStrategy"><rect codeLine="23" fill="#F1F1F1" height="48" id="ThreadLocalSecurityContextHolderStrategy" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="347" x="1557.5" y="241"/><ellipse cx="1572.5" cy="257" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1574.8438,252.6719 C1573.9063,252.2344 1573.3125,252.0938 1572.4375,252.0938 C1569.8125,252.0938 1567.8125,254.1719 1567.8125,256.8906 L1567.8125,258.0156 C1567.8125,260.5938 1569.9219,262.4844 1572.8125,262.4844 C1574.0313,262.4844 1575.1875,262.1875 1575.9375,261.6406 C1576.5156,261.2344 1576.8438,260.7813 1576.8438,260.3906 C1576.8438,259.9375 1576.4531,259.5469 1575.9844,259.5469 C1575.7656,259.5469 1575.5625,259.625 1575.375,259.8125 C1574.9219,260.2969 1574.9219,260.2969 1574.7344,260.3906 C1574.3125,260.6563 1573.625,260.7813 1572.8594,260.7813 C1570.8125,260.7813 1569.5156,259.6875 1569.5156,257.9844 L1569.5156,256.8906 C1569.5156,255.1094 1570.7656,253.7969 1572.5,253.7969 C1573.0781,253.7969 1573.6875,253.9531 1574.1563,254.2031 C1574.6406,254.4844 1574.8125,254.7031 1574.9063,255.1094 C1574.9688,255.5156 1575,255.6406 1575.1406,255.7656 C1575.2813,255.9063 1575.5156,256.0156 1575.7344,256.0156 C1576,256.0156 1576.2656,255.875 1576.4375,255.6563 C1576.5469,255.5 1576.5781,255.3125 1576.5781,254.8906 L1576.5781,253.4688 C1576.5781,253.0313 1576.5625,252.9063 1576.4688,252.75 C1576.3125,252.4844 1576.0313,252.3438 1575.7344,252.3438 C1575.4375,252.3438 1575.2344,252.4375 1575.0156,252.75 L1574.8438,252.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="315" x="1586.5" y="261.8467">ThreadLocalSecurityContextHolderStrategy</text><line style="stroke:#181818;stroke-width:0.5;" x1="1558.5" x2="1903.5" y1="273" y2="273"/><line style="stroke:#181818;stroke-width:0.5;" x1="1558.5" x2="1903.5" y1="281" y2="281"/></g><!--MD5=[71892c67b0ff1cb845f0194e61e60f2e]
reverse link SecurityContextRepository to HttpSessionSecurityContextRepository--><g id="link_SecurityContextRepository_HttpSessionSecurityContextRepository"><path d="M397.288,183.864 C393.386,203.0596 388.941,224.9301 385.681,240.9684 " fill="none" id="SecurityContextRepository-backto-HttpSessionSecurityContextRepository" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="390.454,182.34,401.298,164.135,404.174,185.129,390.454,182.34" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[37d07bce3f1802e02386dbd6d9427d34]
link SecurityContextRepository to SecurityContext--><g id="link_SecurityContextRepository_SecurityContext"><path codeLine="9" d="M462.0185,169.59 C462.0185,169.59 551.63,215.3258 589.898,234.8565 " fill="none" id="SecurityContextRepository-SecurityContext" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="601.873,240.9684,595.6753,233.3141,597.4196,238.6953,592.0383,240.4396,601.873,240.9684" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="597.4196" x2="590.2935" y1="238.6953" y2="235.0587"/><polygon fill="#181818" points="451.33,164.135,454.8559,170.4253,462.0185,169.59,458.4926,163.2997,451.33,164.135" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="26" x="542" y="207.0669">管理</text></g><!--MD5=[ae56cfd077aaad477c47b1c82d5b65bc]
link SecurityContextHolder to M1--><g id="link_SecurityContextHolder_M1"><path codeLine="13" d="M989.154,55.086 C919.749,77.387 817.487,110.246 763.845,127.482 " fill="none" id="SecurityContextHolder-M1" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[ebbb7c37604a30d39e2aeb3096bbea59]
link M1 to SecurityContext--><g id="link_M1_SecurityContext"><path codeLine="14" d="M720.233,152.794 C707.656,171.892 682.5,210.0922 665.212,236.3442 " fill="none" id="M1-to-SecurityContext" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="662.295,240.7743,670.5849,235.4566,665.0444,236.5981,663.9029,231.0576,662.295,240.7743" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[128144d96a9bd0bc9663f6c4a818020c]
reverse link SecurityContextHolderStrategy to GlobalSecurityContextHolderStrategy--><g id="link_SecurityContextHolderStrategy_GlobalSecurityContextHolderStrategy"><path d="M1182.16,170.589 C1118.74,192.196 1034,221.0707 975.597,240.9684 " fill="none" id="SecurityContextHolderStrategy-backto-GlobalSecurityContextHolderStrategy" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="1179.91,163.96,1201.1,164.135,1184.42,177.212,1179.91,163.96" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[03364836ee6754ac724b9d3313278467]
reverse link SecurityContextHolderStrategy to InheritableThreadLocalSecurityContextHolderStrategy--><g id="link_SecurityContextHolderStrategy_InheritableThreadLocalSecurityContextHolderStrategy"><path d="M1282.74,183.249 C1289.03,202.5911 1296.24,224.7586 1301.51,240.9684 " fill="none" id="SecurityContextHolderStrategy-backto-InheritableThreadLocalSecurityContextHolderStrategy" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="1276.05,185.32,1276.52,164.135,1289.37,180.99,1276.05,185.32" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[5eac4ed8ac12a7e818699eb5d1847ef6]
reverse link SecurityContextHolderStrategy to ThreadLocalSecurityContextHolderStrategy--><g id="link_SecurityContextHolderStrategy_ThreadLocalSecurityContextHolderStrategy"><path d="M1375.17,169.267 C1456.79,190.9957 1568.12,220.6349 1644.39,240.9408 " fill="none" id="SecurityContextHolderStrategy-backto-ThreadLocalSecurityContextHolderStrategy" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="1373.15,175.973,1355.63,164.063,1376.76,162.444,1373.15,175.973" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[c2c61623dd30c7705779b8791b568f97]
link SecurityContextHolder to SecurityContextHolderStrategy--><g id="link_SecurityContextHolder_SecurityContextHolderStrategy"><path codeLine="24" d="M1105.88,55.086 C1140.87,73.086 1189.23,97.966 1224.2,115.956 " fill="none" id="SecurityContextHolder-SecurityContextHolderStrategy" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[95f27ee902713e6b5fbe721ec36af134]
@startuml
interface SecurityContext

interface SecurityContextRepository
class HttpSessionSecurityContextRepository implements SecurityContextRepository
note left
通过http session关联SecurityContext
end note

SecurityContextRepository *- -> SecurityContext: 管理

class SecurityContextHolder
note "对当前请求的SecurityContext进行代理" as M1
SecurityContextHolder - - M1
M1 - -> SecurityContext

interface SecurityContextHolderStrategy
note left
SecurityContext的存储策略,
默认为ThreadLocal
end note
class GlobalSecurityContextHolderStrategy implements SecurityContextHolderStrategy
class InheritableThreadLocalSecurityContextHolderStrategy implements SecurityContextHolderStrategy
class ThreadLocalSecurityContextHolderStrategy implements SecurityContextHolderStrategy
SecurityContextHolder - - SecurityContextHolderStrategy
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<p>在请求处理的过程中, 可以通过SecurityContextHolder来获取SecurityContext,<br>SecurityContext中包含了Authentication信息.</p>
<p><img src="/2021/01/spring-security/architecture/SecurityContext.png"></p>
<p>SecurityContextHolder默认将SecurityContext保存在ThreadLocal中</p>
<h3 id="LogoutFilter"><a href="#LogoutFilter" class="headerlink" title="LogoutFilter"></a>LogoutFilter</h3><p>处理用户的登出请求, 通过LogoutHandler实例对相关的数据进行清理,<br>成功清理完成后调用LogoutSuccessHandler</p>
<h3 id="AuthenticationFilter"><a href="#AuthenticationFilter" class="headerlink" title="AuthenticationFilter"></a>AuthenticationFilter</h3><p>Authentication描述登录的认证输入信息,<br>通过校验认证输入信息, 得到认证成功后的Authentication信息.<br>认证成功后的Authentication会被保存在SecurityContext中.</p>
<p>详情会在认证章节进行讨论.</p>
<h3 id="SessionManagementFilter"><a href="#SessionManagementFilter" class="headerlink" title="SessionManagementFilter"></a>SessionManagementFilter</h3><p>对刚刚认证通过的用户进行session校验, 主要针对同时登录数之类的检查.</p>
<p>详情会在Session章节进行讨论.</p>
<h3 id="ExceptionTranslationFilter"><a href="#ExceptionTranslationFilter" class="headerlink" title="ExceptionTranslationFilter"></a>ExceptionTranslationFilter</h3><p>Spring Security中的全局异常处理,<br>用于对ExceptionTranslationFilter之后的所有Filter产生的<br>AccessDeniedException和AuthenticationException进行捕获处理.</p>
<p><img src="/2021/01/spring-security/architecture/spring-security-excepton-handle.png"></p>
<h3 id="FilterSecurityInterceptor"><a href="#FilterSecurityInterceptor" class="headerlink" title="FilterSecurityInterceptor"></a>FilterSecurityInterceptor</h3><p>根据<strong>在SecurityFilterChain中预先配置</strong>的鉴权信息, 对当前请求进行校验.</p>
<p><img src="/2021/01/spring-security/architecture/filtersecurityinterceptor.png"></p>
<p>详情会在认证章节进行讨论.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://spring.io/guides/topicals/spring-security-architecture">Spring Security Architecture</a></li>
<li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/">Spring Security Reference</a></li>
</ul>
]]></content>
      <categories>
        <category>Spring Security</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>Spring Security</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring MVC RESTfull请求处理流程</title>
    <url>/2022/03/spring/spring-mvc/</url>
    <content><![CDATA[<p>开发环境</p>
<ul>
<li>org.springframework:spring-webmvc:5.3.10</li>
<li>org.springframework.boot:spring-boot:2.5.5</li>
</ul>
<a id="more"></a>

<h2 id="核心处理流程"><a href="#核心处理流程" class="headerlink" title="核心处理流程"></a>核心处理流程</h2><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="463px" preserveAspectRatio="none" style="width:1246px;height:463px;background:#FFFFFF;" version="1.1" viewBox="0 0 1246 463" width="1246px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="335.1953" style="stroke:#181818;stroke-width:1.0;" width="10" x="329.5" y="75.4297"/><rect fill="#FFFFFF" height="69.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="334.5" y="291.2266"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="630.5" y="167.8281"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="630.5" y="240.0938"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="630.5" y="396.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="334" x2="334" y1="36.2969" y2="428.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="635.5" x2="635.5" y1="36.2969" y2="428.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="799.5" x2="799.5" y1="36.2969" y2="428.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="975.5" x2="975.5" y1="36.2969" y2="428.625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1163.5" x2="1163.5" y1="36.2969" y2="428.625"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="145" x="262" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="131" x="269" y="24.9951">DispatcherServlet</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="145" x="262" y="427.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="131" x="269" y="447.6201">DispatcherServlet</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="180" x="545.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="552.5" y="24.9951">HandlerExecutionChain</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="180" x="545.5" y="427.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="552.5" y="447.6201">HandlerExecutionChain</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="128" x="735.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="742.5" y="24.9951">HandlerAdapter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="128" x="735.5" y="427.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="742.5" y="447.6201">HandlerAdapter</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="204" x="873.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="190" x="880.5" y="24.9951">HandlerExceptionResolver</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="204" x="873.5" y="427.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="190" x="880.5" y="447.6201">HandlerExceptionResolver</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="153" x="1087.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139" x="1094.5" y="24.9951">HandlerInterceptor</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="153" x="1087.5" y="427.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="139" x="1094.5" y="447.6201">HandlerInterceptor</text><rect fill="#FFFFFF" height="335.1953" style="stroke:#181818;stroke-width:1.0;" width="10" x="329.5" y="75.4297"/><rect fill="#FFFFFF" height="69.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="334.5" y="291.2266"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="630.5" y="167.8281"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="630.5" y="240.0938"/><rect fill="#FFFFFF" height="14" style="stroke:#181818;stroke-width:1.0;" width="10" x="630.5" y="396.625"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="334.5" x2="381.5" y1="62.4297" y2="62.4297"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="381.5" x2="381.5" y1="62.4297" y2="75.4297"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="340.5" x2="381.5" y1="75.4297" y2="75.4297"/><polygon fill="#181818" points="350.5,71.4297,340.5,75.4297,350.5,79.4297,346.5,75.4297" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="346.5" y="57.3638">doDispatch</text><polygon fill="#181818" points="623.5,105.5625,633.5,109.5625,623.5,113.5625,627.5,109.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="339.5" x2="629.5" y1="109.5625" y2="109.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="346.5" y="104.4966">handler = getHandler</text><polygon fill="#181818" points="787.5,134.6953,797.5,138.6953,787.5,142.6953,791.5,138.6953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="339.5" x2="793.5" y1="138.6953" y2="138.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="247" x="346.5" y="133.6294">adapter = getHandlerAdapter(handler)</text><polygon fill="#181818" points="618.5,163.8281,628.5,167.8281,618.5,171.8281,622.5,167.8281" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="339.5" x2="624.5" y1="167.8281" y2="167.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="346.5" y="162.7622">applyPreHandle</text><polygon fill="#181818" points="1152,177.8281,1162,181.8281,1152,185.8281,1156,181.8281" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="635.5" x2="1158" y1="181.8281" y2="181.8281"/><polygon fill="#181818" points="787.5,206.9609,797.5,210.9609,787.5,214.9609,791.5,210.9609" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="339.5" x2="793.5" y1="210.9609" y2="210.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="314" x="346.5" y="205.895">modelView = handle(request, response, handler)</text><polygon fill="#181818" points="618.5,236.0938,628.5,240.0938,618.5,244.0938,622.5,240.0938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="339.5" x2="624.5" y1="240.0938" y2="240.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="346.5" y="235.0278">applyPostHandle</text><polygon fill="#181818" points="1152,250.0938,1162,254.0938,1152,258.0938,1156,254.0938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="635.5" x2="1158" y1="254.0938" y2="254.0938"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="339.5" x2="386.5" y1="278.2266" y2="278.2266"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="386.5" x2="386.5" y1="278.2266" y2="291.2266"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="345.5" x2="386.5" y1="291.2266" y2="291.2266"/><polygon fill="#181818" points="355.5,287.2266,345.5,291.2266,355.5,295.2266,351.5,291.2266" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="247" x="351.5" y="273.1606">processDispatchResult(modelView, ...)</text><polygon fill="#181818" points="963.5,321.3594,973.5,325.3594,963.5,329.3594,967.5,325.3594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="344.5" x2="969.5" y1="325.3594" y2="325.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="270" x="351.5" y="320.2935">modelAndView = resolveException(ex, ...)</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="344.5" x2="386.5" y1="359.4922" y2="359.4922"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="386.5" x2="386.5" y1="359.4922" y2="372.4922"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="339.5" x2="386.5" y1="372.4922" y2="372.4922"/><polygon fill="#181818" points="349.5,368.4922,339.5,372.4922,349.5,376.4922,345.5,372.4922" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="272" x="351.5" y="354.4263">render(modelAndView, request, response)</text><path d="M5,341.8594 L5,366.8594 L325,366.8594 L325,351.8594 L315,341.8594 L5,341.8594 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M315,341.8594 L315,351.8594 L325,351.8594 L315,341.8594 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="299" x="11" y="358.9263">对ModelAndView进行渲染或者Exception进行处理</text><polygon fill="#181818" points="618.5,392.625,628.5,396.625,618.5,400.625,622.5,396.625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="339.5" x2="624.5" y1="396.625" y2="396.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="346.5" y="391.5591">triggerAfterCompletion</text><polygon fill="#181818" points="1152,406.625,1162,410.625,1152,414.625,1156,410.625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="635.5" x2="1158" y1="410.625" y2="410.625"/><!--MD5=[01e734d4d0df82c6daa7c51ba0a9904f]
@startuml
participant DS as "DispatcherServlet"
participant HEC as "HandlerExecutionChain"
participant HA as "HandlerAdapter"
participant ER as "HandlerExceptionResolver"
participant HI as "HandlerInterceptor"


DS - -> DS: doDispatch
activate DS
DS - -> HEC: handler = getHandler
DS - -> HA: adapter = getHandlerAdapter(handler)
DS - -> HEC: applyPreHandle
activate HEC
HEC - -> HI
deactivate HEC
DS - -> HA: modelView = handle(request, response, handler)
DS - -> HEC: applyPostHandle
activate HEC
HEC - -> HI
deactivate HEC
DS - -> DS: processDispatchResult(modelView, ...)
activate DS
DS - -> ER: modelAndView = resolveException(ex, ...)
DS - -> DS: render(modelAndView, request, response)
deactivate DS
note left
对ModelAndView进行渲染或者Exception进行处理
endnote
DS - -> HEC: triggerAfterCompletion
activate HEC
HEC - -> HI
deactivate HEC
deactivate DS
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<p>入口为<code>DispatcherServlet.doDispatch</code>，<br>大致分为几个部分：</p>
<ol>
<li>请求Handler的获取</li>
<li>调用Handler处理请求</li>
<li>使用Interceptor对请求进行拦截</li>
<li>对异常进行处理</li>
</ol>
<p>Spring MVC中的各种相关配置可参考<code>WebMvcAutoConfigurationAdapter</code>.<br>通过定义一个或者多个<code>WebMvcConfigurer</code>来扩展Spring MVC中的配置</p>
<h2 id="获取Handler"><a href="#获取Handler" class="headerlink" title="获取Handler"></a>获取Handler</h2><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="470px" preserveAspectRatio="none" style="width:1864px;height:470px;background:#FFFFFF;" version="1.1" viewBox="0 0 1864 470" width="1864px" zoomAndPan="magnify"><defs/><g><!--MD5=[e72d5bcb5f4d649d57518e519f102538]
class RequestCondition--><g id="elem_RequestCondition"><rect codeLine="1" fill="#F1F1F1" height="48" id="RequestCondition" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="158" x="1166" y="415"/><ellipse cx="1181" cy="431" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1181.9531,427.7813 L1183.6719,427.7813 C1184.0625,427.7813 1184.25,427.75 1184.375,427.6719 C1184.6406,427.5156 1184.7813,427.2344 1184.7813,426.9375 C1184.7813,426.6719 1184.6719,426.4063 1184.4375,426.2344 C1184.2656,426.125 1184.125,426.0938 1183.6719,426.0938 L1178.5313,426.0938 C1178.0938,426.0938 1177.9688,426.1094 1177.8125,426.2031 C1177.5625,426.3594 1177.4063,426.6563 1177.4063,426.9375 C1177.4063,427.2188 1177.5469,427.4688 1177.7656,427.6406 C1177.9219,427.75 1178.1094,427.7813 1178.5313,427.7813 L1180.25,427.7813 L1180.25,434.2969 L1178.5313,434.2969 C1178.0938,434.2969 1177.9688,434.3125 1177.8125,434.4219 C1177.5625,434.5781 1177.4063,434.8594 1177.4063,435.1563 C1177.4063,435.4063 1177.5469,435.6719 1177.7656,435.8281 C1177.9219,435.9531 1178.125,436 1178.5313,436 L1183.6719,436 C1184.4219,436 1184.7813,435.7188 1184.7813,435.1563 C1184.7813,434.875 1184.6719,434.625 1184.4375,434.4531 C1184.2656,434.3281 1184.125,434.2969 1183.6719,434.2969 L1181.9531,434.2969 L1181.9531,427.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="126" x="1195" y="435.8467">RequestCondition</text><line style="stroke:#181818;stroke-width:0.5;" x1="1167" x2="1323" y1="447" y2="447"/><line style="stroke:#181818;stroke-width:0.5;" x1="1167" x2="1323" y1="455" y2="455"/></g><!--MD5=[b6a55dbd034fa365d3fcc2561ad900e6]
class RequestMappingInfo--><g id="elem_RequestMappingInfo"><rect codeLine="2" fill="#F1F1F1" height="80.5938" id="RequestMappingInfo" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="588" x="951" y="273"/><ellipse cx="1166.25" cy="289" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1168.5938,284.6719 C1167.6563,284.2344 1167.0625,284.0938 1166.1875,284.0938 C1163.5625,284.0938 1161.5625,286.1719 1161.5625,288.8906 L1161.5625,290.0156 C1161.5625,292.5938 1163.6719,294.4844 1166.5625,294.4844 C1167.7813,294.4844 1168.9375,294.1875 1169.6875,293.6406 C1170.2656,293.2344 1170.5938,292.7813 1170.5938,292.3906 C1170.5938,291.9375 1170.2031,291.5469 1169.7344,291.5469 C1169.5156,291.5469 1169.3125,291.625 1169.125,291.8125 C1168.6719,292.2969 1168.6719,292.2969 1168.4844,292.3906 C1168.0625,292.6563 1167.375,292.7813 1166.6094,292.7813 C1164.5625,292.7813 1163.2656,291.6875 1163.2656,289.9844 L1163.2656,288.8906 C1163.2656,287.1094 1164.5156,285.7969 1166.25,285.7969 C1166.8281,285.7969 1167.4375,285.9531 1167.9063,286.2031 C1168.3906,286.4844 1168.5625,286.7031 1168.6563,287.1094 C1168.7188,287.5156 1168.75,287.6406 1168.8906,287.7656 C1169.0313,287.9063 1169.2656,288.0156 1169.4844,288.0156 C1169.75,288.0156 1170.0156,287.875 1170.1875,287.6563 C1170.2969,287.5 1170.3281,287.3125 1170.3281,286.8906 L1170.3281,285.4688 C1170.3281,285.0313 1170.3125,284.9063 1170.2188,284.75 C1170.0625,284.4844 1169.7813,284.3438 1169.4844,284.3438 C1169.1875,284.3438 1168.9844,284.4375 1168.7656,284.75 L1168.5938,284.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="149" x="1186.75" y="293.8467">RequestMappingInfo</text><line style="stroke:#181818;stroke-width:0.5;" x1="952" x2="1538" y1="305" y2="305"/><line style="stroke:#181818;stroke-width:0.5;" x1="952" x2="1538" y1="313" y2="313"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="576" x="957" y="329.9951">public RequestMappingInfo getMatchingCondition(HttpServletRequest request)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="569" x="957" y="346.292">public int compareTo(RequestMappingInfo other, HttpServletRequest request)</text></g><!--MD5=[d65c55f7a2ef8cbd6d0ccab92e97509e]
class HandlerMapping--><g id="elem_HandlerMapping"><rect codeLine="8" fill="#F1F1F1" height="64.2969" id="HandlerMapping" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="481" x="338.5" y="7"/><ellipse cx="515.75" cy="23" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M516.7031,19.7813 L518.4219,19.7813 C518.8125,19.7813 519,19.75 519.125,19.6719 C519.3906,19.5156 519.5313,19.2344 519.5313,18.9375 C519.5313,18.6719 519.4219,18.4063 519.1875,18.2344 C519.0156,18.125 518.875,18.0938 518.4219,18.0938 L513.2813,18.0938 C512.8438,18.0938 512.7188,18.1094 512.5625,18.2031 C512.3125,18.3594 512.1563,18.6563 512.1563,18.9375 C512.1563,19.2188 512.2969,19.4688 512.5156,19.6406 C512.6719,19.75 512.8594,19.7813 513.2813,19.7813 L515,19.7813 L515,26.2969 L513.2813,26.2969 C512.8438,26.2969 512.7188,26.3125 512.5625,26.4219 C512.3125,26.5781 512.1563,26.8594 512.1563,27.1563 C512.1563,27.4063 512.2969,27.6719 512.5156,27.8281 C512.6719,27.9531 512.875,28 513.2813,28 L518.4219,28 C519.1719,28 519.5313,27.7188 519.5313,27.1563 C519.5313,26.875 519.4219,26.625 519.1875,26.4531 C519.0156,26.3281 518.875,26.2969 518.4219,26.2969 L516.7031,26.2969 L516.7031,19.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="118" x="536.25" y="27.8467">HandlerMapping</text><line style="stroke:#181818;stroke-width:0.5;" x1="339.5" x2="818.5" y1="39" y2="39"/><line style="stroke:#181818;stroke-width:0.5;" x1="339.5" x2="818.5" y1="47" y2="47"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="469" x="344.5" y="63.9951">HandlerExecutionChain getHandler(HttpServletRequest request);</text></g><!--MD5=[1be383b504710a326997c5ba2e833ccf]
class AbstractHandlerMapping--><g id="elem_AbstractHandlerMapping"><rect codeLine="12" fill="#F1F1F1" height="64.2969" id="AbstractHandlerMapping" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="563" x="297.5" y="132"/><ellipse cx="486.25" cy="148" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M488.3281,149.8125 L488.7188,150.7969 L488.3281,150.7969 C487.875,150.7969 487.7656,150.8125 487.6094,150.9219 C487.3594,151.0781 487.2031,151.3594 487.2031,151.6563 C487.2031,151.9219 487.3438,152.1719 487.5625,152.3281 C487.7031,152.4531 487.9063,152.5 488.3281,152.5 L490.6875,152.5 C491.0469,152.5 491.2656,152.4688 491.4063,152.375 C491.6563,152.2344 491.8125,151.9375 491.8125,151.6563 C491.8125,151.375 491.6719,151.125 491.4531,150.9688 C491.2813,150.8281 491.125,150.7969 490.6563,150.7969 L487.2656,142.5938 L483.5938,142.5938 C483.1406,142.5938 483.0156,142.6094 482.8594,142.7031 C482.6094,142.875 482.4531,143.1563 482.4531,143.4375 C482.4531,143.7188 482.5938,143.9688 482.8125,144.1406 C482.9844,144.25 483.1563,144.2813 483.5938,144.2813 L484.6719,144.2813 L482.0313,150.7969 C481.6094,150.7969 481.4531,150.8125 481.2969,150.9219 C481.0469,151.0781 480.8906,151.3594 480.8906,151.6563 C480.8906,152.2188 481.2656,152.5 482.0156,152.5 L484.2813,152.5 C484.6406,152.5 484.8594,152.4688 484.9844,152.375 C485.25,152.2344 485.3906,151.9375 485.3906,151.6563 C485.3906,151.375 485.2656,151.125 485.0469,150.9531 C484.875,150.8281 484.7344,150.7969 484.2813,150.7969 L483.8906,150.7969 L484.2813,149.8125 L488.3281,149.8125 Z M487.625,148.1094 L484.9531,148.1094 L486.2969,144.8438 L487.625,148.1094 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="177" x="506.75" y="152.8467">AbstractHandlerMapping</text><line style="stroke:#181818;stroke-width:0.5;" x1="298.5" x2="859.5" y1="164" y2="164"/><line style="stroke:#181818;stroke-width:0.5;" x1="298.5" x2="859.5" y1="172" y2="172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="551" x="303.5" y="188.9951">protected abstract Object getHandlerInternal(HttpServletRequest request);</text></g><!--MD5=[395f68888fe4fcea0bba78bdc0109261]
class AbstractHandlerMethodMapping--><g id="elem_AbstractHandlerMethodMapping"><rect codeLine="15" fill="#F1F1F1" height="64.2969" id="AbstractHandlerMethodMapping" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="625" x="266.5" y="281.5"/><ellipse cx="454.25" cy="297.5" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M456.3281,299.3125 L456.7188,300.2969 L456.3281,300.2969 C455.875,300.2969 455.7656,300.3125 455.6094,300.4219 C455.3594,300.5781 455.2031,300.8594 455.2031,301.1563 C455.2031,301.4219 455.3438,301.6719 455.5625,301.8281 C455.7031,301.9531 455.9063,302 456.3281,302 L458.6875,302 C459.0469,302 459.2656,301.9688 459.4063,301.875 C459.6563,301.7344 459.8125,301.4375 459.8125,301.1563 C459.8125,300.875 459.6719,300.625 459.4531,300.4688 C459.2813,300.3281 459.125,300.2969 458.6563,300.2969 L455.2656,292.0938 L451.5938,292.0938 C451.1406,292.0938 451.0156,292.1094 450.8594,292.2031 C450.6094,292.375 450.4531,292.6563 450.4531,292.9375 C450.4531,293.2188 450.5938,293.4688 450.8125,293.6406 C450.9844,293.75 451.1563,293.7813 451.5938,293.7813 L452.6719,293.7813 L450.0313,300.2969 C449.6094,300.2969 449.4531,300.3125 449.2969,300.4219 C449.0469,300.5781 448.8906,300.8594 448.8906,301.1563 C448.8906,301.7188 449.2656,302 450.0156,302 L452.2813,302 C452.6406,302 452.8594,301.9688 452.9844,301.875 C453.25,301.7344 453.3906,301.4375 453.3906,301.1563 C453.3906,300.875 453.2656,300.625 453.0469,300.4531 C452.875,300.3281 452.7344,300.2969 452.2813,300.2969 L451.8906,300.2969 L452.2813,299.3125 L456.3281,299.3125 Z M455.625,297.6094 L452.9531,297.6094 L454.2969,294.3438 L455.625,297.6094 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="230" x="474.75" y="302.3467">AbstractHandlerMethodMapping</text><rect fill="#FFFFFF" height="15.9688" style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" width="9" x="885.5" y="278.5"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="7" x="886.5" y="290.6387">T</text><line style="stroke:#181818;stroke-width:0.5;" x1="267.5" x2="890.5" y1="313.5" y2="313.5"/><line style="stroke:#181818;stroke-width:0.5;" x1="267.5" x2="890.5" y1="321.5" y2="321.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="613" x="272.5" y="338.4951">protected abstract T getMatchingMapping(T mapping, HttpServletRequest request);</text></g><!--MD5=[def6b000f92da18b7ae05d3810212c72]
class RequestMappingHandlerMapping--><g id="elem_RequestMappingHandlerMapping"><rect codeLine="20" fill="#F1F1F1" height="48" id="RequestMappingHandlerMapping" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="270" x="99" y="415"/><ellipse cx="114" cy="431" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M116.3438,426.6719 C115.4063,426.2344 114.8125,426.0938 113.9375,426.0938 C111.3125,426.0938 109.3125,428.1719 109.3125,430.8906 L109.3125,432.0156 C109.3125,434.5938 111.4219,436.4844 114.3125,436.4844 C115.5313,436.4844 116.6875,436.1875 117.4375,435.6406 C118.0156,435.2344 118.3438,434.7813 118.3438,434.3906 C118.3438,433.9375 117.9531,433.5469 117.4844,433.5469 C117.2656,433.5469 117.0625,433.625 116.875,433.8125 C116.4219,434.2969 116.4219,434.2969 116.2344,434.3906 C115.8125,434.6563 115.125,434.7813 114.3594,434.7813 C112.3125,434.7813 111.0156,433.6875 111.0156,431.9844 L111.0156,430.8906 C111.0156,429.1094 112.2656,427.7969 114,427.7969 C114.5781,427.7969 115.1875,427.9531 115.6563,428.2031 C116.1406,428.4844 116.3125,428.7031 116.4063,429.1094 C116.4688,429.5156 116.5,429.6406 116.6406,429.7656 C116.7813,429.9063 117.0156,430.0156 117.2344,430.0156 C117.5,430.0156 117.7656,429.875 117.9375,429.6563 C118.0469,429.5 118.0781,429.3125 118.0781,428.8906 L118.0781,427.4688 C118.0781,427.0313 118.0625,426.9063 117.9688,426.75 C117.8125,426.4844 117.5313,426.3438 117.2344,426.3438 C116.9375,426.3438 116.7344,426.4375 116.5156,426.75 L116.3438,426.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="238" x="128" y="435.8467">RequestMappingHandlerMapping</text><line style="stroke:#181818;stroke-width:0.5;" x1="100" x2="368" y1="447" y2="447"/><line style="stroke:#181818;stroke-width:0.5;" x1="100" x2="368" y1="455" y2="455"/></g><!--MD5=[7124be8c614d08d4479808f506f238bd]
class MatchableHandlerMapping--><g id="elem_MatchableHandlerMapping"><rect fill="#F1F1F1" height="48" id="MatchableHandlerMapping" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="224" x="7" y="289.5"/><ellipse cx="22" cy="305.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M22.9531,302.2813 L24.6719,302.2813 C25.0625,302.2813 25.25,302.25 25.375,302.1719 C25.6406,302.0156 25.7813,301.7344 25.7813,301.4375 C25.7813,301.1719 25.6719,300.9063 25.4375,300.7344 C25.2656,300.625 25.125,300.5938 24.6719,300.5938 L19.5313,300.5938 C19.0938,300.5938 18.9688,300.6094 18.8125,300.7031 C18.5625,300.8594 18.4063,301.1563 18.4063,301.4375 C18.4063,301.7188 18.5469,301.9688 18.7656,302.1406 C18.9219,302.25 19.1094,302.2813 19.5313,302.2813 L21.25,302.2813 L21.25,308.7969 L19.5313,308.7969 C19.0938,308.7969 18.9688,308.8125 18.8125,308.9219 C18.5625,309.0781 18.4063,309.3594 18.4063,309.6563 C18.4063,309.9063 18.5469,310.1719 18.7656,310.3281 C18.9219,310.4531 19.125,310.5 19.5313,310.5 L24.6719,310.5 C25.4219,310.5 25.7813,310.2188 25.7813,309.6563 C25.7813,309.375 25.6719,309.125 25.4375,308.9531 C25.2656,308.8281 25.125,308.7969 24.6719,308.7969 L22.9531,308.7969 L22.9531,302.2813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="192" x="36" y="310.3467">MatchableHandlerMapping</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="230" y1="321.5" y2="321.5"/><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="230" y1="329.5" y2="329.5"/></g><!--MD5=[24d463dbc3bbb0274502c953bad0fc61]
class RequestMapping--><g id="elem_RequestMapping"><rect codeLine="22" fill="#F1F1F1" height="48" id="RequestMapping" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="153" x="1558.5" y="140"/><ellipse cx="1573.5" cy="156" fill="#E3664A" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1574.4219,153.25 C1572.5156,153.3906 1571.2031,154.5781 1571.2031,156.1563 C1571.2031,157.5625 1572.4063,158.7813 1573.8594,158.7813 C1574.0156,158.7813 1574.1563,158.7656 1574.4219,158.7188 L1574.4219,158.7813 L1575.2188,158.7813 C1575.8438,158.7813 1576.1563,158.5625 1576.1563,158.0781 C1576.1563,157.7969 1576.0313,157.6094 1575.7656,157.4844 L1575.7656,152.7031 C1575.7656,150.8125 1574.4531,149.4531 1572.6094,149.4531 C1570.4063,149.4531 1568.7969,151.5781 1568.7969,154.5156 L1568.7969,157.375 C1568.7969,158.625 1569.0781,159.8438 1569.5938,160.7656 C1570.3125,162.0156 1571.2344,162.5781 1572.6406,162.5781 C1574.25,162.5781 1575.6406,161.9219 1575.6406,161.125 C1575.6406,160.7344 1575.3438,160.4219 1574.9688,160.4219 C1574.7656,160.4219 1574.6719,160.4688 1574.4375,160.7188 C1574.1094,161.0469 1573.4375,161.2656 1572.6875,161.2656 C1571.9375,161.2656 1571.4063,161 1571,160.4063 C1570.4219,159.6094 1570.1406,158.5625 1570.1406,157.2656 L1570.1406,154.6094 C1570.1406,152.4375 1571.2031,150.7969 1572.6406,150.7969 C1573.6875,150.7969 1574.4219,151.5781 1574.4219,152.7031 L1574.4219,153.25 Z M1574.4219,157.3594 C1574.1875,157.4063 1574.0938,157.4063 1573.9844,157.4063 C1573.1563,157.4063 1572.5469,156.875 1572.5469,156.1719 C1572.5469,155.3438 1573.2969,154.7344 1574.4219,154.625 L1574.4219,157.3594 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="121" x="1587.5" y="160.8467">RequestMapping</text><line style="stroke:#181818;stroke-width:0.5;" x1="1559.5" x2="1710.5" y1="172" y2="172"/><line style="stroke:#181818;stroke-width:0.5;" x1="1559.5" x2="1710.5" y1="180" y2="180"/></g><!--MD5=[d9360598d9a975f3396a9e215d4b0397]
class GetMapping--><g id="elem_GetMapping"><rect codeLine="23" fill="#F1F1F1" height="48" id="GetMapping" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="121" x="1574.5" y="289.5"/><ellipse cx="1589.5" cy="305.5" fill="#E3664A" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1590.4219,302.75 C1588.5156,302.8906 1587.2031,304.0781 1587.2031,305.6563 C1587.2031,307.0625 1588.4063,308.2813 1589.8594,308.2813 C1590.0156,308.2813 1590.1563,308.2656 1590.4219,308.2188 L1590.4219,308.2813 L1591.2188,308.2813 C1591.8438,308.2813 1592.1563,308.0625 1592.1563,307.5781 C1592.1563,307.2969 1592.0313,307.1094 1591.7656,306.9844 L1591.7656,302.2031 C1591.7656,300.3125 1590.4531,298.9531 1588.6094,298.9531 C1586.4063,298.9531 1584.7969,301.0781 1584.7969,304.0156 L1584.7969,306.875 C1584.7969,308.125 1585.0781,309.3438 1585.5938,310.2656 C1586.3125,311.5156 1587.2344,312.0781 1588.6406,312.0781 C1590.25,312.0781 1591.6406,311.4219 1591.6406,310.625 C1591.6406,310.2344 1591.3438,309.9219 1590.9688,309.9219 C1590.7656,309.9219 1590.6719,309.9688 1590.4375,310.2188 C1590.1094,310.5469 1589.4375,310.7656 1588.6875,310.7656 C1587.9375,310.7656 1587.4063,310.5 1587,309.9063 C1586.4219,309.1094 1586.1406,308.0625 1586.1406,306.7656 L1586.1406,304.1094 C1586.1406,301.9375 1587.2031,300.2969 1588.6406,300.2969 C1589.6875,300.2969 1590.4219,301.0781 1590.4219,302.2031 L1590.4219,302.75 Z M1590.4219,306.8594 C1590.1875,306.9063 1590.0938,306.9063 1589.9844,306.9063 C1589.1563,306.9063 1588.5469,306.375 1588.5469,305.6719 C1588.5469,304.8438 1589.2969,304.2344 1590.4219,304.125 L1590.4219,306.8594 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1603.5" y="310.3467">GetMapping</text><line style="stroke:#181818;stroke-width:0.5;" x1="1575.5" x2="1694.5" y1="321.5" y2="321.5"/><line style="stroke:#181818;stroke-width:0.5;" x1="1575.5" x2="1694.5" y1="329.5" y2="329.5"/></g><!--MD5=[81ec404a25ab0d2c5d2b039b4644a73f]
class PostMapping--><g id="elem_PostMapping"><rect codeLine="25" fill="#F1F1F1" height="48" id="PostMapping" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="126" x="1731" y="289.5"/><ellipse cx="1746" cy="305.5" fill="#E3664A" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1746.9219,302.75 C1745.0156,302.8906 1743.7031,304.0781 1743.7031,305.6563 C1743.7031,307.0625 1744.9063,308.2813 1746.3594,308.2813 C1746.5156,308.2813 1746.6563,308.2656 1746.9219,308.2188 L1746.9219,308.2813 L1747.7188,308.2813 C1748.3438,308.2813 1748.6563,308.0625 1748.6563,307.5781 C1748.6563,307.2969 1748.5313,307.1094 1748.2656,306.9844 L1748.2656,302.2031 C1748.2656,300.3125 1746.9531,298.9531 1745.1094,298.9531 C1742.9063,298.9531 1741.2969,301.0781 1741.2969,304.0156 L1741.2969,306.875 C1741.2969,308.125 1741.5781,309.3438 1742.0938,310.2656 C1742.8125,311.5156 1743.7344,312.0781 1745.1406,312.0781 C1746.75,312.0781 1748.1406,311.4219 1748.1406,310.625 C1748.1406,310.2344 1747.8438,309.9219 1747.4688,309.9219 C1747.2656,309.9219 1747.1719,309.9688 1746.9375,310.2188 C1746.6094,310.5469 1745.9375,310.7656 1745.1875,310.7656 C1744.4375,310.7656 1743.9063,310.5 1743.5,309.9063 C1742.9219,309.1094 1742.6406,308.0625 1742.6406,306.7656 L1742.6406,304.1094 C1742.6406,301.9375 1743.7031,300.2969 1745.1406,300.2969 C1746.1875,300.2969 1746.9219,301.0781 1746.9219,302.2031 L1746.9219,302.75 Z M1746.9219,306.8594 C1746.6875,306.9063 1746.5938,306.9063 1746.4844,306.9063 C1745.6563,306.9063 1745.0469,306.375 1745.0469,305.6719 C1745.0469,304.8438 1745.7969,304.2344 1746.9219,304.125 L1746.9219,306.8594 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="94" x="1760" y="310.3467">PostMapping</text><line style="stroke:#181818;stroke-width:0.5;" x1="1732" x2="1856" y1="321.5" y2="321.5"/><line style="stroke:#181818;stroke-width:0.5;" x1="1732" x2="1856" y1="329.5" y2="329.5"/></g><!--MD5=[e47cbefee6d807553ba699a88bb4d86e]
link RequestMappingInfo to RequestCondition--><g id="link_RequestMappingInfo_RequestCondition"><path codeLine="6" d="M1245,366.256 C1245,366.256 1245,390.8594 1245,401.6083 " fill="none" id="RequestMappingInfo-RequestCondition" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="1245,414.8838,1249,405.8838,1245,409.8838,1241,405.8838,1245,414.8838" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1245" x2="1245" y1="409.8838" y2="401.8838"/><polygon fill="#181818" points="1245,354.256,1241,360.256,1245,366.256,1249,360.256,1245,354.256" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1236.3875" y="373.7534">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="7" x="1237.1031" y="403.8661">*</text></g><!--MD5=[619e1798febf98d6e2bf319d6c92d0bc]
reverse link HandlerMapping to AbstractHandlerMapping--><g id="link_HandlerMapping_AbstractHandlerMapping"><path d="M579,91.143 C579,105.005 579,119.591 579,131.972 " fill="none" id="HandlerMapping-backto-AbstractHandlerMapping" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="572,91.038,579,71.038,586,91.038,572,91.038" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[d888382aaaadfcaa69ee53034ae9562c]
reverse link AbstractHandlerMapping to AbstractHandlerMethodMapping--><g id="link_AbstractHandlerMapping_AbstractHandlerMethodMapping"><path d="M579,216.601 C579,238.159 579,262.5 579,281.264 " fill="none" id="AbstractHandlerMapping-backto-AbstractHandlerMethodMapping" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="572,216.281,579,196.281,586,216.281,572,216.281" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[0b0ae275a97aad66fe1c58f0361cc3ad]
link AbstractHandlerMethodMapping to RequestMappingInfo--><g id="link_AbstractHandlerMethodMapping_RequestMappingInfo"><path codeLine="18" d="M891.524,313.5 C909.596,313.5 927.749,313.5 945.768,313.5 " fill="none" id="AbstractHandlerMethodMapping-to-RequestMappingInfo" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="#181818" points="950.847,313.5,941.847,309.5,945.847,313.5,941.847,317.5,950.847,313.5" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="909.75" y="306.5669">use</text></g><!--MD5=[b16aa33827680880518e4071692c4e1c]
reverse link AbstractHandlerMethodMapping to RequestMappingHandlerMapping--><g id="link_AbstractHandlerMethodMapping_RequestMappingHandlerMapping"><path d="M473.485,352.271 C416.299,372.7423 347.485,397.3757 298.325,414.9737 " fill="none" id="AbstractHandlerMethodMapping-backto-RequestMappingHandlerMapping" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="471.198,345.655,492.387,345.505,475.917,358.836,471.198,345.655" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[76bbc17320ebc7594b7eab608237a93a]
reverse link MatchableHandlerMapping to RequestMappingHandlerMapping--><g id="link_MatchableHandlerMapping_RequestMappingHandlerMapping"><path d="M154.529,352.655 C173.484,373.0113 196.188,397.3935 212.466,414.8748 " fill="none" id="MatchableHandlerMapping-backto-RequestMappingHandlerMapping" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="149.137,357.137,140.631,337.729,159.383,347.596,149.137,357.137" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[4982b858b011e801f7eee28a700097b8]
reverse link RequestMapping to GetMapping--><g id="link_RequestMapping_GetMapping"><path codeLine="24" d="M1635,208.37 C1635,234.782 1635,267.494 1635,289.128 " fill="none" id="RequestMapping-backto-GetMapping" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="1628,208.047,1635,188.047,1642,208.047,1628,208.047" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[9f3a3814b57cc86af3a4a7422a3e1d71]
reverse link RequestMapping to PostMapping--><g id="link_RequestMapping_PostMapping"><path codeLine="26" d="M1674.7,201.826 C1704.29,229.275 1743.79,265.921 1769.07,289.372 " fill="none" id="RequestMapping-backto-PostMapping" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="1669.75,206.781,1659.84,188.047,1679.27,196.517,1669.75,206.781" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[9ce589bd74c7933f711f96432ebeb8a9]
link RequestMapping to RequestMappingInfo--><g id="link_RequestMapping_RequestMappingInfo"><path codeLine="28" d="M1574.06,188.047 C1515.48,210.202 1425.62,244.189 1354.59,271.051 " fill="none" id="RequestMapping-to-RequestMappingInfo" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="1349.51,272.973,1359.3433,273.526,1354.1859,271.2021,1356.5098,266.0446,1349.51,272.973" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="1464" y="239.0669">generate</text></g><!--MD5=[5e8e30b4d359070f632162c8270a2c4b]
@startuml
interface RequestCondition
class RequestMappingInfo {
  public RequestMappingInfo getMatchingCondition(HttpServletRequest request)
  public int compareTo(RequestMappingInfo other, HttpServletRequest request)
}
RequestMappingInfo "1" *- -> "*" RequestCondition

interface HandlerMapping {
  HandlerExecutionChain getHandler(HttpServletRequest request);
}

abstract class AbstractHandlerMapping implements HandlerMapping {
  protected abstract Object getHandlerInternal(HttpServletRequest request);
}
abstract class AbstractHandlerMethodMapping<T> extends AbstractHandlerMapping {
  protected abstract T getMatchingMapping(T mapping, HttpServletRequest request);
}
AbstractHandlerMethodMapping .right.> RequestMappingInfo: use

class RequestMappingHandlerMapping extends AbstractHandlerMethodMapping implements MatchableHandlerMapping 

annotation RequestMapping
annotation GetMapping
RequestMapping <|- - GetMapping
annotation PostMapping
RequestMapping <|- - PostMapping

RequestMapping - -> RequestMappingInfo: generate
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<p>通过**<em>@RequestMapping**</em>注解定义方法Handler的匹配要求，<br>生成对应的<code>RequestMappingInfo</code>和多个<code>RequestCondition</code>，<br>用于请求匹配, 匹配成功后调用对应的方法Handler。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/&#123;ping&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPingPong</span><span class="params">(<span class="meta">@PathVariable</span> String ping)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ping;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/&#123;ping&#125;&quot;, params = &quot;ex=1&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPingPongEx</span><span class="params">(<span class="meta">@PathVariable</span> String ping)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ping + <span class="string">&quot; Ex&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>DispatcherServlet::getHandler</code>用于获取请求处理链<code>HandlerExecutionChain</code>，<br>通过比较<code>RequestMappingInfo</code>和<code>RequestCondition</code>，查找最匹配的方法Handler。<br>定义的<code>RequestCondition</code>越多，则方法Handler的针对性越强；反之，则方法Handler越通用。</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="247px" preserveAspectRatio="none" style="width:550px;height:247px;background:#FFFFFF;" version="1.1" viewBox="0 0 550 247" width="550px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="111.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="124.5" y="75.4297"/><rect fill="#FFFFFF" height="34.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="129.5" y="117.5625"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="129" x2="129" y1="36.2969" y2="211.8281"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="462" x2="462" y1="36.2969" y2="211.8281"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="249" x="5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="235" x="12" y="24.9951">AbstractHandlerMethodMapping</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="249" x="5" y="210.8281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="235" x="12" y="230.8232">AbstractHandlerMethodMapping</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="381" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="149" x="388" y="24.9951">RequestMappingInfo</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="381" y="210.8281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="149" x="388" y="230.8232">RequestMappingInfo</text><rect fill="#FFFFFF" height="111.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="124.5" y="75.4297"/><rect fill="#FFFFFF" height="34.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="129.5" y="117.5625"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="129.5" x2="176.5" y1="62.4297" y2="62.4297"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="176.5" x2="176.5" y1="62.4297" y2="75.4297"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="135.5" x2="176.5" y1="75.4297" y2="75.4297"/><polygon fill="#181818" points="145.5,71.4297,135.5,75.4297,145.5,79.4297,141.5,75.4297" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="141.5" y="57.3638">lookupHandlerMethod</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="134.5" x2="181.5" y1="104.5625" y2="104.5625"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="181.5" x2="181.5" y1="104.5625" y2="117.5625"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="140.5" x2="181.5" y1="117.5625" y2="117.5625"/><polygon fill="#181818" points="150.5,113.5625,140.5,117.5625,150.5,121.5625,146.5,117.5625" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="263" x="146.5" y="99.4966">addMatchingMappings, 获取匹配的Handler</text><polygon fill="#181818" points="450.5,147.6953,460.5,151.6953,450.5,155.6953,454.5,151.6953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="134.5" x2="456.5" y1="151.6953" y2="151.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="141.5" y="146.6294">getMatchingCondition</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="134.5" x2="176.5" y1="185.8281" y2="185.8281"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="176.5" x2="176.5" y1="185.8281" y2="198.8281"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="129.5" x2="176.5" y1="198.8281" y2="198.8281"/><polygon fill="#181818" points="139.5,194.8281,129.5,198.8281,139.5,202.8281,135.5,198.8281" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="141.5" y="180.7622">SortAndGetBestMatch，从多个匹配中选取最佳匹配</text><!--MD5=[c4e054cac55cce0b81dcb0e3919bed5f]
@startuml
participant AHMM as "AbstractHandlerMethodMapping"
participant RMI as "RequestMappingInfo"

AHMM - -> AHMM: lookupHandlerMethod
activate AHMM
AHMM - -> AHMM: addMatchingMappings, 获取匹配的Handler
activate AHMM
AHMM - -> RMI: getMatchingCondition
deactivate AHMM
AHMM - -> AHMM: SortAndGetBestMatch，从多个匹配中选取最佳匹配
deactivate AHMM
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<h2 id="通过Handler处理请求"><a href="#通过Handler处理请求" class="headerlink" title="通过Handler处理请求"></a>通过Handler处理请求</h2><p><code>HandlerAdapter.handle</code>主要做以下几件事：</p>
<ul>
<li><code>HandlerMethodArgumentResolver</code>, 对输入参数进行解析</li>
<li>调用handler对请求进行处理</li>
<li><code>HandlerMethodReturnValueHandler</code>，对返回进行处理</li>
</ul>
<h3 id="基于String输入的参数解析"><a href="#基于String输入的参数解析" class="headerlink" title="基于String输入的参数解析"></a>基于String输入的参数解析</h3><p>通过<code>AbstractNamedValueMethodArgumentResolver</code>对基于String输入的参数进行解析</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="482px" preserveAspectRatio="none" style="width:2834px;height:482px;background:#FFFFFF;" version="1.1" viewBox="0 0 2834 482" width="2834px" zoomAndPan="magnify"><defs/><g><!--MD5=[f1da82a4635eabdee4fbfc24180e3445]
cluster Converters--><g id="cluster_Converters"><path d="M1076,235 L1165,235 A3.75,3.75 0 0 1 1167.5,237.5 L1174.5,257.2969 L2825,257.2969 A2.5,2.5 0 0 1 2827.5,259.7969 L2827.5,472.5 A2.5,2.5 0 0 1 2825,475 L1076,475 A2.5,2.5 0 0 1 1073.5,472.5 L1073.5,237.5 A2.5,2.5 0 0 1 1076,235 " style="stroke:#000000;stroke-width:1.5;fill:none;"/><line style="stroke:#000000;stroke-width:1.5;fill:none;" x1="1073.5" x2="1174.5" y1="257.2969" y2="257.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="88" x="1077.5" y="249.9951">Converters</text></g><!--MD5=[a5e1efb41a8b1b75d642f72b85eed865]
class GenericConverter--><g id="elem_GenericConverter"><rect codeLine="2" fill="#F1F1F1" height="64.2969" id="GenericConverter" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="726" x="2077.5" y="278"/><ellipse cx="2372.75" cy="294" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M2373.7031,290.7813 L2375.4219,290.7813 C2375.8125,290.7813 2376,290.75 2376.125,290.6719 C2376.3906,290.5156 2376.5313,290.2344 2376.5313,289.9375 C2376.5313,289.6719 2376.4219,289.4063 2376.1875,289.2344 C2376.0156,289.125 2375.875,289.0938 2375.4219,289.0938 L2370.2813,289.0938 C2369.8438,289.0938 2369.7188,289.1094 2369.5625,289.2031 C2369.3125,289.3594 2369.1563,289.6563 2369.1563,289.9375 C2369.1563,290.2188 2369.2969,290.4688 2369.5156,290.6406 C2369.6719,290.75 2369.8594,290.7813 2370.2813,290.7813 L2372,290.7813 L2372,297.2969 L2370.2813,297.2969 C2369.8438,297.2969 2369.7188,297.3125 2369.5625,297.4219 C2369.3125,297.5781 2369.1563,297.8594 2369.1563,298.1563 C2369.1563,298.4063 2369.2969,298.6719 2369.5156,298.8281 C2369.6719,298.9531 2369.875,299 2370.2813,299 L2375.4219,299 C2376.1719,299 2376.5313,298.7188 2376.5313,298.1563 C2376.5313,297.875 2376.4219,297.625 2376.1875,297.4531 C2376.0156,297.3281 2375.875,297.2969 2375.4219,297.2969 L2373.7031,297.2969 L2373.7031,290.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="127" x="2393.25" y="298.8467">GenericConverter</text><line style="stroke:#181818;stroke-width:0.5;" x1="2078.5" x2="2802.5" y1="310" y2="310"/><line style="stroke:#181818;stroke-width:0.5;" x1="2078.5" x2="2802.5" y1="318" y2="318"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="714" x="2083.5" y="334.9951">Object convert(@Nullable Object source, TypeDescriptor sourceType, TypeDescriptor targetType);</text></g><!--MD5=[0ebf3a0931d150882cc1e7ba90c00938]
class Converter--><g id="elem_Converter"><rect codeLine="5" fill="#F1F1F1" height="64.2969" id="Converter" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="156" x="1886.5" y="278"/><ellipse cx="1913.2" cy="294" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1914.1531,290.7813 L1915.8719,290.7813 C1916.2625,290.7813 1916.45,290.75 1916.575,290.6719 C1916.8406,290.5156 1916.9813,290.2344 1916.9813,289.9375 C1916.9813,289.6719 1916.8719,289.4063 1916.6375,289.2344 C1916.4656,289.125 1916.325,289.0938 1915.8719,289.0938 L1910.7313,289.0938 C1910.2938,289.0938 1910.1688,289.1094 1910.0125,289.2031 C1909.7625,289.3594 1909.6063,289.6563 1909.6063,289.9375 C1909.6063,290.2188 1909.7469,290.4688 1909.9656,290.6406 C1910.1219,290.75 1910.3094,290.7813 1910.7313,290.7813 L1912.45,290.7813 L1912.45,297.2969 L1910.7313,297.2969 C1910.2938,297.2969 1910.1688,297.3125 1910.0125,297.4219 C1909.7625,297.5781 1909.6063,297.8594 1909.6063,298.1563 C1909.6063,298.4063 1909.7469,298.6719 1909.9656,298.8281 C1910.1219,298.9531 1910.325,299 1910.7313,299 L1915.8719,299 C1916.6219,299 1916.9813,298.7188 1916.9813,298.1563 C1916.9813,297.875 1916.8719,297.625 1916.6375,297.4531 C1916.4656,297.3281 1916.325,297.2969 1915.8719,297.2969 L1914.1531,297.2969 L1914.1531,290.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="71" x="1929.8" y="298.8467">Converter</text><rect fill="#FFFFFF" height="15.9688" style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" width="25" x="2020.5" y="275"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="23" x="2021.5" y="287.1387">S, T</text><line style="stroke:#181818;stroke-width:0.5;" x1="1887.5" x2="2041.5" y1="310" y2="310"/><line style="stroke:#181818;stroke-width:0.5;" x1="1887.5" x2="2041.5" y1="318" y2="318"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="144" x="1892.5" y="334.9951">T convert(S source);</text></g><!--MD5=[69f2f3ad3645114d26612368d508f737]
class Printer--><g id="elem_Printer"><rect codeLine="8" fill="#F1F1F1" height="64.2969" id="Printer" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="271" x="1580" y="278"/><ellipse cx="1682.25" cy="294" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1683.2031,290.7813 L1684.9219,290.7813 C1685.3125,290.7813 1685.5,290.75 1685.625,290.6719 C1685.8906,290.5156 1686.0313,290.2344 1686.0313,289.9375 C1686.0313,289.6719 1685.9219,289.4063 1685.6875,289.2344 C1685.5156,289.125 1685.375,289.0938 1684.9219,289.0938 L1679.7813,289.0938 C1679.3438,289.0938 1679.2188,289.1094 1679.0625,289.2031 C1678.8125,289.3594 1678.6563,289.6563 1678.6563,289.9375 C1678.6563,290.2188 1678.7969,290.4688 1679.0156,290.6406 C1679.1719,290.75 1679.3594,290.7813 1679.7813,290.7813 L1681.5,290.7813 L1681.5,297.2969 L1679.7813,297.2969 C1679.3438,297.2969 1679.2188,297.3125 1679.0625,297.4219 C1678.8125,297.5781 1678.6563,297.8594 1678.6563,298.1563 C1678.6563,298.4063 1678.7969,298.6719 1679.0156,298.8281 C1679.1719,298.9531 1679.375,299 1679.7813,299 L1684.9219,299 C1685.6719,299 1686.0313,298.7188 1686.0313,298.1563 C1686.0313,297.875 1685.9219,297.625 1685.6875,297.4531 C1685.5156,297.3281 1685.375,297.2969 1684.9219,297.2969 L1683.2031,297.2969 L1683.2031,290.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="47" x="1702.75" y="298.8467">Printer</text><rect fill="#FFFFFF" height="15.9688" style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" width="9" x="1845" y="275"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="7" x="1846" y="287.1387">T</text><line style="stroke:#181818;stroke-width:0.5;" x1="1581" x2="1850" y1="310" y2="310"/><line style="stroke:#181818;stroke-width:0.5;" x1="1581" x2="1850" y1="318" y2="318"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="259" x="1586" y="334.9951">String print(T object, Locale locale);</text></g><!--MD5=[628cc5a2753cca06eb1ffef55c386535]
class Parser--><g id="elem_Parser"><rect codeLine="11" fill="#F1F1F1" height="64.2969" id="Parser" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="428" x="1116.5" y="278"/><ellipse cx="1298.25" cy="294" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1299.2031,290.7813 L1300.9219,290.7813 C1301.3125,290.7813 1301.5,290.75 1301.625,290.6719 C1301.8906,290.5156 1302.0313,290.2344 1302.0313,289.9375 C1302.0313,289.6719 1301.9219,289.4063 1301.6875,289.2344 C1301.5156,289.125 1301.375,289.0938 1300.9219,289.0938 L1295.7813,289.0938 C1295.3438,289.0938 1295.2188,289.1094 1295.0625,289.2031 C1294.8125,289.3594 1294.6563,289.6563 1294.6563,289.9375 C1294.6563,290.2188 1294.7969,290.4688 1295.0156,290.6406 C1295.1719,290.75 1295.3594,290.7813 1295.7813,290.7813 L1297.5,290.7813 L1297.5,297.2969 L1295.7813,297.2969 C1295.3438,297.2969 1295.2188,297.3125 1295.0625,297.4219 C1294.8125,297.5781 1294.6563,297.8594 1294.6563,298.1563 C1294.6563,298.4063 1294.7969,298.6719 1295.0156,298.8281 C1295.1719,298.9531 1295.375,299 1295.7813,299 L1300.9219,299 C1301.6719,299 1302.0313,298.7188 1302.0313,298.1563 C1302.0313,297.875 1301.9219,297.625 1301.6875,297.4531 C1301.5156,297.3281 1301.375,297.2969 1300.9219,297.2969 L1299.2031,297.2969 L1299.2031,290.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="45" x="1318.75" y="298.8467">Parser</text><rect fill="#FFFFFF" height="15.9688" style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" width="9" x="1538.5" y="275"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="7" x="1539.5" y="287.1387">T</text><line style="stroke:#181818;stroke-width:0.5;" x1="1117.5" x2="1543.5" y1="310" y2="310"/><line style="stroke:#181818;stroke-width:0.5;" x1="1117.5" x2="1543.5" y1="318" y2="318"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="416" x="1122.5" y="334.9951">T parse(String text, Locale locale) throws ParseException;</text></g><!--MD5=[421e83b89ab430df872815c38880533e]
class Formatter--><g id="elem_Formatter"><rect codeLine="15" fill="#F1F1F1" height="48" id="Formatter" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="114" x="1465.5" y="403"/><ellipse cx="1480.5" cy="419" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1481.4531,415.7813 L1483.1719,415.7813 C1483.5625,415.7813 1483.75,415.75 1483.875,415.6719 C1484.1406,415.5156 1484.2813,415.2344 1484.2813,414.9375 C1484.2813,414.6719 1484.1719,414.4063 1483.9375,414.2344 C1483.7656,414.125 1483.625,414.0938 1483.1719,414.0938 L1478.0313,414.0938 C1477.5938,414.0938 1477.4688,414.1094 1477.3125,414.2031 C1477.0625,414.3594 1476.9063,414.6563 1476.9063,414.9375 C1476.9063,415.2188 1477.0469,415.4688 1477.2656,415.6406 C1477.4219,415.75 1477.6094,415.7813 1478.0313,415.7813 L1479.75,415.7813 L1479.75,422.2969 L1478.0313,422.2969 C1477.5938,422.2969 1477.4688,422.3125 1477.3125,422.4219 C1477.0625,422.5781 1476.9063,422.8594 1476.9063,423.1563 C1476.9063,423.4063 1477.0469,423.6719 1477.2656,423.8281 C1477.4219,423.9531 1477.625,424 1478.0313,424 L1483.1719,424 C1483.9219,424 1484.2813,423.7188 1484.2813,423.1563 C1484.2813,422.875 1484.1719,422.625 1483.9375,422.4531 C1483.7656,422.3281 1483.625,422.2969 1483.1719,422.2969 L1481.4531,422.2969 L1481.4531,415.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="71" x="1494.5" y="423.8467">Formatter</text><rect fill="#FFFFFF" height="15.9688" style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" width="9" x="1573.5" y="400"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="7" x="1574.5" y="412.1387">T</text><line style="stroke:#181818;stroke-width:0.5;" x1="1466.5" x2="1578.5" y1="435" y2="435"/><line style="stroke:#181818;stroke-width:0.5;" x1="1466.5" x2="1578.5" y1="443" y2="443"/></g><!--MD5=[1ef6ff702038bb2a7c524a79ff57aceb]
class AbstractNamedValueMethodArgumentResolver--><g id="elem_AbstractNamedValueMethodArgumentResolver"><rect codeLine="18" fill="#F1F1F1" height="48" id="AbstractNamedValueMethodArgumentResolver" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="369" x="528" y="116"/><ellipse cx="543" cy="132" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M545.0781,133.8125 L545.4688,134.7969 L545.0781,134.7969 C544.625,134.7969 544.5156,134.8125 544.3594,134.9219 C544.1094,135.0781 543.9531,135.3594 543.9531,135.6563 C543.9531,135.9219 544.0938,136.1719 544.3125,136.3281 C544.4531,136.4531 544.6563,136.5 545.0781,136.5 L547.4375,136.5 C547.7969,136.5 548.0156,136.4688 548.1563,136.375 C548.4063,136.2344 548.5625,135.9375 548.5625,135.6563 C548.5625,135.375 548.4219,135.125 548.2031,134.9688 C548.0313,134.8281 547.875,134.7969 547.4063,134.7969 L544.0156,126.5938 L540.3438,126.5938 C539.8906,126.5938 539.7656,126.6094 539.6094,126.7031 C539.3594,126.875 539.2031,127.1563 539.2031,127.4375 C539.2031,127.7188 539.3438,127.9688 539.5625,128.1406 C539.7344,128.25 539.9063,128.2813 540.3438,128.2813 L541.4219,128.2813 L538.7813,134.7969 C538.3594,134.7969 538.2031,134.8125 538.0469,134.9219 C537.7969,135.0781 537.6406,135.3594 537.6406,135.6563 C537.6406,136.2188 538.0156,136.5 538.7656,136.5 L541.0313,136.5 C541.3906,136.5 541.6094,136.4688 541.7344,136.375 C542,136.2344 542.1406,135.9375 542.1406,135.6563 C542.1406,135.375 542.0156,135.125 541.7969,134.9531 C541.625,134.8281 541.4844,134.7969 541.0313,134.7969 L540.6406,134.7969 L541.0313,133.8125 L545.0781,133.8125 Z M544.375,132.1094 L541.7031,132.1094 L543.0469,128.8438 L544.375,132.1094 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="337" x="557" y="136.8467">AbstractNamedValueMethodArgumentResolver</text><line style="stroke:#181818;stroke-width:0.5;" x1="529" x2="896" y1="148" y2="148"/><line style="stroke:#181818;stroke-width:0.5;" x1="529" x2="896" y1="156" y2="156"/></g><!--MD5=[b38238462848835b2e145e9cc1dad52a]
class HandlerMethodArgumentResolver--><g id="elem_HandlerMethodArgumentResolver"><rect fill="#F1F1F1" height="48" id="HandlerMethodArgumentResolver" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="275" x="575" y="7"/><ellipse cx="590" cy="23" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M590.9531,19.7813 L592.6719,19.7813 C593.0625,19.7813 593.25,19.75 593.375,19.6719 C593.6406,19.5156 593.7813,19.2344 593.7813,18.9375 C593.7813,18.6719 593.6719,18.4063 593.4375,18.2344 C593.2656,18.125 593.125,18.0938 592.6719,18.0938 L587.5313,18.0938 C587.0938,18.0938 586.9688,18.1094 586.8125,18.2031 C586.5625,18.3594 586.4063,18.6563 586.4063,18.9375 C586.4063,19.2188 586.5469,19.4688 586.7656,19.6406 C586.9219,19.75 587.1094,19.7813 587.5313,19.7813 L589.25,19.7813 L589.25,26.2969 L587.5313,26.2969 C587.0938,26.2969 586.9688,26.3125 586.8125,26.4219 C586.5625,26.5781 586.4063,26.8594 586.4063,27.1563 C586.4063,27.4063 586.5469,27.6719 586.7656,27.8281 C586.9219,27.9531 587.125,28 587.5313,28 L592.6719,28 C593.4219,28 593.7813,27.7188 593.7813,27.1563 C593.7813,26.875 593.6719,26.625 593.4375,26.4531 C593.2656,26.3281 593.125,26.2969 592.6719,26.2969 L590.9531,26.2969 L590.9531,19.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="243" x="604" y="27.8467">HandlerMethodArgumentResolver</text><line style="stroke:#181818;stroke-width:0.5;" x1="576" x2="849" y1="39" y2="39"/><line style="stroke:#181818;stroke-width:0.5;" x1="576" x2="849" y1="47" y2="47"/></g><!--MD5=[b502ff35c519d753d2666e8cc5092f03]
class RequestHeaderMethodArgumentResolver--><g id="elem_RequestHeaderMethodArgumentResolver"><rect codeLine="21" fill="#F1F1F1" height="48" id="RequestHeaderMethodArgumentResolver" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="331" x="7" y="286"/><ellipse cx="22" cy="302" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M24.3438,297.6719 C23.4063,297.2344 22.8125,297.0938 21.9375,297.0938 C19.3125,297.0938 17.3125,299.1719 17.3125,301.8906 L17.3125,303.0156 C17.3125,305.5938 19.4219,307.4844 22.3125,307.4844 C23.5313,307.4844 24.6875,307.1875 25.4375,306.6406 C26.0156,306.2344 26.3438,305.7813 26.3438,305.3906 C26.3438,304.9375 25.9531,304.5469 25.4844,304.5469 C25.2656,304.5469 25.0625,304.625 24.875,304.8125 C24.4219,305.2969 24.4219,305.2969 24.2344,305.3906 C23.8125,305.6563 23.125,305.7813 22.3594,305.7813 C20.3125,305.7813 19.0156,304.6875 19.0156,302.9844 L19.0156,301.8906 C19.0156,300.1094 20.2656,298.7969 22,298.7969 C22.5781,298.7969 23.1875,298.9531 23.6563,299.2031 C24.1406,299.4844 24.3125,299.7031 24.4063,300.1094 C24.4688,300.5156 24.5,300.6406 24.6406,300.7656 C24.7813,300.9063 25.0156,301.0156 25.2344,301.0156 C25.5,301.0156 25.7656,300.875 25.9375,300.6563 C26.0469,300.5 26.0781,300.3125 26.0781,299.8906 L26.0781,298.4688 C26.0781,298.0313 26.0625,297.9063 25.9688,297.75 C25.8125,297.4844 25.5313,297.3438 25.2344,297.3438 C24.9375,297.3438 24.7344,297.4375 24.5156,297.75 L24.3438,297.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="299" x="36" y="306.8467">RequestHeaderMethodArgumentResolver</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="337" y1="318" y2="318"/><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="337" y1="326" y2="326"/></g><!--MD5=[ee0ad4f0c2466166b43f75cb79433c5c]
class RequestParamMethodArgumentResolver--><g id="elem_RequestParamMethodArgumentResolver"><rect codeLine="22" fill="#F1F1F1" height="48" id="RequestParamMethodArgumentResolver" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="325" x="373" y="286"/><ellipse cx="388" cy="302" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M390.3438,297.6719 C389.4063,297.2344 388.8125,297.0938 387.9375,297.0938 C385.3125,297.0938 383.3125,299.1719 383.3125,301.8906 L383.3125,303.0156 C383.3125,305.5938 385.4219,307.4844 388.3125,307.4844 C389.5313,307.4844 390.6875,307.1875 391.4375,306.6406 C392.0156,306.2344 392.3438,305.7813 392.3438,305.3906 C392.3438,304.9375 391.9531,304.5469 391.4844,304.5469 C391.2656,304.5469 391.0625,304.625 390.875,304.8125 C390.4219,305.2969 390.4219,305.2969 390.2344,305.3906 C389.8125,305.6563 389.125,305.7813 388.3594,305.7813 C386.3125,305.7813 385.0156,304.6875 385.0156,302.9844 L385.0156,301.8906 C385.0156,300.1094 386.2656,298.7969 388,298.7969 C388.5781,298.7969 389.1875,298.9531 389.6563,299.2031 C390.1406,299.4844 390.3125,299.7031 390.4063,300.1094 C390.4688,300.5156 390.5,300.6406 390.6406,300.7656 C390.7813,300.9063 391.0156,301.0156 391.2344,301.0156 C391.5,301.0156 391.7656,300.875 391.9375,300.6563 C392.0469,300.5 392.0781,300.3125 392.0781,299.8906 L392.0781,298.4688 C392.0781,298.0313 392.0625,297.9063 391.9688,297.75 C391.8125,297.4844 391.5313,297.3438 391.2344,297.3438 C390.9375,297.3438 390.7344,297.4375 390.5156,297.75 L390.3438,297.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="293" x="402" y="306.8467">RequestParamMethodArgumentResolver</text><line style="stroke:#181818;stroke-width:0.5;" x1="374" x2="697" y1="318" y2="318"/><line style="stroke:#181818;stroke-width:0.5;" x1="374" x2="697" y1="326" y2="326"/></g><!--MD5=[dd7c5ef057e3b4909acb0bce3bc133b6]
class PathVariableMethodArgumentResolver--><g id="elem_PathVariableMethodArgumentResolver"><rect codeLine="23" fill="#F1F1F1" height="48" id="PathVariableMethodArgumentResolver" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="313" x="733" y="286"/><ellipse cx="748" cy="302" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M750.3438,297.6719 C749.4063,297.2344 748.8125,297.0938 747.9375,297.0938 C745.3125,297.0938 743.3125,299.1719 743.3125,301.8906 L743.3125,303.0156 C743.3125,305.5938 745.4219,307.4844 748.3125,307.4844 C749.5313,307.4844 750.6875,307.1875 751.4375,306.6406 C752.0156,306.2344 752.3438,305.7813 752.3438,305.3906 C752.3438,304.9375 751.9531,304.5469 751.4844,304.5469 C751.2656,304.5469 751.0625,304.625 750.875,304.8125 C750.4219,305.2969 750.4219,305.2969 750.2344,305.3906 C749.8125,305.6563 749.125,305.7813 748.3594,305.7813 C746.3125,305.7813 745.0156,304.6875 745.0156,302.9844 L745.0156,301.8906 C745.0156,300.1094 746.2656,298.7969 748,298.7969 C748.5781,298.7969 749.1875,298.9531 749.6563,299.2031 C750.1406,299.4844 750.3125,299.7031 750.4063,300.1094 C750.4688,300.5156 750.5,300.6406 750.6406,300.7656 C750.7813,300.9063 751.0156,301.0156 751.2344,301.0156 C751.5,301.0156 751.7656,300.875 751.9375,300.6563 C752.0469,300.5 752.0781,300.3125 752.0781,299.8906 L752.0781,298.4688 C752.0781,298.0313 752.0625,297.9063 751.9688,297.75 C751.8125,297.4844 751.5313,297.3438 751.2344,297.3438 C750.9375,297.3438 750.7344,297.4375 750.5156,297.75 L750.3438,297.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="281" x="762" y="306.8467">PathVariableMethodArgumentResolver</text><line style="stroke:#181818;stroke-width:0.5;" x1="734" x2="1045" y1="318" y2="318"/><line style="stroke:#181818;stroke-width:0.5;" x1="734" x2="1045" y1="326" y2="326"/></g><!--MD5=[aef03ce12ce517cf796635164b8545b3]
reverse link Printer to Formatter--><g id="link_Printer_Formatter"><path d="M1646.05,352.381 C1617.52,369.381 1585.56,388.424 1561.3,402.8836 " fill="none" id="Printer-backto-Formatter" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="1642.51,346.345,1663.27,342.121,1649.67,358.372,1642.51,346.345" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[35de41f9898cd2eb6dfcc2ad7b205497]
reverse link Parser to Formatter--><g id="link_Parser_Formatter"><path d="M1399.99,352.622 C1428.27,369.56 1459.88,388.493 1483.91,402.8836 " fill="none" id="Parser-backto-Formatter" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="1396.02,358.403,1382.46,342.121,1403.21,346.392,1396.02,358.403" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[5ecae0d47b0e6c61b8fac7bbcc9773c4]
reverse link HandlerMethodArgumentResolver to AbstractNamedValueMethodArgumentResolver--><g id="link_HandlerMethodArgumentResolver_AbstractNamedValueMethodArgumentResolver"><path d="M712.5,75.578 C712.5,89.362 712.5,104.057 712.5,115.828 " fill="none" id="HandlerMethodArgumentResolver-backto-AbstractNamedValueMethodArgumentResolver" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="705.5,75.217,712.5,55.217,719.5,75.217,705.5,75.217" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[c3bc5aa4b2f447f49e30e3241ac583c7]
link AbstractNamedValueMethodArgumentResolver to Converters--><g id="link_AbstractNamedValueMethodArgumentResolver_Converters"><path codeLine="19" d="M897.045,163.48 C968.491,175.887 1038.99,193.964 1063.5,219 C1067.0113,222.5868 1069.9309,226.6535 1072.3515,231.0277 C1072.9566,232.1213 1073.5306,233.2341 1074.0747,234.3634 C1074.1428,234.5046 1074.2103,234.646 1074.2774,234.7877 " fill="none" id="AbstractNamedValueMethodArgumentResolver-to-Converters" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="#181818" points="1074.2774,234.7877,1074.0403,224.9417,1072.1373,230.2688,1066.8102,228.3658,1074.2774,234.7877" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="1052.5" y="207.0669">use</text></g><!--MD5=[b941df6570803fb7ac10ac628d615327]
reverse link AbstractNamedValueMethodArgumentResolver to RequestHeaderMethodArgumentResolver--><g id="link_AbstractNamedValueMethodArgumentResolver_RequestHeaderMethodArgumentResolver"><path d="M549.85,167.91 C488.073,180.363 417.649,197.289 355.5,219 C304.194,236.923 248.621,265.711 212.344,285.889 " fill="none" id="AbstractNamedValueMethodArgumentResolver-backto-RequestHeaderMethodArgumentResolver" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="548.607,161.02,569.582,164.023,551.312,174.756,548.607,161.02" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[e7e82f5f12f7cde2333fb421749772a8]
reverse link AbstractNamedValueMethodArgumentResolver to RequestParamMethodArgumentResolver--><g id="link_AbstractNamedValueMethodArgumentResolver_RequestParamMethodArgumentResolver"><path d="M673.529,177.99 C638.908,210.85 589.371,257.868 560.015,285.731 " fill="none" id="AbstractNamedValueMethodArgumentResolver-backto-RequestParamMethodArgumentResolver" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="668.935,172.699,688.26,164.007,678.573,182.853,668.935,172.699" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[06c894191efa89a483df0ed233bfc813]
reverse link AbstractNamedValueMethodArgumentResolver to PathVariableMethodArgumentResolver--><g id="link_AbstractNamedValueMethodArgumentResolver_PathVariableMethodArgumentResolver"><path d="M751.471,177.99 C786.092,210.85 835.629,257.868 864.985,285.731 " fill="none" id="AbstractNamedValueMethodArgumentResolver-backto-PathVariableMethodArgumentResolver" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="746.427,182.853,736.74,164.007,756.065,172.699,746.427,182.853" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[6347752055920d6c591cb4cddf189c65]
@startuml
package Converters {
interface GenericConverter {
  Object convert(@Nullable Object source, TypeDescriptor sourceType, TypeDescriptor targetType);
}
interface Converter<S, T> {
  T convert(S source);
}
interface Printer<T> {
  String print(T object, Locale locale);
}
interface Parser<T> {
  T parse(String text, Locale locale) throws ParseException;
}

interface Formatter<T> extends Printer, Parser
}

abstract class AbstractNamedValueMethodArgumentResolver implements HandlerMethodArgumentResolver
AbstractNamedValueMethodArgumentResolver ..> Converters: use

class RequestHeaderMethodArgumentResolver extends AbstractNamedValueMethodArgumentResolver
class RequestParamMethodArgumentResolver extends AbstractNamedValueMethodArgumentResolver
class PathVariableMethodArgumentResolver extends AbstractNamedValueMethodArgumentResolver
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<p>通过定义Converters中的bean，就可以在启动时<br>通过<code>WebMvcAutoConfigurationAdapter#addFormatters</code>添加进来，<br>用于AbstractNamedValueMethodArgumentResolver的输入类型转换。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Money.java</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Money</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String currency = <span class="string">&quot;CNY&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currency + <span class="string">&quot; &quot;</span> + value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MoneyFormatter.java</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MoneyFormatter</span> <span class="keyword">implements</span> <span class="title">Formatter</span>&lt;<span class="title">Money</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Money <span class="title">parse</span><span class="params">(String text, Locale locale)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        String[] input = text.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        Money money = <span class="keyword">new</span> Money();</span><br><span class="line">        <span class="keyword">if</span> (input.length == <span class="number">1</span>) &#123;</span><br><span class="line">            money.setValue(input[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            money.setCurrency(input[<span class="number">0</span>]);</span><br><span class="line">            money.setValue(input[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">print</span><span class="params">(Money object, Locale locale)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> object.getCurrency()</span><br><span class="line">                + <span class="string">&quot; &quot;</span> + object.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IndexController.java</span></span><br><span class="line"><span class="meta">@GetMapping(value = &quot;/price&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Money <span class="title">price</span><span class="params">(<span class="meta">@RequestParam</span> Money money)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> money;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="针对Body的输入和输出处理"><a href="#针对Body的输入和输出处理" class="headerlink" title="针对Body的输入和输出处理"></a>针对Body的输入和输出处理</h3><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="436px" preserveAspectRatio="none" style="width:1489px;height:436px;background:#FFFFFF;" version="1.1" viewBox="0 0 1489 436" width="1489px" zoomAndPan="magnify"><defs/><g><!--MD5=[1d91eed7819057781ce772eca6975836]
cluster Input--><g id="cluster_Input"><path d="M236,6 L280,6 A3.75,3.75 0 0 1 282.5,8.5 L289.5,28.2969 L1078,28.2969 A2.5,2.5 0 0 1 1080.5,30.7969 L1080.5,210.5 A2.5,2.5 0 0 1 1078,213 L236,213 A2.5,2.5 0 0 1 233.5,210.5 L233.5,8.5 A2.5,2.5 0 0 1 236,6 " style="stroke:#000000;stroke-width:1.5;fill:none;"/><line style="stroke:#000000;stroke-width:1.5;fill:none;" x1="233.5" x2="289.5" y1="28.2969" y2="28.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="43" x="237.5" y="20.9951">Input</text></g><!--MD5=[43acc1a5bbd009f26b899c423c01b543]
cluster Output--><g id="cluster_Output"><path d="M1107,114 L1166,114 A3.75,3.75 0 0 1 1168.5,116.5 L1175.5,136.2969 L1480,136.2969 A2.5,2.5 0 0 1 1482.5,138.7969 L1482.5,426.5 A2.5,2.5 0 0 1 1480,429 L1107,429 A2.5,2.5 0 0 1 1104.5,426.5 L1104.5,116.5 A2.5,2.5 0 0 1 1107,114 " style="stroke:#000000;stroke-width:1.5;fill:none;"/><line style="stroke:#000000;stroke-width:1.5;fill:none;" x1="1104.5" x2="1175.5" y1="136.2969" y2="136.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="58" x="1108.5" y="128.9951">Output</text></g><!--MD5=[b38238462848835b2e145e9cc1dad52a]
class HandlerMethodArgumentResolver--><g id="elem_HandlerMethodArgumentResolver"><rect codeLine="2" fill="#F1F1F1" height="48" id="HandlerMethodArgumentResolver" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="275" x="529" y="41"/><ellipse cx="544" cy="57" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M544.9531,53.7813 L546.6719,53.7813 C547.0625,53.7813 547.25,53.75 547.375,53.6719 C547.6406,53.5156 547.7813,53.2344 547.7813,52.9375 C547.7813,52.6719 547.6719,52.4063 547.4375,52.2344 C547.2656,52.125 547.125,52.0938 546.6719,52.0938 L541.5313,52.0938 C541.0938,52.0938 540.9688,52.1094 540.8125,52.2031 C540.5625,52.3594 540.4063,52.6563 540.4063,52.9375 C540.4063,53.2188 540.5469,53.4688 540.7656,53.6406 C540.9219,53.75 541.1094,53.7813 541.5313,53.7813 L543.25,53.7813 L543.25,60.2969 L541.5313,60.2969 C541.0938,60.2969 540.9688,60.3125 540.8125,60.4219 C540.5625,60.5781 540.4063,60.8594 540.4063,61.1563 C540.4063,61.4063 540.5469,61.6719 540.7656,61.8281 C540.9219,61.9531 541.125,62 541.5313,62 L546.6719,62 C547.4219,62 547.7813,61.7188 547.7813,61.1563 C547.7813,60.875 547.6719,60.625 547.4375,60.4531 C547.2656,60.3281 547.125,60.2969 546.6719,60.2969 L544.9531,60.2969 L544.9531,53.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="243" x="558" y="61.8467">HandlerMethodArgumentResolver</text><line style="stroke:#181818;stroke-width:0.5;" x1="530" x2="803" y1="73" y2="73"/><line style="stroke:#181818;stroke-width:0.5;" x1="530" x2="803" y1="81" y2="81"/></g><!--MD5=[9e6cbd34aaa92a22d4752322fbdd4b18]
class AbstractMessageConverterMethodArgumentResolver--><g id="elem_AbstractMessageConverterMethodArgumentResolver"><rect codeLine="4" fill="#F1F1F1" height="48" id="AbstractMessageConverterMethodArgumentResolver" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="410" x="249.5" y="149"/><ellipse cx="264.5" cy="165" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M266.5781,166.8125 L266.9688,167.7969 L266.5781,167.7969 C266.125,167.7969 266.0156,167.8125 265.8594,167.9219 C265.6094,168.0781 265.4531,168.3594 265.4531,168.6563 C265.4531,168.9219 265.5938,169.1719 265.8125,169.3281 C265.9531,169.4531 266.1563,169.5 266.5781,169.5 L268.9375,169.5 C269.2969,169.5 269.5156,169.4688 269.6563,169.375 C269.9063,169.2344 270.0625,168.9375 270.0625,168.6563 C270.0625,168.375 269.9219,168.125 269.7031,167.9688 C269.5313,167.8281 269.375,167.7969 268.9063,167.7969 L265.5156,159.5938 L261.8438,159.5938 C261.3906,159.5938 261.2656,159.6094 261.1094,159.7031 C260.8594,159.875 260.7031,160.1563 260.7031,160.4375 C260.7031,160.7188 260.8438,160.9688 261.0625,161.1406 C261.2344,161.25 261.4063,161.2813 261.8438,161.2813 L262.9219,161.2813 L260.2813,167.7969 C259.8594,167.7969 259.7031,167.8125 259.5469,167.9219 C259.2969,168.0781 259.1406,168.3594 259.1406,168.6563 C259.1406,169.2188 259.5156,169.5 260.2656,169.5 L262.5313,169.5 C262.8906,169.5 263.1094,169.4688 263.2344,169.375 C263.5,169.2344 263.6406,168.9375 263.6406,168.6563 C263.6406,168.375 263.5156,168.125 263.2969,167.9531 C263.125,167.8281 262.9844,167.7969 262.5313,167.7969 L262.1406,167.7969 L262.5313,166.8125 L266.5781,166.8125 Z M265.875,165.1094 L263.2031,165.1094 L264.5469,161.8438 L265.875,165.1094 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="378" x="278.5" y="169.8467">AbstractMessageConverterMethodArgumentResolver</text><line style="stroke:#181818;stroke-width:0.5;" x1="250.5" x2="658.5" y1="181" y2="181"/><line style="stroke:#181818;stroke-width:0.5;" x1="250.5" x2="658.5" y1="189" y2="189"/></g><!--MD5=[1ef6ff702038bb2a7c524a79ff57aceb]
class AbstractNamedValueMethodArgumentResolver--><g id="elem_AbstractNamedValueMethodArgumentResolver"><rect codeLine="6" fill="#F1F1F1" height="48" id="AbstractNamedValueMethodArgumentResolver" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="369" x="695" y="149"/><ellipse cx="710" cy="165" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M712.0781,166.8125 L712.4688,167.7969 L712.0781,167.7969 C711.625,167.7969 711.5156,167.8125 711.3594,167.9219 C711.1094,168.0781 710.9531,168.3594 710.9531,168.6563 C710.9531,168.9219 711.0938,169.1719 711.3125,169.3281 C711.4531,169.4531 711.6563,169.5 712.0781,169.5 L714.4375,169.5 C714.7969,169.5 715.0156,169.4688 715.1563,169.375 C715.4063,169.2344 715.5625,168.9375 715.5625,168.6563 C715.5625,168.375 715.4219,168.125 715.2031,167.9688 C715.0313,167.8281 714.875,167.7969 714.4063,167.7969 L711.0156,159.5938 L707.3438,159.5938 C706.8906,159.5938 706.7656,159.6094 706.6094,159.7031 C706.3594,159.875 706.2031,160.1563 706.2031,160.4375 C706.2031,160.7188 706.3438,160.9688 706.5625,161.1406 C706.7344,161.25 706.9063,161.2813 707.3438,161.2813 L708.4219,161.2813 L705.7813,167.7969 C705.3594,167.7969 705.2031,167.8125 705.0469,167.9219 C704.7969,168.0781 704.6406,168.3594 704.6406,168.6563 C704.6406,169.2188 705.0156,169.5 705.7656,169.5 L708.0313,169.5 C708.3906,169.5 708.6094,169.4688 708.7344,169.375 C709,169.2344 709.1406,168.9375 709.1406,168.6563 C709.1406,168.375 709.0156,168.125 708.7969,167.9531 C708.625,167.8281 708.4844,167.7969 708.0313,167.7969 L707.6406,167.7969 L708.0313,166.8125 L712.0781,166.8125 Z M711.375,165.1094 L708.7031,165.1094 L710.0469,161.8438 L711.375,165.1094 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="337" x="724" y="169.8467">AbstractNamedValueMethodArgumentResolver</text><line style="stroke:#181818;stroke-width:0.5;" x1="696" x2="1063" y1="181" y2="181"/><line style="stroke:#181818;stroke-width:0.5;" x1="696" x2="1063" y1="189" y2="189"/></g><!--MD5=[989566589a9c564ba80ecf0041ebadd3]
class HandlerMethodReturnValueHandler--><g id="elem_HandlerMethodReturnValueHandler"><rect codeLine="10" fill="#F1F1F1" height="48" id="HandlerMethodReturnValueHandler" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="288" x="1149.5" y="149"/><ellipse cx="1164.5" cy="165" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1165.4531,161.7813 L1167.1719,161.7813 C1167.5625,161.7813 1167.75,161.75 1167.875,161.6719 C1168.1406,161.5156 1168.2813,161.2344 1168.2813,160.9375 C1168.2813,160.6719 1168.1719,160.4063 1167.9375,160.2344 C1167.7656,160.125 1167.625,160.0938 1167.1719,160.0938 L1162.0313,160.0938 C1161.5938,160.0938 1161.4688,160.1094 1161.3125,160.2031 C1161.0625,160.3594 1160.9063,160.6563 1160.9063,160.9375 C1160.9063,161.2188 1161.0469,161.4688 1161.2656,161.6406 C1161.4219,161.75 1161.6094,161.7813 1162.0313,161.7813 L1163.75,161.7813 L1163.75,168.2969 L1162.0313,168.2969 C1161.5938,168.2969 1161.4688,168.3125 1161.3125,168.4219 C1161.0625,168.5781 1160.9063,168.8594 1160.9063,169.1563 C1160.9063,169.4063 1161.0469,169.6719 1161.2656,169.8281 C1161.4219,169.9531 1161.625,170 1162.0313,170 L1167.1719,170 C1167.9219,170 1168.2813,169.7188 1168.2813,169.1563 C1168.2813,168.875 1168.1719,168.625 1167.9375,168.4531 C1167.7656,168.3281 1167.625,168.2969 1167.1719,168.2969 L1165.4531,168.2969 L1165.4531,161.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="256" x="1178.5" y="169.8467">HandlerMethodReturnValueHandler</text><line style="stroke:#181818;stroke-width:0.5;" x1="1150.5" x2="1436.5" y1="181" y2="181"/><line style="stroke:#181818;stroke-width:0.5;" x1="1150.5" x2="1436.5" y1="189" y2="189"/></g><!--MD5=[00818b6899d5d590ad91477e40170472]
class AbstractMessageConverterMethodProcessor--><g id="elem_AbstractMessageConverterMethodProcessor"><rect codeLine="11" fill="#F1F1F1" height="48" id="AbstractMessageConverterMethodProcessor" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="346" x="1120.5" y="257"/><ellipse cx="1135.5" cy="273" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1137.5781,274.8125 L1137.9688,275.7969 L1137.5781,275.7969 C1137.125,275.7969 1137.0156,275.8125 1136.8594,275.9219 C1136.6094,276.0781 1136.4531,276.3594 1136.4531,276.6563 C1136.4531,276.9219 1136.5938,277.1719 1136.8125,277.3281 C1136.9531,277.4531 1137.1563,277.5 1137.5781,277.5 L1139.9375,277.5 C1140.2969,277.5 1140.5156,277.4688 1140.6563,277.375 C1140.9063,277.2344 1141.0625,276.9375 1141.0625,276.6563 C1141.0625,276.375 1140.9219,276.125 1140.7031,275.9688 C1140.5313,275.8281 1140.375,275.7969 1139.9063,275.7969 L1136.5156,267.5938 L1132.8438,267.5938 C1132.3906,267.5938 1132.2656,267.6094 1132.1094,267.7031 C1131.8594,267.875 1131.7031,268.1563 1131.7031,268.4375 C1131.7031,268.7188 1131.8438,268.9688 1132.0625,269.1406 C1132.2344,269.25 1132.4063,269.2813 1132.8438,269.2813 L1133.9219,269.2813 L1131.2813,275.7969 C1130.8594,275.7969 1130.7031,275.8125 1130.5469,275.9219 C1130.2969,276.0781 1130.1406,276.3594 1130.1406,276.6563 C1130.1406,277.2188 1130.5156,277.5 1131.2656,277.5 L1133.5313,277.5 C1133.8906,277.5 1134.1094,277.4688 1134.2344,277.375 C1134.5,277.2344 1134.6406,276.9375 1134.6406,276.6563 C1134.6406,276.375 1134.5156,276.125 1134.2969,275.9531 C1134.125,275.8281 1133.9844,275.7969 1133.5313,275.7969 L1133.1406,275.7969 L1133.5313,274.8125 L1137.5781,274.8125 Z M1136.875,273.1094 L1134.2031,273.1094 L1135.5469,269.8438 L1136.875,273.1094 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="314" x="1149.5" y="277.8467">AbstractMessageConverterMethodProcessor</text><line style="stroke:#181818;stroke-width:0.5;" x1="1121.5" x2="1465.5" y1="289" y2="289"/><line style="stroke:#181818;stroke-width:0.5;" x1="1121.5" x2="1465.5" y1="297" y2="297"/></g><!--MD5=[35896e4a33bd6e56d3657a43ccfbbf83]
class RequestResponseBodyMethodProcessor--><g id="elem_RequestResponseBodyMethodProcessor"><rect codeLine="12" fill="#F1F1F1" height="48" id="RequestResponseBodyMethodProcessor" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="322" x="1132.5" y="365"/><ellipse cx="1147.5" cy="381" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1149.8438,376.6719 C1148.9063,376.2344 1148.3125,376.0938 1147.4375,376.0938 C1144.8125,376.0938 1142.8125,378.1719 1142.8125,380.8906 L1142.8125,382.0156 C1142.8125,384.5938 1144.9219,386.4844 1147.8125,386.4844 C1149.0313,386.4844 1150.1875,386.1875 1150.9375,385.6406 C1151.5156,385.2344 1151.8438,384.7813 1151.8438,384.3906 C1151.8438,383.9375 1151.4531,383.5469 1150.9844,383.5469 C1150.7656,383.5469 1150.5625,383.625 1150.375,383.8125 C1149.9219,384.2969 1149.9219,384.2969 1149.7344,384.3906 C1149.3125,384.6563 1148.625,384.7813 1147.8594,384.7813 C1145.8125,384.7813 1144.5156,383.6875 1144.5156,381.9844 L1144.5156,380.8906 C1144.5156,379.1094 1145.7656,377.7969 1147.5,377.7969 C1148.0781,377.7969 1148.6875,377.9531 1149.1563,378.2031 C1149.6406,378.4844 1149.8125,378.7031 1149.9063,379.1094 C1149.9688,379.5156 1150,379.6406 1150.1406,379.7656 C1150.2813,379.9063 1150.5156,380.0156 1150.7344,380.0156 C1151,380.0156 1151.2656,379.875 1151.4375,379.6563 C1151.5469,379.5 1151.5781,379.3125 1151.5781,378.8906 L1151.5781,377.4688 C1151.5781,377.0313 1151.5625,376.9063 1151.4688,376.75 C1151.3125,376.4844 1151.0313,376.3438 1150.7344,376.3438 C1150.4375,376.3438 1150.2344,376.4375 1150.0156,376.75 L1149.8438,376.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="290" x="1161.5" y="385.8467">RequestResponseBodyMethodProcessor</text><line style="stroke:#181818;stroke-width:0.5;" x1="1133.5" x2="1453.5" y1="397" y2="397"/><line style="stroke:#181818;stroke-width:0.5;" x1="1133.5" x2="1453.5" y1="405" y2="405"/></g><!--MD5=[853b6eabc0f14065e723d8ad6c6dd909]
class HttpMessageConverter--><g id="elem_HttpMessageConverter"><rect codeLine="15" fill="#F1F1F1" height="48" id="HttpMessageConverter" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="195" x="185" y="257"/><ellipse cx="200" cy="273" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M200.9531,269.7813 L202.6719,269.7813 C203.0625,269.7813 203.25,269.75 203.375,269.6719 C203.6406,269.5156 203.7813,269.2344 203.7813,268.9375 C203.7813,268.6719 203.6719,268.4063 203.4375,268.2344 C203.2656,268.125 203.125,268.0938 202.6719,268.0938 L197.5313,268.0938 C197.0938,268.0938 196.9688,268.1094 196.8125,268.2031 C196.5625,268.3594 196.4063,268.6563 196.4063,268.9375 C196.4063,269.2188 196.5469,269.4688 196.7656,269.6406 C196.9219,269.75 197.1094,269.7813 197.5313,269.7813 L199.25,269.7813 L199.25,276.2969 L197.5313,276.2969 C197.0938,276.2969 196.9688,276.3125 196.8125,276.4219 C196.5625,276.5781 196.4063,276.8594 196.4063,277.1563 C196.4063,277.4063 196.5469,277.6719 196.7656,277.8281 C196.9219,277.9531 197.125,278 197.5313,278 L202.6719,278 C203.4219,278 203.7813,277.7188 203.7813,277.1563 C203.7813,276.875 203.6719,276.625 203.4375,276.4531 C203.2656,276.3281 203.125,276.2969 202.6719,276.2969 L200.9531,276.2969 L200.9531,269.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="163" x="214" y="277.8467">HttpMessageConverter</text><line style="stroke:#181818;stroke-width:0.5;" x1="186" x2="379" y1="289" y2="289"/><line style="stroke:#181818;stroke-width:0.5;" x1="186" x2="379" y1="297" y2="297"/></g><!--MD5=[a7cdd2678777604d09b7ec46f520c179]
class HttpMessageConverters--><g id="elem_HttpMessageConverters"><rect codeLine="18" fill="#F1F1F1" height="48" id="HttpMessageConverters" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="207" x="7" y="149"/><ellipse cx="22" cy="165" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M24.3438,160.6719 C23.4063,160.2344 22.8125,160.0938 21.9375,160.0938 C19.3125,160.0938 17.3125,162.1719 17.3125,164.8906 L17.3125,166.0156 C17.3125,168.5938 19.4219,170.4844 22.3125,170.4844 C23.5313,170.4844 24.6875,170.1875 25.4375,169.6406 C26.0156,169.2344 26.3438,168.7813 26.3438,168.3906 C26.3438,167.9375 25.9531,167.5469 25.4844,167.5469 C25.2656,167.5469 25.0625,167.625 24.875,167.8125 C24.4219,168.2969 24.4219,168.2969 24.2344,168.3906 C23.8125,168.6563 23.125,168.7813 22.3594,168.7813 C20.3125,168.7813 19.0156,167.6875 19.0156,165.9844 L19.0156,164.8906 C19.0156,163.1094 20.2656,161.7969 22,161.7969 C22.5781,161.7969 23.1875,161.9531 23.6563,162.2031 C24.1406,162.4844 24.3125,162.7031 24.4063,163.1094 C24.4688,163.5156 24.5,163.6406 24.6406,163.7656 C24.7813,163.9063 25.0156,164.0156 25.2344,164.0156 C25.5,164.0156 25.7656,163.875 25.9375,163.6563 C26.0469,163.5 26.0781,163.3125 26.0781,162.8906 L26.0781,161.4688 C26.0781,161.0313 26.0625,160.9063 25.9688,160.75 C25.8125,160.4844 25.5313,160.3438 25.2344,160.3438 C24.9375,160.3438 24.7344,160.4375 24.5156,160.75 L24.3438,160.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175" x="36" y="169.8467">HttpMessageConverters</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="213" y1="181" y2="181"/><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="213" y1="189" y2="189"/></g><!--MD5=[e1d947aeae02c90ff7d879f90a4f64c4]
reverse link HandlerMethodArgumentResolver to AbstractMessageConverterMethodArgumentResolver--><g id="link_HandlerMethodArgumentResolver_AbstractMessageConverterMethodArgumentResolver"><path d="M602.555,97.972 C569.778,114.361 530.597,133.952 500.777,148.862 " fill="none" id="HandlerMethodArgumentResolver-backto-AbstractMessageConverterMethodArgumentResolver" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="599.48,91.684,620.499,89,605.741,104.206,599.48,91.684" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[5ecae0d47b0e6c61b8fac7bbcc9773c4]
reverse link HandlerMethodArgumentResolver to AbstractNamedValueMethodArgumentResolver--><g id="link_HandlerMethodArgumentResolver_AbstractNamedValueMethodArgumentResolver"><path d="M730.746,97.972 C763.679,114.361 803.044,133.952 833.005,148.862 " fill="none" id="HandlerMethodArgumentResolver-backto-AbstractNamedValueMethodArgumentResolver" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="727.504,104.178,712.718,89,733.742,91.644,727.504,104.178" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[7dfbe8ca49dbf041009a830247c8d55b]
reverse link AbstractMessageConverterMethodArgumentResolver to AbstractMessageConverterMethodProcessor--><g id="link_AbstractMessageConverterMethodArgumentResolver_AbstractMessageConverterMethodProcessor"><path d="M571.634,201.265 C605.637,208.479 642.925,215.718 677.5,221 C826.182,243.715 996.472,259.231 1120.27,268.628 " fill="none" id="AbstractMessageConverterMethodArgumentResolver-backto-AbstractMessageConverterMethodProcessor" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="570.11,208.098,552.037,197.036,573.064,194.413,570.11,208.098" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[60d33d49e201ddf9e306c6abf21a9072]
reverse link HandlerMethodReturnValueHandler to AbstractMessageConverterMethodProcessor--><g id="link_HandlerMethodReturnValueHandler_AbstractMessageConverterMethodProcessor"><path d="M1293.5,217.024 C1293.5,230.579 1293.5,245.038 1293.5,256.678 " fill="none" id="HandlerMethodReturnValueHandler-backto-AbstractMessageConverterMethodProcessor" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="1286.5,217,1293.5,197,1300.5,217,1286.5,217" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[a38e8769e6daa6d9e5115363784749ae]
reverse link AbstractMessageConverterMethodProcessor to RequestResponseBodyMethodProcessor--><g id="link_AbstractMessageConverterMethodProcessor_RequestResponseBodyMethodProcessor"><path d="M1293.5,325.024 C1293.5,338.579 1293.5,353.0381 1293.5,364.6784 " fill="none" id="AbstractMessageConverterMethodProcessor-backto-RequestResponseBodyMethodProcessor" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="1286.5,325,1293.5,305,1300.5,325,1286.5,325" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[1576ba1e42017bd7565795cc36b37362]
link AbstractMessageConverterMethodArgumentResolver to HttpMessageConverter--><g id="link_AbstractMessageConverterMethodArgumentResolver_HttpMessageConverter"><path codeLine="16" d="M406.9636,203.2965 C406.9636,203.2965 354.536,235.605 331.128,250.032 " fill="none" id="AbstractMessageConverterMethodArgumentResolver-HttpMessageConverter" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="320.045,256.862,329.8054,255.5448,324.3014,254.2385,325.6077,248.7345,320.045,256.862" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="324.3014" x2="331.1125" y1="254.2385" y2="250.0415"/><polygon fill="#181818" points="417.179,197,409.9725,196.7431,406.9636,203.2965,414.1701,203.5534,417.179,197" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="398.5905" y="217.1558">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="7" x="321.769" y="245.8387">*</text></g><!--MD5=[adc14412c255b29a89440d9b20a15529]
link HttpMessageConverters to HttpMessageConverter--><g id="link_HttpMessageConverters_HttpMessageConverter"><path codeLine="19" d="M158.0364,203.2965 C158.0364,203.2965 210.464,235.605 233.872,250.032 " fill="none" id="HttpMessageConverters-HttpMessageConverter" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="244.955,256.862,239.3923,248.7345,240.6986,254.2385,235.1946,255.5448,244.955,256.862" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="240.6986" x2="233.8875" y1="254.2385" y2="250.0415"/><polygon fill="#181818" points="147.821,197,150.8299,203.5534,158.0364,203.2965,155.0275,196.7431,147.821,197" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="148.3595" y="217.1558">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="7" x="227.4372" y="245.8387">*</text></g><!--MD5=[48f763ca6c7c0545f68f4f0ae3cd0d65]
@startuml
package Input {
interface HandlerMethodArgumentResolver

abstract class AbstractMessageConverterMethodArgumentResolver implements HandlerMethodArgumentResolver

abstract class AbstractNamedValueMethodArgumentResolver implements HandlerMethodArgumentResolver
}

package Output {
interface HandlerMethodReturnValueHandler
abstract class AbstractMessageConverterMethodProcessor extends AbstractMessageConverterMethodArgumentResolver implements HandlerMethodReturnValueHandler
class RequestResponseBodyMethodProcessor extends AbstractMessageConverterMethodProcessor
}

interface HttpMessageConverter
AbstractMessageConverterMethodArgumentResolver "1" *- -> "*" HttpMessageConverter

class HttpMessageConverters
HttpMessageConverters "1" *- -> "*" HttpMessageConverter
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<p>通过<code>HttpMessageConverter</code>对body进行序列化和反序列化,<br>其中最常用的就是json的处理模块<code>MappingJackson2HttpMessageConverter</code>.</p>
<p>通过定义<code>HttpMessageConverters</code>的bean，将自定义的<code>HttpMessageConverter</code>添加进来，通过<code>WebMvcAutoConfigurationAdapter#configureMessageConverters</code>进行注册</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// StringConverter.java</span></span><br><span class="line"><span class="keyword">public</span> StringConverter implements HttpMessageConverter&lt;String&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ConverterConfig.java</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpMessageConverters <span class="title">converters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HttpMessageConverters(<span class="keyword">new</span> StringConverter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JacksonJson序列化的支持"><a href="#JacksonJson序列化的支持" class="headerlink" title="JacksonJson序列化的支持"></a>JacksonJson序列化的支持</h3><p>Spring MVC中提供了<code>MappingJackson2HttpMessageConverter</code>对json对象进行序列化处理。</p>
<p>通过<code>JsonComponnet</code>bean来注册JSON序列化组件</p>
<ul>
<li>JsonSerializer</li>
<li>JsonDeserializer</li>
</ul>
<p>s</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JsonComponent</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MoneyJson</span> <span class="keyword">extends</span> <span class="title">StdSerializer</span>&lt;<span class="title">Money</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">MoneyJson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Money.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Money money, JsonGenerator jsonGenerator, SerializerProvider serializerProvider)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        jsonGenerator.writeString(money.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Interceptor拦截"><a href="#Interceptor拦截" class="headerlink" title="Interceptor拦截"></a>Interceptor拦截</h2><p>Interceptor用于对Controller层进行拦截，<br>处理一些和controller没有依赖的业务，比如鉴权，日志等</p>
<p>通过<code>WebMvcConfigurer#addInterceptors</code>来添加Interceptor，<br>添加的顺序决定了执行的顺序</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, <span class="meta">@Nullable</span> ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, <span class="meta">@Nullable</span> Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="487px" preserveAspectRatio="none" style="width:226px;height:487px;background:#FFFFFF;" version="1.1" viewBox="0 0 226 487" width="226px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="47" x="77" y="11"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="27" x="87" y="32.1387">start</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="83" x="59" y="64.9688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="63" x="69" y="86.1074">preHandle</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="78" x="61.5" y="167.3398"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="58" x="71.5" y="188.4785">controller</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="94" x="53.5" y="221.3086"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="74" x="63.5" y="242.4473">postHandler</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="179" x="11" y="290.2773"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="159" x="21" y="311.416">DispatcherServlet#render</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="116" x="42.5" y="344.2461"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="96" x="52.5" y="365.3848">afterCompletion</text><polygon fill="#F1F1F1" points="35.5,118.9375,165.5,118.9375,177.5,130.9375,165.5,142.9375,35.5,142.9375,23.5,130.9375,35.5,118.9375" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="23" x="104.5" y="153.1479">true</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="130" x="35.5" y="134.7456">preHandle return true?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="28" x="177.5" y="128.3433">false</text><polygon fill="#F1F1F1" points="100.5,398.2148,112.5,410.2148,100.5,422.2148,88.5,410.2148,100.5,398.2148" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="43" x="79" y="442.2148"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="23" x="89" y="463.3535">end</text><line style="stroke:#181818;stroke-width:1.0;" x1="100.5" x2="100.5" y1="44.9688" y2="64.9688"/><polygon fill="#181818" points="96.5,54.9688,100.5,64.9688,104.5,54.9688,100.5,58.9688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="100.5" x2="100.5" y1="201.3086" y2="221.3086"/><polygon fill="#181818" points="96.5,211.3086,100.5,221.3086,104.5,211.3086,100.5,215.3086" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="100.5" x2="100.5" y1="255.2773" y2="290.2773"/><polygon fill="#181818" points="96.5,280.2773,100.5,290.2773,104.5,280.2773,100.5,284.2773" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="100.5" x2="100.5" y1="324.2461" y2="344.2461"/><polygon fill="#181818" points="96.5,334.2461,100.5,344.2461,104.5,334.2461,100.5,338.2461" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="100.5" x2="100.5" y1="142.9375" y2="167.3398"/><polygon fill="#181818" points="96.5,157.3398,100.5,167.3398,104.5,157.3398,100.5,161.3398" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="177.5" x2="200" y1="130.9375" y2="130.9375"/><polygon fill="#181818" points="196,262.7773,200,272.7773,204,262.7773,200,266.7773" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="200" x2="200" y1="130.9375" y2="410.2148"/><line style="stroke:#181818;stroke-width:1.0;" x1="200" x2="112.5" y1="410.2148" y2="410.2148"/><polygon fill="#181818" points="122.5,406.2148,112.5,410.2148,122.5,414.2148,118.5,410.2148" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="100.5" x2="100.5" y1="378.2148" y2="398.2148"/><polygon fill="#181818" points="96.5,388.2148,100.5,398.2148,104.5,388.2148,100.5,392.2148" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="100.5" x2="100.5" y1="98.9375" y2="118.9375"/><polygon fill="#181818" points="96.5,108.9375,100.5,118.9375,104.5,108.9375,100.5,112.9375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="100.5" x2="100.5" y1="422.2148" y2="442.2148"/><polygon fill="#181818" points="96.5,432.2148,100.5,442.2148,104.5,432.2148,100.5,436.2148" style="stroke:#181818;stroke-width:1.0;"/><!--MD5=[e20a64d08d7f60f3753c3c106625657c]
@startuml
:start;
:preHandle;
if (preHandle return true?) then (true)
:controller;
:postHandler;
:DispatcherServlet#render;
:afterCompletion;
else (false)
endif
:end;
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>对Request Mapping Handler方法抛出的异常进行处理。</p>
<ul>
<li>ExceptionHandler<ul>
<li>Controller层异常处理</li>
<li>ControllerAdvice全局异常处理</li>
</ul>
</li>
<li>BasicErrorController</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#spring-web">Spring MVC</a></li>
<li><a href="https://time.geekbang.org/course/detail/100023501-85504">玩转Spring全家桶 — 46 | Spring MVC中的常用视图（上）</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1381004">Spring MVC/Boot 统一异常处理最佳实践</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1561782">Spring Boot 统一异常处理最佳实践 – 拓展篇</a></li>
</ul>
]]></content>
      <categories>
        <category>Spring MVC</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Security --- Authentication</title>
    <url>/2021/02/spring-security/authentication/</url>
    <content><![CDATA[<h2 id="Authentication设计"><a href="#Authentication设计" class="headerlink" title="Authentication设计"></a>Authentication设计</h2><h3 id="认证处理流程"><a href="#认证处理流程" class="headerlink" title="认证处理流程"></a>认证处理流程</h3><p><img src="/2021/02/spring-security/authentication/abstractauthenticationprocessingfilter.png" alt="认证处理流程"></p>
<ul>
<li>SecurityContextHolder, 认证成功后, 可以在后续的处理中通过它来获取认证后的用户信息</li>
</ul>
<p><img src="/2021/02/spring-security/authentication/SecurityContext.png"></p>
<h3 id="认证的设计"><a href="#认证的设计" class="headerlink" title="认证的设计"></a>认证的设计</h3><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="846px" preserveAspectRatio="none" style="width:702px;height:846px;background:#FFFFFF;" version="1.1" viewBox="0 0 702 846" width="702px" zoomAndPan="magnify"><defs/><g><!--MD5=[a139e992f8a77546bf37c14edd197f06]
class Authentication--><g id="elem_Authentication"><rect codeLine="1" fill="#F1F1F1" height="113.1875" id="Authentication" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="505" x="98.5" y="241"/><ellipse cx="294.75" cy="257" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M295.7031,253.7813 L297.4219,253.7813 C297.8125,253.7813 298,253.75 298.125,253.6719 C298.3906,253.5156 298.5313,253.2344 298.5313,252.9375 C298.5313,252.6719 298.4219,252.4063 298.1875,252.2344 C298.0156,252.125 297.875,252.0938 297.4219,252.0938 L292.2813,252.0938 C291.8438,252.0938 291.7188,252.1094 291.5625,252.2031 C291.3125,252.3594 291.1563,252.6563 291.1563,252.9375 C291.1563,253.2188 291.2969,253.4688 291.5156,253.6406 C291.6719,253.75 291.8594,253.7813 292.2813,253.7813 L294,253.7813 L294,260.2969 L292.2813,260.2969 C291.8438,260.2969 291.7188,260.3125 291.5625,260.4219 C291.3125,260.5781 291.1563,260.8594 291.1563,261.1563 C291.1563,261.4063 291.2969,261.6719 291.5156,261.8281 C291.6719,261.9531 291.875,262 292.2813,262 L297.4219,262 C298.1719,262 298.5313,261.7188 298.5313,261.1563 C298.5313,260.875 298.4219,260.625 298.1875,260.4531 C298.0156,260.3281 297.875,260.2969 297.4219,260.2969 L295.7031,260.2969 L295.7031,253.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="104" x="315.25" y="261.8467">Authentication</text><line style="stroke:#181818;stroke-width:0.5;" x1="99.5" x2="602.5" y1="273" y2="273"/><line style="stroke:#181818;stroke-width:0.5;" x1="99.5" x2="602.5" y1="281" y2="281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="493" x="104.5" y="297.9951">Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); // 权限信息</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="277" x="104.5" y="314.292">Object getCredentials(); // 用户校验信息</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="104.5" y="330.5889">Object getDetails();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="257" x="104.5" y="346.8857">Object getPrincipal(); // 用户标识信息</text></g><!--MD5=[9ec87d94fbb51db69175d879cdc53157]
class AbstractAuthenticationProcessingFilter--><g id="elem_AbstractAuthenticationProcessingFilter"><rect codeLine="7" fill="#F1F1F1" height="48" id="AbstractAuthenticationProcessingFilter" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="307" x="85.5" y="116"/><ellipse cx="100.5" cy="132" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M102.5781,133.8125 L102.9688,134.7969 L102.5781,134.7969 C102.125,134.7969 102.0156,134.8125 101.8594,134.9219 C101.6094,135.0781 101.4531,135.3594 101.4531,135.6563 C101.4531,135.9219 101.5938,136.1719 101.8125,136.3281 C101.9531,136.4531 102.1563,136.5 102.5781,136.5 L104.9375,136.5 C105.2969,136.5 105.5156,136.4688 105.6563,136.375 C105.9063,136.2344 106.0625,135.9375 106.0625,135.6563 C106.0625,135.375 105.9219,135.125 105.7031,134.9688 C105.5313,134.8281 105.375,134.7969 104.9063,134.7969 L101.5156,126.5938 L97.8438,126.5938 C97.3906,126.5938 97.2656,126.6094 97.1094,126.7031 C96.8594,126.875 96.7031,127.1563 96.7031,127.4375 C96.7031,127.7188 96.8438,127.9688 97.0625,128.1406 C97.2344,128.25 97.4063,128.2813 97.8438,128.2813 L98.9219,128.2813 L96.2813,134.7969 C95.8594,134.7969 95.7031,134.8125 95.5469,134.9219 C95.2969,135.0781 95.1406,135.3594 95.1406,135.6563 C95.1406,136.2188 95.5156,136.5 96.2656,136.5 L98.5313,136.5 C98.8906,136.5 99.1094,136.4688 99.2344,136.375 C99.5,136.2344 99.6406,135.9375 99.6406,135.6563 C99.6406,135.375 99.5156,135.125 99.2969,134.9531 C99.125,134.8281 98.9844,134.7969 98.5313,134.7969 L98.1406,134.7969 L98.5313,133.8125 L102.5781,133.8125 Z M101.875,132.1094 L99.2031,132.1094 L100.5469,128.8438 L101.875,132.1094 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="275" x="114.5" y="136.8467">AbstractAuthenticationProcessingFilter</text><line style="stroke:#181818;stroke-width:0.5;" x1="86.5" x2="391.5" y1="148" y2="148"/><line style="stroke:#181818;stroke-width:0.5;" x1="86.5" x2="391.5" y1="156" y2="156"/></g><!--MD5=[eaceba59a068e045d0f40484b37c2e3f]
class AuthenticationManager--><g id="elem_AuthenticationManager"><rect codeLine="11" fill="#F1F1F1" height="48" id="AuthenticationManager" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="199" x="251.5" y="431"/><ellipse cx="266.5" cy="447" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M267.4531,443.7813 L269.1719,443.7813 C269.5625,443.7813 269.75,443.75 269.875,443.6719 C270.1406,443.5156 270.2813,443.2344 270.2813,442.9375 C270.2813,442.6719 270.1719,442.4063 269.9375,442.2344 C269.7656,442.125 269.625,442.0938 269.1719,442.0938 L264.0313,442.0938 C263.5938,442.0938 263.4688,442.1094 263.3125,442.2031 C263.0625,442.3594 262.9063,442.6563 262.9063,442.9375 C262.9063,443.2188 263.0469,443.4688 263.2656,443.6406 C263.4219,443.75 263.6094,443.7813 264.0313,443.7813 L265.75,443.7813 L265.75,450.2969 L264.0313,450.2969 C263.5938,450.2969 263.4688,450.3125 263.3125,450.4219 C263.0625,450.5781 262.9063,450.8594 262.9063,451.1563 C262.9063,451.4063 263.0469,451.6719 263.2656,451.8281 C263.4219,451.9531 263.625,452 264.0313,452 L269.1719,452 C269.9219,452 270.2813,451.7188 270.2813,451.1563 C270.2813,450.875 270.1719,450.625 269.9375,450.4531 C269.7656,450.3281 269.625,450.2969 269.1719,450.2969 L267.4531,450.2969 L267.4531,443.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="167" x="280.5" y="451.8467">AuthenticationManager</text><line style="stroke:#181818;stroke-width:0.5;" x1="252.5" x2="449.5" y1="463" y2="463"/><line style="stroke:#181818;stroke-width:0.5;" x1="252.5" x2="449.5" y1="471" y2="471"/></g><!--MD5=[52de2a8bba1e55f410541bc5f0542349]
class ProviderManager--><g id="elem_ProviderManager"><rect codeLine="12" fill="#F1F1F1" height="48" id="ProviderManager" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="153" x="274.5" y="540"/><ellipse cx="289.5" cy="556" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M291.8438,551.6719 C290.9063,551.2344 290.3125,551.0938 289.4375,551.0938 C286.8125,551.0938 284.8125,553.1719 284.8125,555.8906 L284.8125,557.0156 C284.8125,559.5938 286.9219,561.4844 289.8125,561.4844 C291.0313,561.4844 292.1875,561.1875 292.9375,560.6406 C293.5156,560.2344 293.8438,559.7813 293.8438,559.3906 C293.8438,558.9375 293.4531,558.5469 292.9844,558.5469 C292.7656,558.5469 292.5625,558.625 292.375,558.8125 C291.9219,559.2969 291.9219,559.2969 291.7344,559.3906 C291.3125,559.6563 290.625,559.7813 289.8594,559.7813 C287.8125,559.7813 286.5156,558.6875 286.5156,556.9844 L286.5156,555.8906 C286.5156,554.1094 287.7656,552.7969 289.5,552.7969 C290.0781,552.7969 290.6875,552.9531 291.1563,553.2031 C291.6406,553.4844 291.8125,553.7031 291.9063,554.1094 C291.9688,554.5156 292,554.6406 292.1406,554.7656 C292.2813,554.9063 292.5156,555.0156 292.7344,555.0156 C293,555.0156 293.2656,554.875 293.4375,554.6563 C293.5469,554.5 293.5781,554.3125 293.5781,553.8906 L293.5781,552.4688 C293.5781,552.0313 293.5625,551.9063 293.4688,551.75 C293.3125,551.4844 293.0313,551.3438 292.7344,551.3438 C292.4375,551.3438 292.2344,551.4375 292.0156,551.75 L291.8438,551.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="121" x="303.5" y="560.8467">ProviderManager</text><line style="stroke:#181818;stroke-width:0.5;" x1="275.5" x2="426.5" y1="572" y2="572"/><line style="stroke:#181818;stroke-width:0.5;" x1="275.5" x2="426.5" y1="580" y2="580"/></g><!--MD5=[f074fdee743888442a4f97901e556f9c]
class AuthenticationProvider--><g id="elem_AuthenticationProvider"><rect codeLine="13" fill="#F1F1F1" height="80.5938" id="AuthenticationProvider" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="688" x="7" y="649"/><ellipse cx="265.25" cy="665" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M266.2031,661.7813 L267.9219,661.7813 C268.3125,661.7813 268.5,661.75 268.625,661.6719 C268.8906,661.5156 269.0313,661.2344 269.0313,660.9375 C269.0313,660.6719 268.9219,660.4063 268.6875,660.2344 C268.5156,660.125 268.375,660.0938 267.9219,660.0938 L262.7813,660.0938 C262.3438,660.0938 262.2188,660.1094 262.0625,660.2031 C261.8125,660.3594 261.6563,660.6563 261.6563,660.9375 C261.6563,661.2188 261.7969,661.4688 262.0156,661.6406 C262.1719,661.75 262.3594,661.7813 262.7813,661.7813 L264.5,661.7813 L264.5,668.2969 L262.7813,668.2969 C262.3438,668.2969 262.2188,668.3125 262.0625,668.4219 C261.8125,668.5781 261.6563,668.8594 261.6563,669.1563 C261.6563,669.4063 261.7969,669.6719 262.0156,669.8281 C262.1719,669.9531 262.375,670 262.7813,670 L267.9219,670 C268.6719,670 269.0313,669.7188 269.0313,669.1563 C269.0313,668.875 268.9219,668.625 268.6875,668.4531 C268.5156,668.3281 268.375,668.2969 267.9219,668.2969 L266.2031,668.2969 L266.2031,661.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="163" x="285.75" y="669.8467">AuthenticationProvider</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="694" y1="681" y2="681"/><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="694" y1="689" y2="689"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="676" x="13" y="705.9951">Authentication authenticate(Authentication authentication) throws AuthenticationException;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="316" x="13" y="722.292">boolean supports(Class&lt;?&gt; authentication);</text></g><!--MD5=[3e6b436126ba7aa842e4929fc17143d3]
class DaoAuthenticationProvider--><g id="elem_DaoAuthenticationProvider"><rect codeLine="18" fill="#F1F1F1" height="48" id="DaoAuthenticationProvider" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="228" x="107" y="791"/><ellipse cx="122" cy="807" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M124.3438,802.6719 C123.4063,802.2344 122.8125,802.0938 121.9375,802.0938 C119.3125,802.0938 117.3125,804.1719 117.3125,806.8906 L117.3125,808.0156 C117.3125,810.5938 119.4219,812.4844 122.3125,812.4844 C123.5313,812.4844 124.6875,812.1875 125.4375,811.6406 C126.0156,811.2344 126.3438,810.7813 126.3438,810.3906 C126.3438,809.9375 125.9531,809.5469 125.4844,809.5469 C125.2656,809.5469 125.0625,809.625 124.875,809.8125 C124.4219,810.2969 124.4219,810.2969 124.2344,810.3906 C123.8125,810.6563 123.125,810.7813 122.3594,810.7813 C120.3125,810.7813 119.0156,809.6875 119.0156,807.9844 L119.0156,806.8906 C119.0156,805.1094 120.2656,803.7969 122,803.7969 C122.5781,803.7969 123.1875,803.9531 123.6563,804.2031 C124.1406,804.4844 124.3125,804.7031 124.4063,805.1094 C124.4688,805.5156 124.5,805.6406 124.6406,805.7656 C124.7813,805.9063 125.0156,806.0156 125.2344,806.0156 C125.5,806.0156 125.7656,805.875 125.9375,805.6563 C126.0469,805.5 126.0781,805.3125 126.0781,804.8906 L126.0781,803.4688 C126.0781,803.0313 126.0625,802.9063 125.9688,802.75 C125.8125,802.4844 125.5313,802.3438 125.2344,802.3438 C124.9375,802.3438 124.7344,802.4375 124.5156,802.75 L124.3438,802.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="196" x="136" y="811.8467">DaoAuthenticationProvider</text><line style="stroke:#181818;stroke-width:0.5;" x1="108" x2="334" y1="823" y2="823"/><line style="stroke:#181818;stroke-width:0.5;" x1="108" x2="334" y1="831" y2="831"/></g><!--MD5=[b136bb2a7838eae0b91cfe262134d939]
class JwtAuthenticationProvider--><g id="elem_JwtAuthenticationProvider"><rect codeLine="19" fill="#F1F1F1" height="48" id="JwtAuthenticationProvider" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="222" x="370" y="791"/><ellipse cx="385" cy="807" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M387.3438,802.6719 C386.4063,802.2344 385.8125,802.0938 384.9375,802.0938 C382.3125,802.0938 380.3125,804.1719 380.3125,806.8906 L380.3125,808.0156 C380.3125,810.5938 382.4219,812.4844 385.3125,812.4844 C386.5313,812.4844 387.6875,812.1875 388.4375,811.6406 C389.0156,811.2344 389.3438,810.7813 389.3438,810.3906 C389.3438,809.9375 388.9531,809.5469 388.4844,809.5469 C388.2656,809.5469 388.0625,809.625 387.875,809.8125 C387.4219,810.2969 387.4219,810.2969 387.2344,810.3906 C386.8125,810.6563 386.125,810.7813 385.3594,810.7813 C383.3125,810.7813 382.0156,809.6875 382.0156,807.9844 L382.0156,806.8906 C382.0156,805.1094 383.2656,803.7969 385,803.7969 C385.5781,803.7969 386.1875,803.9531 386.6563,804.2031 C387.1406,804.4844 387.3125,804.7031 387.4063,805.1094 C387.4688,805.5156 387.5,805.6406 387.6406,805.7656 C387.7813,805.9063 388.0156,806.0156 388.2344,806.0156 C388.5,806.0156 388.7656,805.875 388.9375,805.6563 C389.0469,805.5 389.0781,805.3125 389.0781,804.8906 L389.0781,803.4688 C389.0781,803.0313 389.0625,802.9063 388.9688,802.75 C388.8125,802.4844 388.5313,802.3438 388.2344,802.3438 C387.9375,802.3438 387.7344,802.4375 387.5156,802.75 L387.3438,802.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="190" x="399" y="811.8467">JwtAuthenticationProvider</text><line style="stroke:#181818;stroke-width:0.5;" x1="371" x2="591" y1="823" y2="823"/><line style="stroke:#181818;stroke-width:0.5;" x1="371" x2="591" y1="831" y2="831"/></g><!--MD5=[86b30c3e0fe779331a576db045bd0856]
class SecurityContext--><g id="elem_SecurityContext"><rect codeLine="24" fill="#F1F1F1" height="48" id="SecurityContext" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="145" x="427.5" y="116"/><ellipse cx="442.5" cy="132" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M443.4531,128.7813 L445.1719,128.7813 C445.5625,128.7813 445.75,128.75 445.875,128.6719 C446.1406,128.5156 446.2813,128.2344 446.2813,127.9375 C446.2813,127.6719 446.1719,127.4063 445.9375,127.2344 C445.7656,127.125 445.625,127.0938 445.1719,127.0938 L440.0313,127.0938 C439.5938,127.0938 439.4688,127.1094 439.3125,127.2031 C439.0625,127.3594 438.9063,127.6563 438.9063,127.9375 C438.9063,128.2188 439.0469,128.4688 439.2656,128.6406 C439.4219,128.75 439.6094,128.7813 440.0313,128.7813 L441.75,128.7813 L441.75,135.2969 L440.0313,135.2969 C439.5938,135.2969 439.4688,135.3125 439.3125,135.4219 C439.0625,135.5781 438.9063,135.8594 438.9063,136.1563 C438.9063,136.4063 439.0469,136.6719 439.2656,136.8281 C439.4219,136.9531 439.625,137 440.0313,137 L445.1719,137 C445.9219,137 446.2813,136.7188 446.2813,136.1563 C446.2813,135.875 446.1719,135.625 445.9375,135.4531 C445.7656,135.3281 445.625,135.2969 445.1719,135.2969 L443.4531,135.2969 L443.4531,128.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="113" x="456.5" y="136.8467">SecurityContext</text><line style="stroke:#181818;stroke-width:0.5;" x1="428.5" x2="571.5" y1="148" y2="148"/><line style="stroke:#181818;stroke-width:0.5;" x1="428.5" x2="571.5" y1="156" y2="156"/></g><!--MD5=[434a86a25993eeeea880c43cffc3083d]
class SecurityContextHolder--><g id="elem_SecurityContextHolder"><rect codeLine="25" fill="#F1F1F1" height="48" id="SecurityContextHolder" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="197" x="401.5" y="7"/><ellipse cx="416.5" cy="23" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M418.8438,18.6719 C417.9063,18.2344 417.3125,18.0938 416.4375,18.0938 C413.8125,18.0938 411.8125,20.1719 411.8125,22.8906 L411.8125,24.0156 C411.8125,26.5938 413.9219,28.4844 416.8125,28.4844 C418.0313,28.4844 419.1875,28.1875 419.9375,27.6406 C420.5156,27.2344 420.8438,26.7813 420.8438,26.3906 C420.8438,25.9375 420.4531,25.5469 419.9844,25.5469 C419.7656,25.5469 419.5625,25.625 419.375,25.8125 C418.9219,26.2969 418.9219,26.2969 418.7344,26.3906 C418.3125,26.6563 417.625,26.7813 416.8594,26.7813 C414.8125,26.7813 413.5156,25.6875 413.5156,23.9844 L413.5156,22.8906 C413.5156,21.1094 414.7656,19.7969 416.5,19.7969 C417.0781,19.7969 417.6875,19.9531 418.1563,20.2031 C418.6406,20.4844 418.8125,20.7031 418.9063,21.1094 C418.9688,21.5156 419,21.6406 419.1406,21.7656 C419.2813,21.9063 419.5156,22.0156 419.7344,22.0156 C420,22.0156 420.2656,21.875 420.4375,21.6563 C420.5469,21.5 420.5781,21.3125 420.5781,20.8906 L420.5781,19.4688 C420.5781,19.0313 420.5625,18.9063 420.4688,18.75 C420.3125,18.4844 420.0313,18.3438 419.7344,18.3438 C419.4375,18.3438 419.2344,18.4375 419.0156,18.75 L418.8438,18.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="165" x="430.5" y="27.8467">SecurityContextHolder</text><line style="stroke:#181818;stroke-width:0.5;" x1="402.5" x2="597.5" y1="39" y2="39"/><line style="stroke:#181818;stroke-width:0.5;" x1="402.5" x2="597.5" y1="47" y2="47"/></g><!--MD5=[b00487d6bf686e0753c86de455de36ac]
link AbstractAuthenticationProcessingFilter to Authentication--><g id="link_AbstractAuthenticationProcessingFilter_Authentication"><path codeLine="9" d="M248.298,164.292 C254.397,178.365 263.067,196.351 273,211 C278.911,219.718 285.672,228.45 292.687,236.826 " fill="none" id="AbstractAuthenticationProcessingFilter-to-Authentication" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="296.149,240.908,293.3795,231.4565,292.9154,237.0943,287.2777,236.6302,296.149,240.908" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="274" y="207.0669">get input from request</text></g><!--MD5=[25fdd9560b2de9b6208e0d2d975a4377]
reverse link AuthenticationManager to ProviderManager--><g id="link_AuthenticationManager_ProviderManager"><path d="M351,499.578 C351,513.362 351,528.057 351,539.828 " fill="none" id="AuthenticationManager-backto-ProviderManager" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="344,499.217,351,479.217,358,499.217,344,499.217" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[83bcadf0d29904e4dce5e049716729f3]
link ProviderManager to AuthenticationProvider--><g id="link_ProviderManager_AuthenticationProvider"><path codeLine="17" d="M351,600.229 C351,600.229 351,624.201 351,635.676 " fill="none" id="ProviderManager-AuthenticationProvider" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="351,648.856,355,639.856,351,643.856,347,639.856,351,648.856" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="351" x2="351" y1="643.856" y2="635.856"/><polygon fill="#181818" points="351,588.229,347,594.229,351,600.229,355,594.229,351,588.229" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="342.025" y="608.046">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="7" x="343.4203" y="637.9937">*</text></g><!--MD5=[aeed24337b800ae79537f0bf711a382a]
reverse link AuthenticationProvider to DaoAuthenticationProvider--><g id="link_AuthenticationProvider_DaoAuthenticationProvider"><path d="M294.632,744.0491 C277.362,760.4558 259.265,777.6487 245.333,790.8838 " fill="none" id="AuthenticationProvider-backto-DaoAuthenticationProvider" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="289.83,738.956,309.152,730.256,299.473,749.106,289.83,738.956" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[cd65c48639d911a24e85236a1de7faec]
reverse link AuthenticationProvider to JwtAuthenticationProvider--><g id="link_AuthenticationProvider_JwtAuthenticationProvider"><path d="M407.368,744.0491 C424.638,760.4558 442.735,777.6487 456.667,790.8838 " fill="none" id="AuthenticationProvider-backto-JwtAuthenticationProvider" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="402.527,749.106,392.848,730.256,412.17,738.956,402.527,749.106" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[21ef70cdb7a5d5f81f0a3e417597dad7]
link Authentication to AuthenticationManager--><g id="link_Authentication_AuthenticationManager"><path codeLine="21" d="M259.59,354.241 C247.402,368.462 242.085,384.445 252,401 C258.677,412.148 268.588,421.083 279.596,428.203 " fill="none" id="Authentication-to-AuthenticationManager" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="284.033,430.943,278.4791,422.8095,279.7794,428.3149,274.2741,429.6152,284.033,430.943" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="253" y="397.0669">input for authentication</text></g><!--MD5=[966acda81ffd9e35fc1fad5309d012f6]
link AuthenticationManager to Authentication--><g id="link_AuthenticationManager_Authentication"><path codeLine="22" d="M386.783,430.963 C401.266,418.506 413.45,402 408,384 C405.383,375.356 401.572,366.787 397.141,358.602 " fill="none" id="AuthenticationManager-to-Authentication" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="394.62,354.096,395.5244,363.9032,397.0617,358.4593,402.5056,359.9966,394.62,354.096" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="410" y="397.0669">get success response</text></g><!--MD5=[bbe5e9cfe640d9801466b518a1b0ec10]
link SecurityContextHolder to SecurityContext--><g id="link_SecurityContextHolder_SecurityContext"><path codeLine="26" d="M500,67.217 C500,67.217 500,91.502 500,102.563 " fill="none" id="SecurityContextHolder-SecurityContext" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="500,115.828,504,106.828,500,110.828,496,106.828,500,115.828" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="500" x2="500" y1="110.828" y2="102.828"/><polygon fill="#181818" points="500,55.217,496,61.217,500,67.217,504,61.217,500,55.217" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="491.025" y="75.0311">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="490.975" y="104.796">1</text></g><!--MD5=[975aa200029110868636c73963594511]
link SecurityContext to Authentication--><g id="link_SecurityContext_Authentication"><path codeLine="27" d="M469.3903,172.944 C469.3903,172.944 432.543,211.4 413.606,231.163 " fill="none" id="SecurityContext-Authentication" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="404.416,240.754,413.531,237.0235,407.8755,237.144,407.755,231.4884,404.416,240.754" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="407.8755" x2="413.41" y1="237.144" y2="231.367"/><polygon fill="#181818" points="477.693,164.28,470.6536,165.8444,469.3903,172.944,476.4297,171.3796,477.693,164.28" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="448" y="207.0669">after autenticate sucess</text></g><!--MD5=[af7ebaa83f254726714aac3fbb9bb6a5]
@startuml
interface Authentication {
    Collection<? extends GrantedAuthority> getAuthorities(); // 权限信息
    Object getCredentials(); // 用户校验信息
    Object getDetails();
    Object getPrincipal(); // 用户标识信息
}
abstract class AbstractAuthenticationProcessingFilter

AbstractAuthenticationProcessingFilter - -> Authentication: get input from request

interface AuthenticationManager
class ProviderManager implements AuthenticationManager
interface AuthenticationProvider {
    Authentication authenticate(Authentication authentication) throws AuthenticationException;
    boolean supports(Class<?> authentication);
}
ProviderManager "1" *- -> "*" AuthenticationProvider
class DaoAuthenticationProvider implements AuthenticationProvider
class JwtAuthenticationProvider implements AuthenticationProvider

Authentication - -> AuthenticationManager: input for authentication
AuthenticationManager - -> Authentication: get success response

interface SecurityContext
class SecurityContextHolder
SecurityContextHolder "1" *- -> "1" SecurityContext
SecurityContext *- -> Authentication: after autenticate sucess
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<p><img src="/2021/02/spring-security/authentication/providermanagers-parent.png"></p>
<h2 id="常见的认证方式"><a href="#常见的认证方式" class="headerlink" title="常见的认证方式"></a>常见的认证方式</h2><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="113px" preserveAspectRatio="none" style="width:431px;height:113px;background:#FFFFFF;" version="1.1" viewBox="0 0 431 113" width="431px" zoomAndPan="magnify"><defs/><g><rect height="95.4844" style="stroke:#00000000;stroke-width:1.0;fill:none;" width="413" x="5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="10" y="24.9951"> </text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="105" x="15" y="24.9951">常见的认证方式</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="120" y="24.9951"> </text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="154" y="24.9951"> </text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="154" x="159" y="24.9951">Spring Security实现</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="313" y="24.9951"> </text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="134" x="15" y="41.292">Basic/FormLogin</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="221" x="159" y="41.292">DaoAuthenticationProvider</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="61" x="15" y="57.5889">OAuth2</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="30" x="159" y="57.5889">待续</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="41" x="15" y="73.8857">LDAP</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="30" x="159" y="73.8857">待续</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="105" x="15" y="90.1826">通过第三方认证</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="249" x="159" y="90.1826">Pre-Authentication Framework</text><line style="stroke:#000000;stroke-width:1.0;" x1="10" x2="413" y1="12" y2="12"/><line style="stroke:#000000;stroke-width:1.0;" x1="10" x2="413" y1="28.2969" y2="28.2969"/><line style="stroke:#000000;stroke-width:1.0;" x1="10" x2="413" y1="44.5938" y2="44.5938"/><line style="stroke:#000000;stroke-width:1.0;" x1="10" x2="413" y1="60.8906" y2="60.8906"/><line style="stroke:#000000;stroke-width:1.0;" x1="10" x2="413" y1="77.1875" y2="77.1875"/><line style="stroke:#000000;stroke-width:1.0;" x1="10" x2="413" y1="93.4844" y2="93.4844"/><line style="stroke:#000000;stroke-width:1.0;" x1="10" x2="10" y1="12" y2="93.4844"/><line style="stroke:#000000;stroke-width:1.0;" x1="154" x2="154" y1="12" y2="93.4844"/><line style="stroke:#000000;stroke-width:1.0;" x1="413" x2="413" y1="12" y2="93.4844"/><!--MD5=[5717be06fd5ba7d5199372f176aa0c85]
@startuml
title
|= **常见的认证方式** |= **Spring Security实现** |
| Basic/FormLogin | DaoAuthenticationProvider |
| OAuth2 | 待续 |
| LDAP | 待续 |
| 通过第三方认证 | Pre-Authentication Framework |
end title
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<h3 id="DaoAuthenticationProvider对Basic-FormLogin的支持"><a href="#DaoAuthenticationProvider对Basic-FormLogin的支持" class="headerlink" title="DaoAuthenticationProvider对Basic/FormLogin的支持"></a>DaoAuthenticationProvider对Basic/FormLogin的支持</h3><p>用于对username/password这种形式的认证信息进行校验,<br>认证信息通过<strong>UsernamePasswordAuthenticationToken</strong>进行包装.<br>其中password可以从本地服务中获取.</p>
<h4 id="FormLogin流程"><a href="#FormLogin流程" class="headerlink" title="FormLogin流程"></a>FormLogin流程</h4><p><img src="/2021/02/spring-security/authentication/loginurlauthenticationentrypoint.png"></p>
<p><img src="/2021/02/spring-security/authentication/usernamepasswordauthenticationfilter.png"></p>
<ul>
<li>LoginUrlAuthenticationEntryPoint, 在认证失败时, 重导向到登录页面</li>
<li>UsernamePasswordAuthenticationFilter处理登录页面的认证请求</li>
</ul>
<h4 id="Basic流程"><a href="#Basic流程" class="headerlink" title="Basic流程"></a>Basic流程</h4><p><img src="/2021/02/spring-security/authentication/basicauthenticationentrypoint.png"></p>
<p><img src="/2021/02/spring-security/authentication/basicauthenticationfilter.png"></p>
<ul>
<li>BasicAuthenticationEntryPoint, 在认证失败时返回WWW-Authenticate头信息</li>
<li>BasicAuthenticationFilter, 处理Basic认证请求</li>
</ul>
<h4 id="DaoAuthenticationProvider的设计"><a href="#DaoAuthenticationProvider的设计" class="headerlink" title="DaoAuthenticationProvider的设计"></a>DaoAuthenticationProvider的设计</h4><p><img src="/2021/02/spring-security/authentication/daoauthenticationprovider.png"></p>
<hr>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="660px" preserveAspectRatio="none" style="width:1322px;height:660px;background:#FFFFFF;" version="1.1" viewBox="0 0 1322 660" width="1322px" zoomAndPan="magnify"><defs/><g><!--MD5=[a139e992f8a77546bf37c14edd197f06]
class Authentication--><g id="elem_Authentication"><rect codeLine="1" fill="#F1F1F1" height="48" id="Authentication" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="136" x="221" y="358"/><ellipse cx="236" cy="374" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M236.9531,370.7813 L238.6719,370.7813 C239.0625,370.7813 239.25,370.75 239.375,370.6719 C239.6406,370.5156 239.7813,370.2344 239.7813,369.9375 C239.7813,369.6719 239.6719,369.4063 239.4375,369.2344 C239.2656,369.125 239.125,369.0938 238.6719,369.0938 L233.5313,369.0938 C233.0938,369.0938 232.9688,369.1094 232.8125,369.2031 C232.5625,369.3594 232.4063,369.6563 232.4063,369.9375 C232.4063,370.2188 232.5469,370.4688 232.7656,370.6406 C232.9219,370.75 233.1094,370.7813 233.5313,370.7813 L235.25,370.7813 L235.25,377.2969 L233.5313,377.2969 C233.0938,377.2969 232.9688,377.3125 232.8125,377.4219 C232.5625,377.5781 232.4063,377.8594 232.4063,378.1563 C232.4063,378.4063 232.5469,378.6719 232.7656,378.8281 C232.9219,378.9531 233.125,379 233.5313,379 L238.6719,379 C239.4219,379 239.7813,378.7188 239.7813,378.1563 C239.7813,377.875 239.6719,377.625 239.4375,377.4531 C239.2656,377.3281 239.125,377.2969 238.6719,377.2969 L236.9531,377.2969 L236.9531,370.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="104" x="250" y="378.8467">Authentication</text><line style="stroke:#181818;stroke-width:0.5;" x1="222" x2="356" y1="390" y2="390"/><line style="stroke:#181818;stroke-width:0.5;" x1="222" x2="356" y1="398" y2="398"/></g><!--MD5=[11ccd37da9cde826af907da9156f9e97]
class UsernamePasswordAuthenticationToken--><g id="elem_UsernamePasswordAuthenticationToken"><rect codeLine="2" fill="#F1F1F1" height="48" id="UsernamePasswordAuthenticationToken" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="322" x="7" y="548"/><ellipse cx="22" cy="564" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M24.3438,559.6719 C23.4063,559.2344 22.8125,559.0938 21.9375,559.0938 C19.3125,559.0938 17.3125,561.1719 17.3125,563.8906 L17.3125,565.0156 C17.3125,567.5938 19.4219,569.4844 22.3125,569.4844 C23.5313,569.4844 24.6875,569.1875 25.4375,568.6406 C26.0156,568.2344 26.3438,567.7813 26.3438,567.3906 C26.3438,566.9375 25.9531,566.5469 25.4844,566.5469 C25.2656,566.5469 25.0625,566.625 24.875,566.8125 C24.4219,567.2969 24.4219,567.2969 24.2344,567.3906 C23.8125,567.6563 23.125,567.7813 22.3594,567.7813 C20.3125,567.7813 19.0156,566.6875 19.0156,564.9844 L19.0156,563.8906 C19.0156,562.1094 20.2656,560.7969 22,560.7969 C22.5781,560.7969 23.1875,560.9531 23.6563,561.2031 C24.1406,561.4844 24.3125,561.7031 24.4063,562.1094 C24.4688,562.5156 24.5,562.6406 24.6406,562.7656 C24.7813,562.9063 25.0156,563.0156 25.2344,563.0156 C25.5,563.0156 25.7656,562.875 25.9375,562.6563 C26.0469,562.5 26.0781,562.3125 26.0781,561.8906 L26.0781,560.4688 C26.0781,560.0313 26.0625,559.9063 25.9688,559.75 C25.8125,559.4844 25.5313,559.3438 25.2344,559.3438 C24.9375,559.3438 24.7344,559.4375 24.5156,559.75 L24.3438,559.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="290" x="36" y="568.8467">UsernamePasswordAuthenticationToken</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="328" y1="580" y2="580"/><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="328" y1="588" y2="588"/></g><!--MD5=[46be0f02d3ccb60e27af689741ef5b84]
class UserDetails--><g id="elem_UserDetails"><rect codeLine="4" fill="#F1F1F1" height="162.0781" id="UserDetails" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="431" x="364.5" y="491"/><ellipse cx="535.25" cy="507" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M536.2031,503.7813 L537.9219,503.7813 C538.3125,503.7813 538.5,503.75 538.625,503.6719 C538.8906,503.5156 539.0313,503.2344 539.0313,502.9375 C539.0313,502.6719 538.9219,502.4063 538.6875,502.2344 C538.5156,502.125 538.375,502.0938 537.9219,502.0938 L532.7813,502.0938 C532.3438,502.0938 532.2188,502.1094 532.0625,502.2031 C531.8125,502.3594 531.6563,502.6563 531.6563,502.9375 C531.6563,503.2188 531.7969,503.4688 532.0156,503.6406 C532.1719,503.75 532.3594,503.7813 532.7813,503.7813 L534.5,503.7813 L534.5,510.2969 L532.7813,510.2969 C532.3438,510.2969 532.2188,510.3125 532.0625,510.4219 C531.8125,510.5781 531.6563,510.8594 531.6563,511.1563 C531.6563,511.4063 531.7969,511.6719 532.0156,511.8281 C532.1719,511.9531 532.375,512 532.7813,512 L537.9219,512 C538.6719,512 539.0313,511.7188 539.0313,511.1563 C539.0313,510.875 538.9219,510.625 538.6875,510.4531 C538.5156,510.3281 538.375,510.2969 537.9219,510.2969 L536.2031,510.2969 L536.2031,503.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="81" x="555.75" y="511.8467">UserDetails</text><line style="stroke:#181818;stroke-width:0.5;" x1="365.5" x2="794.5" y1="523" y2="523"/><line style="stroke:#181818;stroke-width:0.5;" x1="365.5" x2="794.5" y1="531" y2="531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="419" x="370.5" y="547.9951">Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="154" x="370.5" y="564.292">String getPassword();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="159" x="370.5" y="580.5889">String getUsername();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="230" x="370.5" y="596.8857">boolean isAccountNonExpired();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="227" x="370.5" y="613.1826">boolean isAccountNonLocked();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="253" x="370.5" y="629.4795">boolean isCredentialsNonExpired();</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="146" x="370.5" y="645.7764">boolean isEnabled();</text></g><!--MD5=[f107d47aaaf8c36237664e7a50bee098]
class UserDetailsService--><g id="elem_UserDetailsService"><rect codeLine="13" fill="#F1F1F1" height="64.2969" id="UserDetailsService" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="650" x="392" y="350"/><ellipse cx="645.75" cy="366" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M646.7031,362.7813 L648.4219,362.7813 C648.8125,362.7813 649,362.75 649.125,362.6719 C649.3906,362.5156 649.5313,362.2344 649.5313,361.9375 C649.5313,361.6719 649.4219,361.4063 649.1875,361.2344 C649.0156,361.125 648.875,361.0938 648.4219,361.0938 L643.2813,361.0938 C642.8438,361.0938 642.7188,361.1094 642.5625,361.2031 C642.3125,361.3594 642.1563,361.6563 642.1563,361.9375 C642.1563,362.2188 642.2969,362.4688 642.5156,362.6406 C642.6719,362.75 642.8594,362.7813 643.2813,362.7813 L645,362.7813 L645,369.2969 L643.2813,369.2969 C642.8438,369.2969 642.7188,369.3125 642.5625,369.4219 C642.3125,369.5781 642.1563,369.8594 642.1563,370.1563 C642.1563,370.4063 642.2969,370.6719 642.5156,370.8281 C642.6719,370.9531 642.875,371 643.2813,371 L648.4219,371 C649.1719,371 649.5313,370.7188 649.5313,370.1563 C649.5313,369.875 649.4219,369.625 649.1875,369.4531 C649.0156,369.3281 648.875,369.2969 648.4219,369.2969 L646.7031,369.2969 L646.7031,362.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="134" x="666.25" y="370.8467">UserDetailsService</text><line style="stroke:#181818;stroke-width:0.5;" x1="393" x2="1041" y1="382" y2="382"/><line style="stroke:#181818;stroke-width:0.5;" x1="393" x2="1041" y1="390" y2="390"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="638" x="398" y="406.9951">UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;</text></g><!--MD5=[4e882bed8fc05804831fd4dd919c29f3]
class InMemoryUserDetailsManager--><g id="elem_InMemoryUserDetailsManager"><rect codeLine="17" fill="#F1F1F1" height="48" id="InMemoryUserDetailsManager" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="245" x="830.5" y="548"/><ellipse cx="845.5" cy="564" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M847.8438,559.6719 C846.9063,559.2344 846.3125,559.0938 845.4375,559.0938 C842.8125,559.0938 840.8125,561.1719 840.8125,563.8906 L840.8125,565.0156 C840.8125,567.5938 842.9219,569.4844 845.8125,569.4844 C847.0313,569.4844 848.1875,569.1875 848.9375,568.6406 C849.5156,568.2344 849.8438,567.7813 849.8438,567.3906 C849.8438,566.9375 849.4531,566.5469 848.9844,566.5469 C848.7656,566.5469 848.5625,566.625 848.375,566.8125 C847.9219,567.2969 847.9219,567.2969 847.7344,567.3906 C847.3125,567.6563 846.625,567.7813 845.8594,567.7813 C843.8125,567.7813 842.5156,566.6875 842.5156,564.9844 L842.5156,563.8906 C842.5156,562.1094 843.7656,560.7969 845.5,560.7969 C846.0781,560.7969 846.6875,560.9531 847.1563,561.2031 C847.6406,561.4844 847.8125,561.7031 847.9063,562.1094 C847.9688,562.5156 848,562.6406 848.1406,562.7656 C848.2813,562.9063 848.5156,563.0156 848.7344,563.0156 C849,563.0156 849.2656,562.875 849.4375,562.6563 C849.5469,562.5 849.5781,562.3125 849.5781,561.8906 L849.5781,560.4688 C849.5781,560.0313 849.5625,559.9063 849.4688,559.75 C849.3125,559.4844 849.0313,559.3438 848.7344,559.3438 C848.4375,559.3438 848.2344,559.4375 848.0156,559.75 L847.8438,559.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="213" x="859.5" y="568.8467">InMemoryUserDetailsManager</text><line style="stroke:#181818;stroke-width:0.5;" x1="831.5" x2="1074.5" y1="580" y2="580"/><line style="stroke:#181818;stroke-width:0.5;" x1="831.5" x2="1074.5" y1="588" y2="588"/></g><!--MD5=[65bfb2e110df778e1b55eaba9937d5d6]
class JdbcUserDetailsManager--><g id="elem_JdbcUserDetailsManager"><rect codeLine="18" fill="#F1F1F1" height="48" id="JdbcUserDetailsManager" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="205" x="1110.5" y="548"/><ellipse cx="1125.5" cy="564" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1127.8438,559.6719 C1126.9063,559.2344 1126.3125,559.0938 1125.4375,559.0938 C1122.8125,559.0938 1120.8125,561.1719 1120.8125,563.8906 L1120.8125,565.0156 C1120.8125,567.5938 1122.9219,569.4844 1125.8125,569.4844 C1127.0313,569.4844 1128.1875,569.1875 1128.9375,568.6406 C1129.5156,568.2344 1129.8438,567.7813 1129.8438,567.3906 C1129.8438,566.9375 1129.4531,566.5469 1128.9844,566.5469 C1128.7656,566.5469 1128.5625,566.625 1128.375,566.8125 C1127.9219,567.2969 1127.9219,567.2969 1127.7344,567.3906 C1127.3125,567.6563 1126.625,567.7813 1125.8594,567.7813 C1123.8125,567.7813 1122.5156,566.6875 1122.5156,564.9844 L1122.5156,563.8906 C1122.5156,562.1094 1123.7656,560.7969 1125.5,560.7969 C1126.0781,560.7969 1126.6875,560.9531 1127.1563,561.2031 C1127.6406,561.4844 1127.8125,561.7031 1127.9063,562.1094 C1127.9688,562.5156 1128,562.6406 1128.1406,562.7656 C1128.2813,562.9063 1128.5156,563.0156 1128.7344,563.0156 C1129,563.0156 1129.2656,562.875 1129.4375,562.6563 C1129.5469,562.5 1129.5781,562.3125 1129.5781,561.8906 L1129.5781,560.4688 C1129.5781,560.0313 1129.5625,559.9063 1129.4688,559.75 C1129.3125,559.4844 1129.0313,559.3438 1128.7344,559.3438 C1128.4375,559.3438 1128.2344,559.4375 1128.0156,559.75 L1127.8438,559.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="173" x="1139.5" y="568.8467">JdbcUserDetailsManager</text><line style="stroke:#181818;stroke-width:0.5;" x1="1111.5" x2="1314.5" y1="580" y2="580"/><line style="stroke:#181818;stroke-width:0.5;" x1="1111.5" x2="1314.5" y1="588" y2="588"/></g><!--MD5=[f2f4f081f533f1801637718551dd4ff8]
class PasswordEncoder--><g id="elem_PasswordEncoder"><rect codeLine="20" fill="#F1F1F1" height="48" id="PasswordEncoder" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="157" x="1077.5" y="358"/><ellipse cx="1092.5" cy="374" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1093.4531,370.7813 L1095.1719,370.7813 C1095.5625,370.7813 1095.75,370.75 1095.875,370.6719 C1096.1406,370.5156 1096.2813,370.2344 1096.2813,369.9375 C1096.2813,369.6719 1096.1719,369.4063 1095.9375,369.2344 C1095.7656,369.125 1095.625,369.0938 1095.1719,369.0938 L1090.0313,369.0938 C1089.5938,369.0938 1089.4688,369.1094 1089.3125,369.2031 C1089.0625,369.3594 1088.9063,369.6563 1088.9063,369.9375 C1088.9063,370.2188 1089.0469,370.4688 1089.2656,370.6406 C1089.4219,370.75 1089.6094,370.7813 1090.0313,370.7813 L1091.75,370.7813 L1091.75,377.2969 L1090.0313,377.2969 C1089.5938,377.2969 1089.4688,377.3125 1089.3125,377.4219 C1089.0625,377.5781 1088.9063,377.8594 1088.9063,378.1563 C1088.9063,378.4063 1089.0469,378.6719 1089.2656,378.8281 C1089.4219,378.9531 1089.625,379 1090.0313,379 L1095.1719,379 C1095.9219,379 1096.2813,378.7188 1096.2813,378.1563 C1096.2813,377.875 1096.1719,377.625 1095.9375,377.4531 C1095.7656,377.3281 1095.625,377.2969 1095.1719,377.2969 L1093.4531,377.2969 L1093.4531,370.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="125" x="1106.5" y="378.8467">PasswordEncoder</text><line style="stroke:#181818;stroke-width:0.5;" x1="1078.5" x2="1233.5" y1="390" y2="390"/><line style="stroke:#181818;stroke-width:0.5;" x1="1078.5" x2="1233.5" y1="398" y2="398"/></g><!--MD5=[e50894ae502f944247a776c1db7e5ae2]
class AbstractUserDetailsAuthenticationProvider--><g id="elem_AbstractUserDetailsAuthenticationProvider"><rect codeLine="22" fill="#F1F1F1" height="48" id="AbstractUserDetailsAuthenticationProvider" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="335" x="20.5" y="116"/><ellipse cx="35.5" cy="132" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M37.5781,133.8125 L37.9688,134.7969 L37.5781,134.7969 C37.125,134.7969 37.0156,134.8125 36.8594,134.9219 C36.6094,135.0781 36.4531,135.3594 36.4531,135.6563 C36.4531,135.9219 36.5938,136.1719 36.8125,136.3281 C36.9531,136.4531 37.1563,136.5 37.5781,136.5 L39.9375,136.5 C40.2969,136.5 40.5156,136.4688 40.6563,136.375 C40.9063,136.2344 41.0625,135.9375 41.0625,135.6563 C41.0625,135.375 40.9219,135.125 40.7031,134.9688 C40.5313,134.8281 40.375,134.7969 39.9063,134.7969 L36.5156,126.5938 L32.8438,126.5938 C32.3906,126.5938 32.2656,126.6094 32.1094,126.7031 C31.8594,126.875 31.7031,127.1563 31.7031,127.4375 C31.7031,127.7188 31.8438,127.9688 32.0625,128.1406 C32.2344,128.25 32.4063,128.2813 32.8438,128.2813 L33.9219,128.2813 L31.2813,134.7969 C30.8594,134.7969 30.7031,134.8125 30.5469,134.9219 C30.2969,135.0781 30.1406,135.3594 30.1406,135.6563 C30.1406,136.2188 30.5156,136.5 31.2656,136.5 L33.5313,136.5 C33.8906,136.5 34.1094,136.4688 34.2344,136.375 C34.5,136.2344 34.6406,135.9375 34.6406,135.6563 C34.6406,135.375 34.5156,135.125 34.2969,134.9531 C34.125,134.8281 33.9844,134.7969 33.5313,134.7969 L33.1406,134.7969 L33.5313,133.8125 L37.5781,133.8125 Z M36.875,132.1094 L34.2031,132.1094 L35.5469,128.8438 L36.875,132.1094 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="303" x="49.5" y="136.8467">AbstractUserDetailsAuthenticationProvider</text><line style="stroke:#181818;stroke-width:0.5;" x1="21.5" x2="354.5" y1="148" y2="148"/><line style="stroke:#181818;stroke-width:0.5;" x1="21.5" x2="354.5" y1="156" y2="156"/></g><!--MD5=[f074fdee743888442a4f97901e556f9c]
class AuthenticationProvider--><g id="elem_AuthenticationProvider"><rect fill="#F1F1F1" height="48" id="AuthenticationProvider" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="195" x="90.5" y="7"/><ellipse cx="105.5" cy="23" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M106.4531,19.7813 L108.1719,19.7813 C108.5625,19.7813 108.75,19.75 108.875,19.6719 C109.1406,19.5156 109.2813,19.2344 109.2813,18.9375 C109.2813,18.6719 109.1719,18.4063 108.9375,18.2344 C108.7656,18.125 108.625,18.0938 108.1719,18.0938 L103.0313,18.0938 C102.5938,18.0938 102.4688,18.1094 102.3125,18.2031 C102.0625,18.3594 101.9063,18.6563 101.9063,18.9375 C101.9063,19.2188 102.0469,19.4688 102.2656,19.6406 C102.4219,19.75 102.6094,19.7813 103.0313,19.7813 L104.75,19.7813 L104.75,26.2969 L103.0313,26.2969 C102.5938,26.2969 102.4688,26.3125 102.3125,26.4219 C102.0625,26.5781 101.9063,26.8594 101.9063,27.1563 C101.9063,27.4063 102.0469,27.6719 102.2656,27.8281 C102.4219,27.9531 102.625,28 103.0313,28 L108.1719,28 C108.9219,28 109.2813,27.7188 109.2813,27.1563 C109.2813,26.875 109.1719,26.625 108.9375,26.4531 C108.7656,26.3281 108.625,26.2969 108.1719,26.2969 L106.4531,26.2969 L106.4531,19.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="163" x="119.5" y="27.8467">AuthenticationProvider</text><line style="stroke:#181818;stroke-width:0.5;" x1="91.5" x2="284.5" y1="39" y2="39"/><line style="stroke:#181818;stroke-width:0.5;" x1="91.5" x2="284.5" y1="47" y2="47"/></g><!--MD5=[3e6b436126ba7aa842e4929fc17143d3]
class DaoAuthenticationProvider--><g id="elem_DaoAuthenticationProvider"><rect codeLine="25" fill="#F1F1F1" height="48" id="DaoAuthenticationProvider" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="228" x="412" y="225"/><ellipse cx="427" cy="241" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M429.3438,236.6719 C428.4063,236.2344 427.8125,236.0938 426.9375,236.0938 C424.3125,236.0938 422.3125,238.1719 422.3125,240.8906 L422.3125,242.0156 C422.3125,244.5938 424.4219,246.4844 427.3125,246.4844 C428.5313,246.4844 429.6875,246.1875 430.4375,245.6406 C431.0156,245.2344 431.3438,244.7813 431.3438,244.3906 C431.3438,243.9375 430.9531,243.5469 430.4844,243.5469 C430.2656,243.5469 430.0625,243.625 429.875,243.8125 C429.4219,244.2969 429.4219,244.2969 429.2344,244.3906 C428.8125,244.6563 428.125,244.7813 427.3594,244.7813 C425.3125,244.7813 424.0156,243.6875 424.0156,241.9844 L424.0156,240.8906 C424.0156,239.1094 425.2656,237.7969 427,237.7969 C427.5781,237.7969 428.1875,237.9531 428.6563,238.2031 C429.1406,238.4844 429.3125,238.7031 429.4063,239.1094 C429.4688,239.5156 429.5,239.6406 429.6406,239.7656 C429.7813,239.9063 430.0156,240.0156 430.2344,240.0156 C430.5,240.0156 430.7656,239.875 430.9375,239.6563 C431.0469,239.5 431.0781,239.3125 431.0781,238.8906 L431.0781,237.4688 C431.0781,237.0313 431.0625,236.9063 430.9688,236.75 C430.8125,236.4844 430.5313,236.3438 430.2344,236.3438 C429.9375,236.3438 429.7344,236.4375 429.5156,236.75 L429.3438,236.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="196" x="441" y="245.8467">DaoAuthenticationProvider</text><line style="stroke:#181818;stroke-width:0.5;" x1="413" x2="639" y1="257" y2="257"/><line style="stroke:#181818;stroke-width:0.5;" x1="413" x2="639" y1="265" y2="265"/></g><!--MD5=[870d52f46d07a550b9e9374cff9acf4c]
reverse link Authentication to UsernamePasswordAuthenticationToken--><g id="link_Authentication_UsernamePasswordAuthenticationToken"><path d="M263.212,423.068 C238.795,461.004 202.98,516.651 182.958,547.759 " fill="none" id="Authentication-backto-UsernamePasswordAuthenticationToken" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="257.453,419.082,274.163,406.052,269.225,426.659,257.453,419.082" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[45e387fe18bda4addb889c9c207baf98]
link UserDetailsService to UserDetails--><g id="link_UserDetailsService_UserDetails"><path codeLine="16" d="M694.377,414.044 C679.877,433.942 660.301,460.806 641.445,486.681 " fill="none" id="UserDetailsService-to-UserDetails" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="638.426,490.824,646.9605,485.9085,641.3718,486.7839,640.4963,481.1952,638.426,490.824" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="670" y="457.0669">load by username</text></g><!--MD5=[843ffc135ba8e2ebc716254ed007b36c]
reverse link UserDetailsService to InMemoryUserDetailsManager--><g id="link_UserDetailsService_InMemoryUserDetailsManager"><path d="M773.051,426.69 C780.445,432.495 787.913,438.381 795,444 C840.502,480.077 892.986,522.407 924.549,547.942 " fill="none" id="UserDetailsService-backto-InMemoryUserDetailsManager" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="768.59,432.087,757.162,414.244,777.223,421.066,768.59,432.087" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[89b2dedc39347097d858f0052e95b9d7]
reverse link UserDetailsService to JdbcUserDetailsManager--><g id="link_UserDetailsService_JdbcUserDetailsManager"><path d="M883.519,419.04 C950.313,436.496 1026.96,460.402 1093,491 C1126.17,506.367 1160.54,530.227 1183.95,547.894 " fill="none" id="UserDetailsService-backto-JdbcUserDetailsManager" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="881.688,425.797,864.046,414.059,885.157,412.234,881.688,425.797" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[383be3bbcfe5b0a772fd6df83b5d47e2]
reverse link AuthenticationProvider to AbstractUserDetailsAuthenticationProvider--><g id="link_AuthenticationProvider_AbstractUserDetailsAuthenticationProvider"><path d="M188,75.578 C188,89.362 188,104.057 188,115.828 " fill="none" id="AuthenticationProvider-backto-AbstractUserDetailsAuthenticationProvider" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="181,75.217,188,55.217,195,75.217,181,75.217" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[6c19cc34b9928c48b60274495b655158]
link AbstractUserDetailsAuthenticationProvider to UsernamePasswordAuthenticationToken--><g id="link_AbstractUserDetailsAuthenticationProvider_UsernamePasswordAuthenticationToken"><path codeLine="23" d="M186.925,164.119 C183.527,237.177 173.025,462.954 169.315,542.727 " fill="none" id="AbstractUserDetailsAuthenticationProvider-to-UsernamePasswordAuthenticationToken" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="169.081,547.767,173.4958,538.9631,169.3139,542.7724,165.5045,538.5905,169.081,547.767" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56" x="182" y="316.0669">supports</text></g><!--MD5=[7f30a35ba6832e5a5c31c0a83f5727d0]
reverse link AbstractUserDetailsAuthenticationProvider to DaoAuthenticationProvider--><g id="link_AbstractUserDetailsAuthenticationProvider_DaoAuthenticationProvider"><path d="M280.306,170.221 C334.718,187.446 402.593,208.933 453.206,224.956 " fill="none" id="AbstractUserDetailsAuthenticationProvider-backto-DaoAuthenticationProvider" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="277.88,176.795,260.925,164.086,282.105,163.448,277.88,176.795" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[a831ffdc7adc0dc07e91451c253f7acf]
link DaoAuthenticationProvider to UserDetailsService--><g id="link_DaoAuthenticationProvider_UserDetailsService"><path codeLine="26" d="M569.6027,279.9069 C569.6027,279.9069 632.183,322.827 661.052,342.627 " fill="none" id="DaoAuthenticationProvider-UserDetailsService" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="671.801,350,666.6411,341.611,667.6775,347.1721,662.1164,348.2085,671.801,350" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="667.6775" x2="661.0805" y1="347.1721" y2="342.6465"/><polygon fill="none" points="559.707,273.119,562.3922,279.8115,569.6027,279.9069,566.9175,273.2144,559.707,273.119" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="629" y="316.0669">used to get UserDetails</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="558.9481" y="292.9092">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="653.6537" y="338.9031">1</text></g><!--MD5=[da82cdef0e07b5b6b17f703ca30eab10]
link DaoAuthenticationProvider to PasswordEncoder--><g id="link_DaoAuthenticationProvider_PasswordEncoder"><path codeLine="27" d="M652.0509,268.9593 C652.0509,268.9593 922.411,315.053 1060,350 C1065.2,351.322 1070.54,352.772 1075.9,354.3 " fill="none" id="DaoAuthenticationProvider-PasswordEncoder" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="1088.4,357.984,1080.8964,351.6047,1083.6036,356.5717,1078.6366,359.2789,1088.4,357.984" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1083.6036" x2="1075.925" y1="356.5717" y2="354.308"/><polygon fill="none" points="640.201,267.067,645.4951,271.9631,652.0509,268.9593,646.7567,264.0632,640.201,267.067" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="930" y="316.0669">encode input password</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="648.1426" y="264.8483">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="1062.0525" y="346.9919">1</text></g><!--MD5=[5b74c333b37f88d07bab4f54dc922f4e]
link DaoAuthenticationProvider to Authentication--><g id="link_DaoAuthenticationProvider_Authentication"><path codeLine="29" d="M419.832,273.065 C397.685,280.569 375.244,290.346 356,303 C336.062,316.11 318.678,336.796 306.617,353.571 " fill="none" id="DaoAuthenticationProvider-to-Authentication" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="303.667,357.745,312.1281,352.7041,306.5529,353.6619,305.5951,348.0867,303.667,357.745" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="239" x="357" y="316.0669">create with UserDetails after success</text></g><!--MD5=[94b70b3d7cd3bf9778d7e2cb1ac1f1bc]
@startuml
interface Authentication
class UsernamePasswordAuthenticationToken implements Authentication

interface UserDetails {
    Collection<? extends GrantedAuthority> getAuthorities();
    String getPassword();
    String getUsername();
    boolean isAccountNonExpired();
    boolean isAccountNonLocked();
    boolean isCredentialsNonExpired();
    boolean isEnabled();
}
interface UserDetailsService {
    UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;
}
UserDetailsService - -> UserDetails: load by username
class InMemoryUserDetailsManager implements UserDetailsService
class JdbcUserDetailsManager implements UserDetailsService

interface PasswordEncoder

abstract class AbstractUserDetailsAuthenticationProvider implements AuthenticationProvider
AbstractUserDetailsAuthenticationProvider - -> UsernamePasswordAuthenticationToken: supports

class DaoAuthenticationProvider extends AbstractUserDetailsAuthenticationProvider
DaoAuthenticationProvider "1" o- -> "1" UserDetailsService: used to get UserDetails
DaoAuthenticationProvider "1" o- -> "1" PasswordEncoder: encode input password

DaoAuthenticationProvider - -> Authentication: create with UserDetails after success
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<p>通过UserDetailsService来查询username来获取对应的UserDetails用户信息, 包括用于校验的密码信息.</p>
<p>由于密码往往通过某种加密方式加密后保存,<br>所以需要通过PasswordEncoder对输入的password进行加密后, 再同UserDetails中的密码信息进行比较.</p>
<h3 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h3><p>待续</p>
<h3 id="OAuth2"><a href="#OAuth2" class="headerlink" title="OAuth2"></a>OAuth2</h3><p>待续</p>
<h3 id="Pre-Authentication-Framework对第三方认证的集成"><a href="#Pre-Authentication-Framework对第三方认证的集成" class="headerlink" title="Pre-Authentication Framework对第三方认证的集成"></a>Pre-Authentication Framework对第三方认证的集成</h3><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="454px" preserveAspectRatio="none" style="width:1247px;height:454px;background:#FFFFFF;" version="1.1" viewBox="0 0 1247 454" width="1247px" zoomAndPan="magnify"><defs/><g><!--MD5=[a139e992f8a77546bf37c14edd197f06]
class Authentication--><g id="elem_Authentication"><rect codeLine="1" fill="#F1F1F1" height="48" id="Authentication" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="136" x="7" y="132.5"/><ellipse cx="22" cy="148.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M22.9531,145.2813 L24.6719,145.2813 C25.0625,145.2813 25.25,145.25 25.375,145.1719 C25.6406,145.0156 25.7813,144.7344 25.7813,144.4375 C25.7813,144.1719 25.6719,143.9063 25.4375,143.7344 C25.2656,143.625 25.125,143.5938 24.6719,143.5938 L19.5313,143.5938 C19.0938,143.5938 18.9688,143.6094 18.8125,143.7031 C18.5625,143.8594 18.4063,144.1563 18.4063,144.4375 C18.4063,144.7188 18.5469,144.9688 18.7656,145.1406 C18.9219,145.25 19.1094,145.2813 19.5313,145.2813 L21.25,145.2813 L21.25,151.7969 L19.5313,151.7969 C19.0938,151.7969 18.9688,151.8125 18.8125,151.9219 C18.5625,152.0781 18.4063,152.3594 18.4063,152.6563 C18.4063,152.9063 18.5469,153.1719 18.7656,153.3281 C18.9219,153.4531 19.125,153.5 19.5313,153.5 L24.6719,153.5 C25.4219,153.5 25.7813,153.2188 25.7813,152.6563 C25.7813,152.375 25.6719,152.125 25.4375,151.9531 C25.2656,151.8281 25.125,151.7969 24.6719,151.7969 L22.9531,151.7969 L22.9531,145.2813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="104" x="36" y="153.3467">Authentication</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="142" y1="164.5" y2="164.5"/><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="142" y1="172.5" y2="172.5"/></g><!--MD5=[0a527c260276f2adeb26d462c49f2eb1]
class PreAuthenticatedAuthenticationToken--><g id="elem_PreAuthenticatedAuthenticationToken"><rect codeLine="2" fill="#F1F1F1" height="48" id="PreAuthenticatedAuthenticationToken" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="313" x="280.5" y="282"/><ellipse cx="295.5" cy="298" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M297.8438,293.6719 C296.9063,293.2344 296.3125,293.0938 295.4375,293.0938 C292.8125,293.0938 290.8125,295.1719 290.8125,297.8906 L290.8125,299.0156 C290.8125,301.5938 292.9219,303.4844 295.8125,303.4844 C297.0313,303.4844 298.1875,303.1875 298.9375,302.6406 C299.5156,302.2344 299.8438,301.7813 299.8438,301.3906 C299.8438,300.9375 299.4531,300.5469 298.9844,300.5469 C298.7656,300.5469 298.5625,300.625 298.375,300.8125 C297.9219,301.2969 297.9219,301.2969 297.7344,301.3906 C297.3125,301.6563 296.625,301.7813 295.8594,301.7813 C293.8125,301.7813 292.5156,300.6875 292.5156,298.9844 L292.5156,297.8906 C292.5156,296.1094 293.7656,294.7969 295.5,294.7969 C296.0781,294.7969 296.6875,294.9531 297.1563,295.2031 C297.6406,295.4844 297.8125,295.7031 297.9063,296.1094 C297.9688,296.5156 298,296.6406 298.1406,296.7656 C298.2813,296.9063 298.5156,297.0156 298.7344,297.0156 C299,297.0156 299.2656,296.875 299.4375,296.6563 C299.5469,296.5 299.5781,296.3125 299.5781,295.8906 L299.5781,294.4688 C299.5781,294.0313 299.5625,293.9063 299.4688,293.75 C299.3125,293.4844 299.0313,293.3438 298.7344,293.3438 C298.4375,293.3438 298.2344,293.4375 298.0156,293.75 L297.8438,293.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="281" x="309.5" y="302.8467">PreAuthenticatedAuthenticationToken</text><line style="stroke:#181818;stroke-width:0.5;" x1="281.5" x2="592.5" y1="314" y2="314"/><line style="stroke:#181818;stroke-width:0.5;" x1="281.5" x2="592.5" y1="322" y2="322"/></g><!--MD5=[03ee0ff52a68fae8a05f965fdb6ff93a]
class AbstractPreAuthenticatedProcessingFilter--><g id="elem_AbstractPreAuthenticatedProcessingFilter"><rect codeLine="4" fill="#F1F1F1" height="80.5938" id="AbstractPreAuthenticatedProcessingFilter" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="519" x="178.5" y="116"/><ellipse cx="286.75" cy="132" fill="#A9DCDF" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M288.8281,133.8125 L289.2188,134.7969 L288.8281,134.7969 C288.375,134.7969 288.2656,134.8125 288.1094,134.9219 C287.8594,135.0781 287.7031,135.3594 287.7031,135.6563 C287.7031,135.9219 287.8438,136.1719 288.0625,136.3281 C288.2031,136.4531 288.4063,136.5 288.8281,136.5 L291.1875,136.5 C291.5469,136.5 291.7656,136.4688 291.9063,136.375 C292.1563,136.2344 292.3125,135.9375 292.3125,135.6563 C292.3125,135.375 292.1719,135.125 291.9531,134.9688 C291.7813,134.8281 291.625,134.7969 291.1563,134.7969 L287.7656,126.5938 L284.0938,126.5938 C283.6406,126.5938 283.5156,126.6094 283.3594,126.7031 C283.1094,126.875 282.9531,127.1563 282.9531,127.4375 C282.9531,127.7188 283.0938,127.9688 283.3125,128.1406 C283.4844,128.25 283.6563,128.2813 284.0938,128.2813 L285.1719,128.2813 L282.5313,134.7969 C282.1094,134.7969 281.9531,134.8125 281.7969,134.9219 C281.5469,135.0781 281.3906,135.3594 281.3906,135.6563 C281.3906,136.2188 281.7656,136.5 282.5156,136.5 L284.7813,136.5 C285.1406,136.5 285.3594,136.4688 285.4844,136.375 C285.75,136.2344 285.8906,135.9375 285.8906,135.6563 C285.8906,135.375 285.7656,135.125 285.5469,134.9531 C285.375,134.8281 285.2344,134.7969 284.7813,134.7969 L284.3906,134.7969 L284.7813,133.8125 L288.8281,133.8125 Z M288.125,132.1094 L285.4531,132.1094 L286.7969,128.8438 L288.125,132.1094 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="294" x="307.25" y="136.8467">AbstractPreAuthenticatedProcessingFilter</text><line style="stroke:#181818;stroke-width:0.5;" x1="179.5" x2="696.5" y1="148" y2="148"/><line style="stroke:#181818;stroke-width:0.5;" x1="179.5" x2="696.5" y1="156" y2="156"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="487" x="184.5" y="172.9951">Object getPreAuthenticatedPrincipal(HttpServletRequest request);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="507" x="184.5" y="189.292">Object getPreAuthenticatedCredentials(HttpServletRequest request);</text></g><!--MD5=[5088913581926414f8666565f4476809]
class PreAuthenticatedAuthenticationProvider--><g id="elem_PreAuthenticatedAuthenticationProvider"><rect codeLine="11" fill="#F1F1F1" height="48" id="PreAuthenticatedAuthenticationProvider" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="328" x="736" y="132.5"/><ellipse cx="751" cy="148.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M753.3438,144.1719 C752.4063,143.7344 751.8125,143.5938 750.9375,143.5938 C748.3125,143.5938 746.3125,145.6719 746.3125,148.3906 L746.3125,149.5156 C746.3125,152.0938 748.4219,153.9844 751.3125,153.9844 C752.5313,153.9844 753.6875,153.6875 754.4375,153.1406 C755.0156,152.7344 755.3438,152.2813 755.3438,151.8906 C755.3438,151.4375 754.9531,151.0469 754.4844,151.0469 C754.2656,151.0469 754.0625,151.125 753.875,151.3125 C753.4219,151.7969 753.4219,151.7969 753.2344,151.8906 C752.8125,152.1563 752.125,152.2813 751.3594,152.2813 C749.3125,152.2813 748.0156,151.1875 748.0156,149.4844 L748.0156,148.3906 C748.0156,146.6094 749.2656,145.2969 751,145.2969 C751.5781,145.2969 752.1875,145.4531 752.6563,145.7031 C753.1406,145.9844 753.3125,146.2031 753.4063,146.6094 C753.4688,147.0156 753.5,147.1406 753.6406,147.2656 C753.7813,147.4063 754.0156,147.5156 754.2344,147.5156 C754.5,147.5156 754.7656,147.375 754.9375,147.1563 C755.0469,147 755.0781,146.8125 755.0781,146.3906 L755.0781,144.9688 C755.0781,144.5313 755.0625,144.4063 754.9688,144.25 C754.8125,143.9844 754.5313,143.8438 754.2344,143.8438 C753.9375,143.8438 753.7344,143.9375 753.5156,144.25 L753.3438,144.1719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="296" x="765" y="153.3467">PreAuthenticatedAuthenticationProvider</text><line style="stroke:#181818;stroke-width:0.5;" x1="737" x2="1063" y1="164.5" y2="164.5"/><line style="stroke:#181818;stroke-width:0.5;" x1="737" x2="1063" y1="172.5" y2="172.5"/></g><!--MD5=[f074fdee743888442a4f97901e556f9c]
class AuthenticationProvider--><g id="elem_AuthenticationProvider"><rect fill="#F1F1F1" height="48" id="AuthenticationProvider" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="195" x="802.5" y="7"/><ellipse cx="817.5" cy="23" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M818.4531,19.7813 L820.1719,19.7813 C820.5625,19.7813 820.75,19.75 820.875,19.6719 C821.1406,19.5156 821.2813,19.2344 821.2813,18.9375 C821.2813,18.6719 821.1719,18.4063 820.9375,18.2344 C820.7656,18.125 820.625,18.0938 820.1719,18.0938 L815.0313,18.0938 C814.5938,18.0938 814.4688,18.1094 814.3125,18.2031 C814.0625,18.3594 813.9063,18.6563 813.9063,18.9375 C813.9063,19.2188 814.0469,19.4688 814.2656,19.6406 C814.4219,19.75 814.6094,19.7813 815.0313,19.7813 L816.75,19.7813 L816.75,26.2969 L815.0313,26.2969 C814.5938,26.2969 814.4688,26.3125 814.3125,26.4219 C814.0625,26.5781 813.9063,26.8594 813.9063,27.1563 C813.9063,27.4063 814.0469,27.6719 814.2656,27.8281 C814.4219,27.9531 814.625,28 815.0313,28 L820.1719,28 C820.9219,28 821.2813,27.7188 821.2813,27.1563 C821.2813,26.875 821.1719,26.625 820.9375,26.4531 C820.7656,26.3281 820.625,26.2969 820.1719,26.2969 L818.4531,26.2969 L818.4531,19.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="163" x="831.5" y="27.8467">AuthenticationProvider</text><line style="stroke:#181818;stroke-width:0.5;" x1="803.5" x2="996.5" y1="39" y2="39"/><line style="stroke:#181818;stroke-width:0.5;" x1="803.5" x2="996.5" y1="47" y2="47"/></g><!--MD5=[b87e532ea19bf6765177dedb1b69328c]
class AuthenticationUserDetailsService--><g id="elem_AuthenticationUserDetailsService"><rect codeLine="14" fill="#F1F1F1" height="64.2969" id="AuthenticationUserDetailsService" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="549" x="628.5" y="274"/><ellipse cx="701.75" cy="290" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M702.7031,286.7813 L704.4219,286.7813 C704.8125,286.7813 705,286.75 705.125,286.6719 C705.3906,286.5156 705.5313,286.2344 705.5313,285.9375 C705.5313,285.6719 705.4219,285.4063 705.1875,285.2344 C705.0156,285.125 704.875,285.0938 704.4219,285.0938 L699.2813,285.0938 C698.8438,285.0938 698.7188,285.1094 698.5625,285.2031 C698.3125,285.3594 698.1563,285.6563 698.1563,285.9375 C698.1563,286.2188 698.2969,286.4688 698.5156,286.6406 C698.6719,286.75 698.8594,286.7813 699.2813,286.7813 L701,286.7813 L701,293.2969 L699.2813,293.2969 C698.8438,293.2969 698.7188,293.3125 698.5625,293.4219 C698.3125,293.5781 698.1563,293.8594 698.1563,294.1563 C698.1563,294.4063 698.2969,294.6719 698.5156,294.8281 C698.6719,294.9531 698.875,295 699.2813,295 L704.4219,295 C705.1719,295 705.5313,294.7188 705.5313,294.1563 C705.5313,293.875 705.4219,293.625 705.1875,293.4531 C705.0156,293.3281 704.875,293.2969 704.4219,293.2969 L702.7031,293.2969 L702.7031,286.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="238" x="722.25" y="294.8467">AuthenticationUserDetailsService</text><rect fill="#FFFFFF" height="15.9688" style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" width="154" x="1026.5" y="271"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="152" x="1027.5" y="283.1387">T extends Authentication</text><line style="stroke:#181818;stroke-width:0.5;" x1="629.5" x2="1176.5" y1="306" y2="306"/><line style="stroke:#181818;stroke-width:0.5;" x1="629.5" x2="1176.5" y1="314" y2="314"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="537" x="634.5" y="330.9951">UserDetails loadUserDetails(T token) throws UsernameNotFoundException;</text></g><!--MD5=[2443eed8f9e9a988abe676176e90dba7]
class PreAuthenticatedGrantedAuthoritiesUserDetailsService--><g id="elem_PreAuthenticatedGrantedAuthoritiesUserDetailsService"><rect codeLine="17" fill="#F1F1F1" height="48" id="PreAuthenticatedGrantedAuthoritiesUserDetailsService" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="667" x="569.5" y="399"/><ellipse cx="584.5" cy="415" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M586.8438,410.6719 C585.9063,410.2344 585.3125,410.0938 584.4375,410.0938 C581.8125,410.0938 579.8125,412.1719 579.8125,414.8906 L579.8125,416.0156 C579.8125,418.5938 581.9219,420.4844 584.8125,420.4844 C586.0313,420.4844 587.1875,420.1875 587.9375,419.6406 C588.5156,419.2344 588.8438,418.7813 588.8438,418.3906 C588.8438,417.9375 588.4531,417.5469 587.9844,417.5469 C587.7656,417.5469 587.5625,417.625 587.375,417.8125 C586.9219,418.2969 586.9219,418.2969 586.7344,418.3906 C586.3125,418.6563 585.625,418.7813 584.8594,418.7813 C582.8125,418.7813 581.5156,417.6875 581.5156,415.9844 L581.5156,414.8906 C581.5156,413.1094 582.7656,411.7969 584.5,411.7969 C585.0781,411.7969 585.6875,411.9531 586.1563,412.2031 C586.6406,412.4844 586.8125,412.7031 586.9063,413.1094 C586.9688,413.5156 587,413.6406 587.1406,413.7656 C587.2813,413.9063 587.5156,414.0156 587.7344,414.0156 C588,414.0156 588.2656,413.875 588.4375,413.6563 C588.5469,413.5 588.5781,413.3125 588.5781,412.8906 L588.5781,411.4688 C588.5781,411.0313 588.5625,410.9063 588.4688,410.75 C588.3125,410.4844 588.0313,410.3438 587.7344,410.3438 C587.4375,410.3438 587.2344,410.4375 587.0156,410.75 L586.8438,410.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="401" x="598.5" y="419.8467">PreAuthenticatedGrantedAuthoritiesUserDetailsService</text><rect fill="#FFFFFF" height="15.9688" style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" width="232" x="1007.5" y="396"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="230" x="1008.5" y="408.1387">PreAuthenticatedAuthenticationToken</text><line style="stroke:#181818;stroke-width:0.5;" x1="570.5" x2="1235.5" y1="431" y2="431"/><line style="stroke:#181818;stroke-width:0.5;" x1="570.5" x2="1235.5" y1="439" y2="439"/></g><!--MD5=[be6a3d1dcac53e2ab4826498bc5756be]
reverse link Authentication to PreAuthenticatedAuthenticationToken--><g id="link_Authentication_PreAuthenticatedAuthenticationToken"><path d="M142.146,188.789 C148.498,191.613 154.857,194.39 161,197 C233.93,227.987 318.994,260.776 375.202,281.985 " fill="none" id="Authentication-backto-PreAuthenticatedAuthenticationToken" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="139.247,195.161,123.9,180.55,145.009,182.401,139.247,195.161" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[6a6411c5d703042920fd9f98f82c0708]
link AbstractPreAuthenticatedProcessingFilter to PreAuthenticatedAuthenticationToken--><g id="link_AbstractPreAuthenticatedProcessingFilter_PreAuthenticatedAuthenticationToken"><path codeLine="9" d="M437.732,197.027 C437.562,222.15 437.345,254.08 437.192,276.682 " fill="none" id="AbstractPreAuthenticatedProcessingFilter-to-PreAuthenticatedAuthenticationToken" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="437.156,281.93,441.2151,272.9565,437.1889,276.9301,433.2152,272.9039,437.156,281.93" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="231" x="439" y="240.0669">create with principal and credentials</text></g><!--MD5=[cc780e56c8f9cada408bb05c8a5b7581]
reverse link AuthenticationProvider to PreAuthenticatedAuthenticationProvider--><g id="link_AuthenticationProvider_PreAuthenticatedAuthenticationProvider"><path d="M900,75.348 C900,94.547 900,116.357 900,132.375 " fill="none" id="AuthenticationProvider-backto-PreAuthenticatedAuthenticationProvider" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="893,75.229,900,55.229,907,75.229,893,75.229" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[f8d3de3b2a42b0fc38eede56518a87ee]
link PreAuthenticatedAuthenticationProvider to PreAuthenticatedAuthenticationToken--><g id="link_PreAuthenticatedAuthenticationProvider_PreAuthenticatedAuthenticationToken"><path codeLine="12" d="M846.643,180.575 C802.301,199.218 737.269,225.335 679,244 C635.88,257.813 587.638,270.513 545.641,280.708 " fill="none" id="PreAuthenticatedAuthenticationProvider-to-PreAuthenticatedAuthenticationToken" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="540.551,281.938,550.2387,283.7123,545.4111,280.7637,548.3598,275.9361,540.551,281.938" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56" x="729" y="240.0669">supports</text></g><!--MD5=[64e46f9a1b0d8687e9d7875f4bda4583]
reverse link AuthenticationUserDetailsService to PreAuthenticatedGrantedAuthoritiesUserDetailsService--><g id="link_AuthenticationUserDetailsService_PreAuthenticatedGrantedAuthoritiesUserDetailsService"><path d="M903,358.1775 C903,372.4037 903,387.1525 903,398.8836 " fill="none" id="AuthenticationUserDetailsService-backto-PreAuthenticatedGrantedAuthoritiesUserDetailsService" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="896,358.1207,903,338.121,910,358.1206,896,358.1207" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[4bd39572668121beefccfb4aacee4120]
link PreAuthenticatedAuthenticationProvider to AuthenticationUserDetailsService--><g id="link_PreAuthenticatedAuthenticationProvider_AuthenticationUserDetailsService"><path codeLine="18" d="M900.713,192.5445 C900.713,192.5445 901.665,239.375 902.101,260.816 " fill="none" id="PreAuthenticatedAuthenticationProvider-AuthenticationUserDetailsService" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="902.367,273.899,906.1822,264.8191,902.2648,268.9,898.1839,264.9826,902.367,273.899" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="902.2648" x2="902.103" y1="268.9" y2="260.902"/><polygon fill="none" points="900.469,180.547,896.5918,186.6271,900.713,192.5445,904.5902,186.4644,900.469,180.547" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="902" y="240.0669">get user</text></g><!--MD5=[245263a28ba6290dde98b9cfeb00e482]
@startuml
interface Authentication
class PreAuthenticatedAuthenticationToken implements Authentication

abstract class AbstractPreAuthenticatedProcessingFilter {
    Object getPreAuthenticatedPrincipal(HttpServletRequest request);
    Object getPreAuthenticatedCredentials(HttpServletRequest request);
}

AbstractPreAuthenticatedProcessingFilter - -> PreAuthenticatedAuthenticationToken: create with principal and credentials

class PreAuthenticatedAuthenticationProvider implements AuthenticationProvider
PreAuthenticatedAuthenticationProvider - -> PreAuthenticatedAuthenticationToken: supports

interface AuthenticationUserDetailsService<T extends Authentication> {
    UserDetails loadUserDetails(T token) throws UsernameNotFoundException;
}
class PreAuthenticatedGrantedAuthoritiesUserDetailsService<PreAuthenticatedAuthenticationToken> implements AuthenticationUserDetailsService
PreAuthenticatedAuthenticationProvider o- -> AuthenticationUserDetailsService: get user
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<ul>
<li>AbstractPreAuthenticatedProcessingFilter, Pre-Authentication Framework的入口</li>
<li>PreAuthenticatedAuthenticationToken, 包含第三方的用户校验信息或者认证成功后的用户信息</li>
<li>PreAuthenticatedAuthenticationProvider, Pre-Authentication Framework默认的校验器</li>
<li>AuthenticationUserDetailsService, 同第三方进行校验, 在校验成功后获取系统中的用户信息</li>
</ul>
<h3 id="Remember-Me"><a href="#Remember-Me" class="headerlink" title="Remember Me"></a>Remember Me</h3><p>待续</p>
<h2 id="Session管理"><a href="#Session管理" class="headerlink" title="Session管理"></a>Session管理</h2><p>Http Session相关的功能都在以下组件中进行处理:</p>
<ul>
<li>SessionManagementFilter</li>
<li>SessionAuthenticationStrategy, 对认证成功的用户进行session校验</li>
<li>SessionRegistry, 存储session和认证后的用户信息的键值对</li>
</ul>
<p>主要处理以下问题:</p>
<ul>
<li>防御会话固定攻击(session-fixation protection attack)<ul>
<li>SessionFixationProtectionStrategy</li>
</ul>
</li>
<li>检查Session是否超时<ul>
<li>InvalidSessionStrategy, 对无效session进行处理</li>
</ul>
</li>
<li>限制用户的同时登录数<ul>
<li>ConcurrentSessionFilter</li>
<li>ConcurrentSessionControlAuthenticationStrategy</li>
</ul>
</li>
</ul>
<h2 id="登出处理"><a href="#登出处理" class="headerlink" title="登出处理"></a>登出处理</h2><p>登出时会对用户相关的登录信息进行清理:</p>
<ul>
<li>session无效化</li>
<li>清理SecurityContextHolder</li>
<li>重导向到登录页面</li>
<li>清理Cookies</li>
</ul>
<p>通过LogoutHandler进行清理, 不可以抛出异常.</p>
<p>LogoutSuccessHandler在logout成功后,<br>进行重定向(默认为/login?logout)或者返回指定的http status code(默认为200).</p>
<h2 id="Authentication-Events"><a href="#Authentication-Events" class="headerlink" title="Authentication Events"></a>Authentication Events</h2><p>登录成功或者失败都会触发AuthenticationException事件, 根据事件做额外的处理.<br>通过AuthenticationEventPublisher来监听这些事件.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://docs.spring.io/spring-security/site/docs/5.4.2/reference/html5/#servlet-authentication">Servlet Authentication</a></li>
</ul>
]]></content>
      <categories>
        <category>Spring Security</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>Spring Security</tag>
        <tag>认证</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Security --- Authorization</title>
    <url>/2021/08/spring-security/authorization/</url>
    <content><![CDATA[<p>Spring Security提供了以下几种方式进行鉴权:</p>
<ul>
<li>pre-invocation handling, 在使用被保护资源之前进行鉴权</li>
<li>after invocation handling， 对调用后返回的被保护资源， 通过鉴权进行过滤</li>
<li>FilterSecurityInterceptor, 在请求处理链中根据请求进行鉴权</li>
<li>基于SpEL(Spring Expression Language)， 通过注解对被保护资源进行鉴权</li>
</ul>
<a id="more"></a>

<h2 id="Architecture-Core"><a href="#Architecture-Core" class="headerlink" title="Architecture Core"></a>Architecture Core</h2><h3 id="Pre-Invocation-Handling"><a href="#Pre-Invocation-Handling" class="headerlink" title="Pre-Invocation Handling"></a>Pre-Invocation Handling</h3><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="382px" preserveAspectRatio="none" style="width:1944px;height:382px;background:#FFFFFF;" version="1.1" viewBox="0 0 1944 382" width="1944px" zoomAndPan="magnify"><defs/><g><!--MD5=[afcb8546e38fd0254ebcf2f9ef9d8004]
cluster Authorization--><g id="cluster_Authorization"><path d="M8.5,118 L122.5,118 A3.75,3.75 0 0 1 125,120.5 L132,140.2969 L1437.5,140.2969 A2.5,2.5 0 0 1 1440,142.7969 L1440,372.5 A2.5,2.5 0 0 1 1437.5,375 L8.5,375 A2.5,2.5 0 0 1 6,372.5 L6,120.5 A2.5,2.5 0 0 1 8.5,118 " style="stroke:#000000;stroke-width:1.5;fill:none;"/><line style="stroke:#000000;stroke-width:1.5;fill:none;" x1="6" x2="132" y1="140.2969" y2="140.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="113" x="10" y="132.9951">Authorization</text></g><!--MD5=[e3e144d13ada41eaab5375ff982d1fe4]
class GrantedAuthority--><g id="elem_GrantedAuthority"><rect codeLine="3" fill="#F1F1F1" height="64.2969" id="GrantedAuthority" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="168" x="22" y="169.5"/><ellipse cx="42.85" cy="185.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M43.8031,182.2813 L45.5219,182.2813 C45.9125,182.2813 46.1,182.25 46.225,182.1719 C46.4906,182.0156 46.6313,181.7344 46.6313,181.4375 C46.6313,181.1719 46.5219,180.9063 46.2875,180.7344 C46.1156,180.625 45.975,180.5938 45.5219,180.5938 L40.3813,180.5938 C39.9438,180.5938 39.8188,180.6094 39.6625,180.7031 C39.4125,180.8594 39.2563,181.1563 39.2563,181.4375 C39.2563,181.7188 39.3969,181.9688 39.6156,182.1406 C39.7719,182.25 39.9594,182.2813 40.3813,182.2813 L42.1,182.2813 L42.1,188.7969 L40.3813,188.7969 C39.9438,188.7969 39.8188,188.8125 39.6625,188.9219 C39.4125,189.0781 39.2563,189.3594 39.2563,189.6563 C39.2563,189.9063 39.3969,190.1719 39.6156,190.3281 C39.7719,190.4531 39.975,190.5 40.3813,190.5 L45.5219,190.5 C46.2719,190.5 46.6313,190.2188 46.6313,189.6563 C46.6313,189.375 46.5219,189.125 46.2875,188.9531 C46.1156,188.8281 45.975,188.7969 45.5219,188.7969 L43.8031,188.7969 L43.8031,182.2813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="123" x="58.15" y="190.3467">GrantedAuthority</text><line style="stroke:#181818;stroke-width:0.5;" x1="23" x2="189" y1="201.5" y2="201.5"/><line style="stroke:#181818;stroke-width:0.5;" x1="23" x2="189" y1="209.5" y2="209.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="156" x="28" y="226.4951">String getAuthority();</text></g><g id="elem_GMN53460"><path d="M225,181.5 L225,197.5 L190.404,201.5 L225,205.5 L225,221.7656 A0,0 0 0 0 225,221.7656 L417,221.7656 A0,0 0 0 0 417,221.7656 L417,191.5 L407,181.5 L225,181.5 A0,0 0 0 0 225,181.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M407,181.5 L407,191.5 L417,191.5 L407,181.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="231" y="198.5669">如果无法用String进行描述，</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="231" y="213.6997">则需返回null</text></g><!--MD5=[adc8916905935507507a42e1b12cf196]
class SimpleGrantedAuthority--><g id="elem_SimpleGrantedAuthority"><rect codeLine="11" fill="#F1F1F1" height="48" id="SimpleGrantedAuthority" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="209" x="22.5" y="311"/><ellipse cx="37.5" cy="327" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M39.8438,322.6719 C38.9063,322.2344 38.3125,322.0938 37.4375,322.0938 C34.8125,322.0938 32.8125,324.1719 32.8125,326.8906 L32.8125,328.0156 C32.8125,330.5938 34.9219,332.4844 37.8125,332.4844 C39.0313,332.4844 40.1875,332.1875 40.9375,331.6406 C41.5156,331.2344 41.8438,330.7813 41.8438,330.3906 C41.8438,329.9375 41.4531,329.5469 40.9844,329.5469 C40.7656,329.5469 40.5625,329.625 40.375,329.8125 C39.9219,330.2969 39.9219,330.2969 39.7344,330.3906 C39.3125,330.6563 38.625,330.7813 37.8594,330.7813 C35.8125,330.7813 34.5156,329.6875 34.5156,327.9844 L34.5156,326.8906 C34.5156,325.1094 35.7656,323.7969 37.5,323.7969 C38.0781,323.7969 38.6875,323.9531 39.1563,324.2031 C39.6406,324.4844 39.8125,324.7031 39.9063,325.1094 C39.9688,325.5156 40,325.6406 40.1406,325.7656 C40.2813,325.9063 40.5156,326.0156 40.7344,326.0156 C41,326.0156 41.2656,325.875 41.4375,325.6563 C41.5469,325.5 41.5781,325.3125 41.5781,324.8906 L41.5781,323.4688 C41.5781,323.0313 41.5625,322.9063 41.4688,322.75 C41.3125,322.4844 41.0313,322.3438 40.7344,322.3438 C40.4375,322.3438 40.2344,322.4375 40.0156,322.75 L39.8438,322.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="177" x="51.5" y="331.8467">SimpleGrantedAuthority</text><line style="stroke:#181818;stroke-width:0.5;" x1="23.5" x2="230.5" y1="343" y2="343"/><line style="stroke:#181818;stroke-width:0.5;" x1="23.5" x2="230.5" y1="351" y2="351"/></g><!--MD5=[3c3699dab3baf2740bb151cfc90fd64b]
class AccessDecisionManager--><g id="elem_AccessDecisionManager"><rect codeLine="13" fill="#F1F1F1" height="96.8906" id="AccessDecisionManager" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="971" x="452.5" y="153"/><ellipse cx="847.25" cy="169" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M848.2031,165.7813 L849.9219,165.7813 C850.3125,165.7813 850.5,165.75 850.625,165.6719 C850.8906,165.5156 851.0313,165.2344 851.0313,164.9375 C851.0313,164.6719 850.9219,164.4063 850.6875,164.2344 C850.5156,164.125 850.375,164.0938 849.9219,164.0938 L844.7813,164.0938 C844.3438,164.0938 844.2188,164.1094 844.0625,164.2031 C843.8125,164.3594 843.6563,164.6563 843.6563,164.9375 C843.6563,165.2188 843.7969,165.4688 844.0156,165.6406 C844.1719,165.75 844.3594,165.7813 844.7813,165.7813 L846.5,165.7813 L846.5,172.2969 L844.7813,172.2969 C844.3438,172.2969 844.2188,172.3125 844.0625,172.4219 C843.8125,172.5781 843.6563,172.8594 843.6563,173.1563 C843.6563,173.4063 843.7969,173.6719 844.0156,173.8281 C844.1719,173.9531 844.375,174 844.7813,174 L849.9219,174 C850.6719,174 851.0313,173.7188 851.0313,173.1563 C851.0313,172.875 850.9219,172.625 850.6875,172.4531 C850.5156,172.3281 850.375,172.2969 849.9219,172.2969 L848.2031,172.2969 L848.2031,165.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="173" x="867.75" y="173.8467">AccessDecisionManager</text><line style="stroke:#181818;stroke-width:0.5;" x1="453.5" x2="1422.5" y1="185" y2="185"/><line style="stroke:#181818;stroke-width:0.5;" x1="453.5" x2="1422.5" y1="193" y2="193"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="959" x="458.5" y="209.9951">void decide(Authentication authentication, Object secureObject, Collection&lt;ConfigAttribute&gt; attrs) throws AccessDeniedException;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="326" x="458.5" y="226.292">boolean supports(ConfigAttribute attribute);</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="217" x="458.5" y="242.5889">boolean supports(Class clazz);</text></g><!--MD5=[a139e992f8a77546bf37c14edd197f06]
class Authentication--><g id="elem_Authentication"><rect codeLine="21" fill="#F1F1F1" height="48" id="Authentication" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="136" x="474" y="7"/><ellipse cx="489" cy="23" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M489.9531,19.7813 L491.6719,19.7813 C492.0625,19.7813 492.25,19.75 492.375,19.6719 C492.6406,19.5156 492.7813,19.2344 492.7813,18.9375 C492.7813,18.6719 492.6719,18.4063 492.4375,18.2344 C492.2656,18.125 492.125,18.0938 491.6719,18.0938 L486.5313,18.0938 C486.0938,18.0938 485.9688,18.1094 485.8125,18.2031 C485.5625,18.3594 485.4063,18.6563 485.4063,18.9375 C485.4063,19.2188 485.5469,19.4688 485.7656,19.6406 C485.9219,19.75 486.1094,19.7813 486.5313,19.7813 L488.25,19.7813 L488.25,26.2969 L486.5313,26.2969 C486.0938,26.2969 485.9688,26.3125 485.8125,26.4219 C485.5625,26.5781 485.4063,26.8594 485.4063,27.1563 C485.4063,27.4063 485.5469,27.6719 485.7656,27.8281 C485.9219,27.9531 486.125,28 486.5313,28 L491.6719,28 C492.4219,28 492.7813,27.7188 492.7813,27.1563 C492.7813,26.875 492.6719,26.625 492.4375,26.4531 C492.2656,26.3281 492.125,26.2969 491.6719,26.2969 L489.9531,26.2969 L489.9531,19.7813 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="104" x="503" y="27.8467">Authentication</text><line style="stroke:#181818;stroke-width:0.5;" x1="475" x2="609" y1="39" y2="39"/><line style="stroke:#181818;stroke-width:0.5;" x1="475" x2="609" y1="47" y2="47"/></g><!--MD5=[e01a0f457b12b1c790c8336f0238b7d5]
class AbstractSecurityInterceptor--><g id="elem_AbstractSecurityInterceptor"><rect codeLine="25" fill="#F1F1F1" height="48" id="AbstractSecurityInterceptor" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="238" x="1455" y="7"/><ellipse cx="1470" cy="23" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1472.3438,18.6719 C1471.4063,18.2344 1470.8125,18.0938 1469.9375,18.0938 C1467.3125,18.0938 1465.3125,20.1719 1465.3125,22.8906 L1465.3125,24.0156 C1465.3125,26.5938 1467.4219,28.4844 1470.3125,28.4844 C1471.5313,28.4844 1472.6875,28.1875 1473.4375,27.6406 C1474.0156,27.2344 1474.3438,26.7813 1474.3438,26.3906 C1474.3438,25.9375 1473.9531,25.5469 1473.4844,25.5469 C1473.2656,25.5469 1473.0625,25.625 1472.875,25.8125 C1472.4219,26.2969 1472.4219,26.2969 1472.2344,26.3906 C1471.8125,26.6563 1471.125,26.7813 1470.3594,26.7813 C1468.3125,26.7813 1467.0156,25.6875 1467.0156,23.9844 L1467.0156,22.8906 C1467.0156,21.1094 1468.2656,19.7969 1470,19.7969 C1470.5781,19.7969 1471.1875,19.9531 1471.6563,20.2031 C1472.1406,20.4844 1472.3125,20.7031 1472.4063,21.1094 C1472.4688,21.5156 1472.5,21.6406 1472.6406,21.7656 C1472.7813,21.9063 1473.0156,22.0156 1473.2344,22.0156 C1473.5,22.0156 1473.7656,21.875 1473.9375,21.6563 C1474.0469,21.5 1474.0781,21.3125 1474.0781,20.8906 L1474.0781,19.4688 C1474.0781,19.0313 1474.0625,18.9063 1473.9688,18.75 C1473.8125,18.4844 1473.5313,18.3438 1473.2344,18.3438 C1472.9375,18.3438 1472.7344,18.4375 1472.5156,18.75 L1472.3438,18.6719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="206" x="1484" y="27.8467">AbstractSecurityInterceptor</text><line style="stroke:#181818;stroke-width:0.5;" x1="1456" x2="1692" y1="39" y2="39"/><line style="stroke:#181818;stroke-width:0.5;" x1="1456" x2="1692" y1="47" y2="47"/></g><!--MD5=[4c5e0ce7b787264d781aeccfd2b745f9]
class MethodSecurityInterceptor--><g id="elem_MethodSecurityInterceptor"><rect codeLine="28" fill="#F1F1F1" height="48" id="MethodSecurityInterceptor" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="230" x="1459" y="177.5"/><ellipse cx="1474" cy="193.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1476.3438,189.1719 C1475.4063,188.7344 1474.8125,188.5938 1473.9375,188.5938 C1471.3125,188.5938 1469.3125,190.6719 1469.3125,193.3906 L1469.3125,194.5156 C1469.3125,197.0938 1471.4219,198.9844 1474.3125,198.9844 C1475.5313,198.9844 1476.6875,198.6875 1477.4375,198.1406 C1478.0156,197.7344 1478.3438,197.2813 1478.3438,196.8906 C1478.3438,196.4375 1477.9531,196.0469 1477.4844,196.0469 C1477.2656,196.0469 1477.0625,196.125 1476.875,196.3125 C1476.4219,196.7969 1476.4219,196.7969 1476.2344,196.8906 C1475.8125,197.1563 1475.125,197.2813 1474.3594,197.2813 C1472.3125,197.2813 1471.0156,196.1875 1471.0156,194.4844 L1471.0156,193.3906 C1471.0156,191.6094 1472.2656,190.2969 1474,190.2969 C1474.5781,190.2969 1475.1875,190.4531 1475.6563,190.7031 C1476.1406,190.9844 1476.3125,191.2031 1476.4063,191.6094 C1476.4688,192.0156 1476.5,192.1406 1476.6406,192.2656 C1476.7813,192.4063 1477.0156,192.5156 1477.2344,192.5156 C1477.5,192.5156 1477.7656,192.375 1477.9375,192.1563 C1478.0469,192 1478.0781,191.8125 1478.0781,191.3906 L1478.0781,189.9688 C1478.0781,189.5313 1478.0625,189.4063 1477.9688,189.25 C1477.8125,188.9844 1477.5313,188.8438 1477.2344,188.8438 C1476.9375,188.8438 1476.7344,188.9375 1476.5156,189.25 L1476.3438,189.1719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="198" x="1488" y="198.3467">MethodSecurityInterceptor</text><line style="stroke:#181818;stroke-width:0.5;" x1="1460" x2="1688" y1="209.5" y2="209.5"/><line style="stroke:#181818;stroke-width:0.5;" x1="1460" x2="1688" y1="217.5" y2="217.5"/></g><!--MD5=[5fe0d3603d5d9cbabcbd5016fbeda9e2]
class FilterSecurityInterceptor--><g id="elem_FilterSecurityInterceptor"><rect codeLine="30" fill="#F1F1F1" height="48" id="FilterSecurityInterceptor" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="213" x="1724.5" y="177.5"/><ellipse cx="1739.5" cy="193.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M1741.8438,189.1719 C1740.9063,188.7344 1740.3125,188.5938 1739.4375,188.5938 C1736.8125,188.5938 1734.8125,190.6719 1734.8125,193.3906 L1734.8125,194.5156 C1734.8125,197.0938 1736.9219,198.9844 1739.8125,198.9844 C1741.0313,198.9844 1742.1875,198.6875 1742.9375,198.1406 C1743.5156,197.7344 1743.8438,197.2813 1743.8438,196.8906 C1743.8438,196.4375 1743.4531,196.0469 1742.9844,196.0469 C1742.7656,196.0469 1742.5625,196.125 1742.375,196.3125 C1741.9219,196.7969 1741.9219,196.7969 1741.7344,196.8906 C1741.3125,197.1563 1740.625,197.2813 1739.8594,197.2813 C1737.8125,197.2813 1736.5156,196.1875 1736.5156,194.4844 L1736.5156,193.3906 C1736.5156,191.6094 1737.7656,190.2969 1739.5,190.2969 C1740.0781,190.2969 1740.6875,190.4531 1741.1563,190.7031 C1741.6406,190.9844 1741.8125,191.2031 1741.9063,191.6094 C1741.9688,192.0156 1742,192.1406 1742.1406,192.2656 C1742.2813,192.4063 1742.5156,192.5156 1742.7344,192.5156 C1743,192.5156 1743.2656,192.375 1743.4375,192.1563 C1743.5469,192 1743.5781,191.8125 1743.5781,191.3906 L1743.5781,189.9688 C1743.5781,189.5313 1743.5625,189.4063 1743.4688,189.25 C1743.3125,188.9844 1743.0313,188.8438 1742.7344,188.8438 C1742.4375,188.8438 1742.2344,188.9375 1742.0156,189.25 L1741.8438,189.1719 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="181" x="1753.5" y="198.3467">FilterSecurityInterceptor</text><line style="stroke:#181818;stroke-width:0.5;" x1="1725.5" x2="1936.5" y1="209.5" y2="209.5"/><line style="stroke:#181818;stroke-width:0.5;" x1="1725.5" x2="1936.5" y1="217.5" y2="217.5"/></g><!--MD5=[21678046347684f21267eb307531f970]
reverse link GrantedAuthority to SimpleGrantedAuthority--><g id="link_GrantedAuthority_SimpleGrantedAuthority"><path d="M114.168,253.65 C117.326,273.421 120.779,295.0471 123.308,310.878 " fill="none" id="GrantedAuthority-backto-SimpleGrantedAuthority" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="107.218,254.517,110.977,233.664,121.043,252.31,107.218,254.517" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[94b1c8ac123e57f9c08f65047d00cbde]
link Authentication to GrantedAuthority--><g id="link_Authentication_GrantedAuthority"><path codeLine="22" d="M461.8201,39.3126 C461.8201,39.3126 287.376,68.187 207,110 C183.032,122.468 160.258,141.942 142.423,159.637 " fill="none" id="Authentication-GrantedAuthority" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="133.047,169.228,142.1987,165.5884,136.5422,165.6526,136.478,159.9961,133.047,169.228" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="136.5422" x2="142.1345" y1="165.6526" y2="159.9315"/><polygon fill="#181818" points="473.73,37.845,467.2858,34.6088,461.8201,39.3126,468.2643,42.5488,473.73,37.845" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="457.8255" y="34.8475">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="7" x="130.6828" y="158.4486">*</text></g><!--MD5=[615aec758c455ffb3b5402a613d9cd9c]
link AccessDecisionManager to Authentication--><g id="link_AccessDecisionManager_Authentication"><path codeLine="23" d="M825.99,152.839 C752.872,121.727 660.337,82.353 601.144,57.166 " fill="none" id="AccessDecisionManager-to-Authentication" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="596.232,55.076,602.9465,62.2813,600.8326,57.0342,606.0796,54.9203,596.232,55.076" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="705" y="98.0669">decide鉴权</text></g><!--MD5=[5b92f5be657d035532bac2e02abcc607]
link AbstractSecurityInterceptor to AccessDecisionManager--><g id="link_AbstractSecurityInterceptor_AccessDecisionManager"><path codeLine="26" d="M1486.9,55.076 C1393.53,79.812 1242.55,119.814 1122.54,151.608 " fill="none" id="AbstractSecurityInterceptor-to-AccessDecisionManager" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="1117.57,152.926,1127.2957,154.4784,1122.402,151.6409,1125.2396,146.7472,1117.57,152.926" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="1369" y="98.0669">use</text></g><!--MD5=[f785b2081df05a5715f1980537338c71]
reverse link AbstractSecurityInterceptor to MethodSecurityInterceptor--><g id="link_AbstractSecurityInterceptor_MethodSecurityInterceptor"><path d="M1574,75.091 C1574,107.682 1574,151.167 1574,177.433 " fill="none" id="AbstractSecurityInterceptor-backto-MethodSecurityInterceptor" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="1567,75.076,1574,55.076,1581,75.076,1567,75.076" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[6b5cbb4b6d75008ea5caf62a6958160d]
reverse link AbstractSecurityInterceptor to FilterSecurityInterceptor--><g id="link_AbstractSecurityInterceptor_FilterSecurityInterceptor"><path d="M1633.13,64.982 C1656.46,78.434 1683.3,94.46 1707,110 C1739.98,131.631 1776.27,158.499 1801.02,177.319 " fill="none" id="AbstractSecurityInterceptor-backto-FilterSecurityInterceptor" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="none" points="1629.59,71.021,1615.69,55.026,1636.53,58.862,1629.59,71.021" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[6b0786b82feed1a7710c0cdec6b2e6c0]
@startuml
package Authorization {

interface GrantedAuthority {
    String getAuthority();
}
note left
如果无法用String进行描述， 
则需返回null
end note

class SimpleGrantedAuthority implements GrantedAuthority

interface AccessDecisionManager {
    void decide(Authentication authentication, Object secureObject, Collection<ConfigAttribute> attrs) throws AccessDeniedException;
    boolean supports(ConfigAttribute attribute);
    boolean supports(Class clazz);
}

}

interface Authentication
Authentication "1" *- -> "*" GrantedAuthority
AccessDecisionManager - -> Authentication: decide鉴权

class AbstractSecurityInterceptor
AbstractSecurityInterceptor - -> AccessDecisionManager: use

class MethodSecurityInterceptor extends AbstractSecurityInterceptor

class FilterSecurityInterceptor extends AbstractSecurityInterceptor
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<ul>
<li>GrantedAuthority, 描述用户的权限</li>
<li>AccessDecisionManager， 决定用户是否有对受保护资源的访问权限</li>
</ul>
<p>在访问受保护资源之前， 对用户进行鉴权</p>
<p><img src="/2021/08/spring-security/authorization/access-decision-voting.png"></p>
<h3 id="After-Invocation-Handling"><a href="#After-Invocation-Handling" class="headerlink" title="After Invocation Handling"></a>After Invocation Handling</h3><p>对方法放回的值根据用户权限进行再过滤，只返回用户可以访问的资源</p>
<p><img src="/2021/08/spring-security/authorization/after-invocation.png"></p>
<ul>
<li>PostInvocationAdviceProvider, 当使用@PostAuthorize和@PostFilter注解时调用</li>
</ul>
<h2 id="FilterSecurityInterceptor"><a href="#FilterSecurityInterceptor" class="headerlink" title="FilterSecurityInterceptor"></a>FilterSecurityInterceptor</h2><p>在调用链中对请求进行鉴权</p>
<p><img src="/2021/08/spring-security/authorization/filtersecurityinterceptor.png"></p>
<h2 id="基于SpEL-Spring-Expression-Language"><a href="#基于SpEL-Spring-Expression-Language" class="headerlink" title="基于SpEL(Spring Expression Language)"></a>基于SpEL(Spring Expression Language)</h2><p>Spring Security 3.0引入， 通过注解对被保护资源进行鉴权</p>
<ul>
<li>内置校验表达式，返回boolean进行校验，常用的有：<ul>
<li><code>hasRole</code></li>
<li><code>hasPermission</code></li>
<li><code>authentication</code>, 访问Authentication对象</li>
<li><code>principal</code>，访问当前对象</li>
</ul>
</li>
<li><code>@&lt;bean_name&gt;.&lt;function&gt;</code>, 引用bean中返回boolean的方法</li>
<li><code>#&lt;path_variable&gt;</code>, 引用方法参数列表中的变量</li>
</ul>
<p>通过<code>EnableGlobalMethodSecurity注解</code>开启@Pre和@Post注解功能:</p>
<ul>
<li>@PreAuthorize, 对方法是否可以访问进行校验</li>
<li>@PostAuthorize注解， 可通过<code>returnObject</code>来引用返回值,<br>校验用户是否可以访问返回对象</li>
<li>@PreFilter, 对方法参数列表中的Iterable的对象进行过滤，</li>
<li>@PostFilter注解，对方法返回的Iterable对象进行过滤，<br>可通过<code>filterObject</code>来引用方法返回值</li>
</ul>
<p>优先通过PreFilter进行过滤，避免后续大量无效数据的获取</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#servlet-authorization">Spring Security Authorization</a></li>
<li><a href="">JSR-250</a></li>
<li><a href="">ACL</a></li>
</ul>
]]></content>
      <categories>
        <category>Spring Security</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>Spring Security</tag>
        <tag>鉴权</tag>
      </tags>
  </entry>
  <entry>
    <title>浅谈服务级的测试策略</title>
    <url>/2018/08/test/test-strategy/</url>
    <content><![CDATA[<ul>
<li>学习各个层级的测试方法以及相关工具</li>
</ul>
<a id="more"></a>

<p><img src="/2018/08/test/test-strategy/test-pyramid.png"></p>
<p><img src="/2018/08/test/test-strategy/test-strategy.png"></p>
<h2 id="Unit-Test"><a href="#Unit-Test" class="headerlink" title="Unit Test"></a>Unit Test</h2><p>Unit Test是测试流程中<strong>最小</strong>的测试单元,<br>用于<strong>检验服务中模块的逻辑功能是否正确</strong>,<br>需要开发人员自己维护, 并且每次提交前必须保证所有Unit Test的正确.</p>
<ul>
<li>Sociable unit testing, 是一种<strong>黑盒测试</strong>,<br>它所针对的模块往往是完整的业务流都能够在本模块中完成, 不依赖于外部模块.<br>所以开发人员只关心具体的输入, 是否能够得到预期的输出, 对模块中的完整的流程进行测试<br>这种测试的难点在于需要在设计时<strong>明确模块的边界</strong>, 减小对外部的依赖, 做好解偶.</li>
<li>Solitary unit testing, 是一种<strong>白盒测试</strong>,<br>它所针对的是模块需要和外部模块合作一同来完成业务流.<br>检验本模块相关的业务逻辑是否正确,<br>会对外部的<strong>依赖模块</strong>进行<strong>stub</strong>, 来模拟外部依赖模块的正确返回值;<br>对于这种测试, 维护者需要知道业务逻辑是如何实现的, 才能进行合理的stub. </li>
</ul>
<p>维护人员:</p>
<ul>
<li>开发人员<ul>
<li>测试用例, 针对服务模块</li>
</ul>
</li>
</ul>
<p>应用场景:</p>
<ul>
<li>开发阶段, 检查新功能是否正确, 以及对已有功能是否产生影响</li>
<li>CI, 检查所有模块是否正确, 保证服务的应用<strong>包的正确性</strong></li>
</ul>
<p>实现工具:</p>
<ul>
<li>xUnit系列, 例如JUnit</li>
</ul>
<h2 id="Integration-Test"><a href="#Integration-Test" class="headerlink" title="Integration Test"></a>Integration Test</h2><p>用于检验对<strong>外部依赖服务</strong>的正确集成, 保证服务能够正确的使用外部依赖服务.</p>
<p>维护人员：</p>
<ul>
<li>开发人员<ul>
<li>测试用例, 针对<strong>外部依赖服务</strong>的使用</li>
<li>外部依赖服务的环境, 例如测试用MySQL, Redis等</li>
</ul>
</li>
</ul>
<p>应用场景:</p>
<ul>
<li>开发阶段, 保证正确集成外部依赖, 能够供上层使用</li>
<li>CI, 检验是否正确集成了外部依赖, 保证服务的应用<strong>包的正确性</strong></li>
</ul>
<p>实现工具:</p>
<ul>
<li>xUnit系列, 例如JUnit</li>
</ul>
<h2 id="Component-Test"><a href="#Component-Test" class="headerlink" title="Component Test"></a>Component Test</h2><p>在假设相关<strong>外部依赖服务</strong>完全正确的部署环境的前提下,<br>对<strong>整个服务</strong>进行测试, 检验整个服务的功能正确性, 需要对外部依赖服务进行stub.</p>
<p>维护人员需要对系统的相关外部依赖进行stub, 来保证相关外部依赖能够返回正确的结果.</p>
<p>维护人员:</p>
<ul>
<li>测试人员<ul>
<li>测试用例, 针对整个服务的功能</li>
<li>相关外部依赖服务的stub, 可通过Contract Test来录制数据, 拥有stub的返回</li>
</ul>
</li>
</ul>
<p>应用场景:</p>
<ul>
<li>CD, 检验服务在运行时能够提供正确的功能</li>
</ul>
<p>实现工具:</p>
<ul>
<li>集成测试工具, 例如Selenium, RobotFramework, TestNG等等</li>
<li>WireMock, 用于搭建外部依赖的服务stub</li>
</ul>
<h2 id="Contract-Test"><a href="#Contract-Test" class="headerlink" title="Contract Test"></a>Contract Test</h2><p>用于检验<strong>外部依赖服务</strong>的接口(契约)稳定性, 及时发现接口(契约)是否发生改变.</p>
<p>维护人员:</p>
<ul>
<li>测试人员, 需要了解开发会使用哪些外部依赖服务的接口<ul>
<li>测试用例, 针对外部依赖服务的接口(契约)</li>
<li>外部依赖服务的stub, 录制stub所需的数据</li>
</ul>
</li>
</ul>
<p>应用场景:</p>
<ul>
<li>CD, 检查服务在运行时, 所依赖的外部服务的接口(契约)是否发生变化;<br>如果发生变化, 则及时通知到开发</li>
</ul>
<p>实现工具:</p>
<ul>
<li>xUnit系列, 例如JUnit等</li>
<li>WireMock, 用于录制stu所需要的数据</li>
</ul>
<h2 id="End-to-End-E2E-Test"><a href="#End-to-End-E2E-Test" class="headerlink" title="End-to-End(E2E) Test"></a>End-to-End(E2E) Test</h2><p>用于测试在<strong>真实部署环境</strong>下, 测试<strong>整个服务</strong>在与外部依赖服务<strong>真实集成</strong>后,<br>整个服务提供的功能是否正确.</p>
<p>和Component Test的区别在于, End-to-End Test会使用真实的外部依赖服务,<br>而不是stub.</p>
<p>维护人员:</p>
<ul>
<li>测试人员<ul>
<li>测试用例, 针对整个服务的功能</li>
</ul>
</li>
</ul>
<p>应用场景:</p>
<ul>
<li>CD, 检验整个服务的功能的正确性</li>
</ul>
<p>实现工具:</p>
<ul>
<li>集成测试工具, 例如Selenium, RobotFramework, TestNG等等</li>
</ul>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>测试策略的选择因素:</p>
<ul>
<li>项目的大小</li>
<li>测试策略的价值</li>
</ul>
<p>项目从小到大时, 为保证项目的质量, 引入的测试策略的参考顺序:</p>
<ol>
<li>Unit Test</li>
<li>E2E Test</li>
<li>Integration Test</li>
<li>Contract Test</li>
<li>Component Test</li>
</ol>
<p>测试金字塔两端的测试(Unit Test和E2E Test)的价值往往是最大的, 所以一般在一开始就引入.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://martinfowler.com/articles/microservice-testing/">Testing Strategies in a Microservice Architecture</a></li>
<li><a href="https://martinfowler.com/articles/richardsonMaturityModel.html">Richardson Maturity Model</a></li>
<li><a href="https://spring.io/understanding/HATEOAS">Understanding HATEOAS</a></li>
</ul>
]]></content>
      <categories>
        <category>Test</category>
      </categories>
      <tags>
        <tag>Test</tag>
      </tags>
  </entry>
  <entry>
    <title>观&lt;&lt;你好, 李焕英&gt;&gt;后感</title>
    <url>/2021/02/%E7%94%9F%E6%B4%BB/hi-mum/</url>
    <content><![CDATA[<p>故不积跬步, 无以至千里; 不积小流, 无以成江海.<br>骐骥一跃, 不能十步; 驽马十驾, 功在不舍.<br>锲而舍之, 朽木不折; 锲而不舍, 金石可镂.</p>
<p>— 荀子-劝学</p>
<a id="more"></a>

<p>因为交通事故导致母亲李焕英遭受严重的伤害, 这让身为女儿的贾晓玲深陷自责,<br>觉得自己在其成长的过程中未曾真正让母亲高兴过.<br>当李焕英和贾晓玲都回到了过去,<br>母亲的默默付出为女儿抚平了心中的自责;<br>女儿的努力弥补, 也同样让母亲释怀了曾经的虚荣,<br>只留下”只要健康快乐就好, 而不一定要有多好的成就”的安慰;<br>最后贾晓玲发现了母亲的默默付出时, 她感动了,<br>泪水犹如圣光一般驱散了一切黑暗的自责, 使她得到了自我救赎,<br>并带着母亲遗留的安慰, 健康快乐的生活下去.</p>
<p>这让我们无不感叹母爱的无私和伟大,<br>但是我们更加需要一种健康的母爱以及给予孩子真正健康快乐的成长.</p>
<p>回顾贾晓玲的成长, 母亲的默默付出她从未真切的感受到,<br>更多的是不断的失败和打击, 以及从未给母亲涨涨脸的失落,<br>所以为了去满足母亲的虚荣, 才在最后不得不选择了做假证和撒谎.<br>我想这绝不是一种健康快乐的生活, 也不会是一个母亲真正想要的.</p>
<p>李焕英最后说的”只要健康快乐就好, 而不一定要有多好的成就”,<br>“健康快乐”是她对贾晓玲未来的希望,<br>而”不一定要有多好的成就”却是自己无可奈何的妥协吧.<br>又有哪个母亲会真的希望孩子一事无成呢, 只不过是弥留之际的妥协罢了.<br>因为以后她的孩子将要一个人学着去”健康快乐”的长大, 她又怎会有更多的渴求呢.</p>
<p>与其等待着让孩子一个人学着去”健康快乐”的长大, 为什么不陪着她一起呢.<br>家庭本就应该是互相陪伴, 互相尊重, 共同前进的,<br>而不仅仅只是为了某人而深陷泥沼, 不可自拔.</p>
<p>在她们长大以前, 让我们陪着她们去学会如何健康快乐的长大;<br>在长大之后, 尊重她们的选择, 她们有自己的努力和期待.<br>让她们即使在最艰难的孤独时, 手中也有着一盏温暖的烛光照亮前程,<br>而不是孤零零的面对冰冷的黑暗.</p>
<p>很多时候, 我们往往渴求太多, 却又做的太少, 亦或是做的不那么正确.</p>
<p>时下一些人打着所谓”健康快乐”的幌子而无所作为, 或许只是为了逃避责任.<br>健康不是有一口饭吃, 快乐也绝不等同于放任自流.<br>也许他们所谓的健康快乐, 不是指孩子的健康快乐, 而是自己的”健康快乐”吧.</p>
<p>努力的去生活, 于平凡中向往着不平凡, 于悲伤中寻找快乐,<br>这是我所理解的健康快乐, 它是一种乐观积极的生活态度, 而努力去获得成就这更是一种期待;<br>生活态度需要潜移默化的培养, 成就需要合理的规划,<br>彼此本不矛盾, 只是它们都需要漫长时间的付出才能结果.</p>
<p>孩子的成长, 又何尝不是我们的又一次成长,<br>它需要我们去回顾过去, 亦需要去学习新时代的新事物,<br>然后源源不断的传输给孩子, 同时又从她们身上学会新的东西.<br>放下我们年龄的架子, 尊重彼此, 成就彼此.<br>我们很清楚年长者未必优于年少者, 三字经记述: 昔仲尼, 师项橐.<br>项橐不过7岁的稚童, 而古之圣贤尚能如此,<br>作为平凡的我们又何来的如此尊贵, 不过虚荣作祟罢了.</p>
<p>我承认李焕英的默默付出的母爱的伟大, 却不太赞同这种没有回应的默默付出的行为.<br>没有回应的默默付出是可怕的, 因为不知付出之艰辛, 又如何能知道收获之珍贵呢,<br>不知收获之珍贵, 又怎会珍惜来之不易的收获呢.<br>只会让人形成惰性, 觉得这一切都不过是理所当然的.</p>
<p>我们感慨美丽的事物, 光辉的岁月, 却更需要明白这一切背后的来之不易.</p>
]]></content>
      <categories>
        <category>生活</category>
      </categories>
      <tags>
        <tag>观后感</tag>
      </tags>
  </entry>
  <entry>
    <title>Airflow介绍</title>
    <url>/2020/08/big-data/airflow/airflow-introduction/</url>
    <content><![CDATA[<p>– 了解airflow的基本元素<br>– 了解airflow的并发控制</p>
<a id="more"></a>

<p>基本元素:</p>
<ul>
<li>DAG, 有向无环图, 用于描述整个处理流程中的任务之间的关系和依赖,<br>只有定义在globals(全局作用域)的dag才会被airflow扫描到并加载</li>
<li>Operator, 用于定义任务要去做什么, 尽量保证每个Operator可以独立运行, 没有依赖;<br>如果不能避免依赖, 则通过xcom/其他存储方式进行参数传递</li>
<li>default_args, 可被所有相关dag的Operator共享使用</li>
<li>DAG Run, DAG被触发后生成的具体执行的DAG实例<ul>
<li>创建时间</li>
<li>execution_date, DAG Run的开始执行时间,<br>在同一个DAG中必须保持唯一, 即在同一个DAG在同一时间只能有一个DAG Run.</li>
</ul>
</li>
<li>Task, Operator实例</li>
<li>Task instance, 每次触发Task都会生成一个task instance, 用于记录这次的task运行.<br>它拥有很多的状态, 状态的完成生命周期:<ol>
<li>no status</li>
<li>scheduled, scheduler已计划将要运行对应的task instance</li>
<li>queued, dispatch将task instance发送对相关的队列上进行排队</li>
<li>Running, worker拿到队列中的任务进行执行</li>
<li>success/failed, 任务完成后</li>
</ol>
</li>
</ul>
<p><img src="https://airflow.apache.org/docs/stable/_images/task_lifecycle_diagram.png"></p>
<h2 id="DAG调度"><a href="#DAG调度" class="headerlink" title="DAG调度"></a>DAG调度</h2><p>通过在DAG中定义<strong>schedule_interval</strong>来指定如何调度,<br>schedule_interval最好指定为预定义的值或者cron表达式</p>
<p>DAG的调度分为:</p>
<ul>
<li>手动触发, 即schedule_interval=None</li>
<li>周期性调度<ul>
<li>backfill and catchup, 根据start_date到现在为止, 来创建过去的Dag Run并依次执行.<br>针对以时间为周期的数据集非常有用.</li>
<li>非回填追赶模式, 即DAG的catchup=False, 不会为过去创建Dag Run.</li>
</ul>
</li>
</ul>
<p>关于周期性调度的DAG, 它的创建时间为<code>上一个DAG Run的创建时间+schedule_interval</code>,<br>而第一个DAG Run的创建时间为min(start_date),<br>务必将start_date设置为一个指定的值</p>
<h2 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h2><ul>
<li>Pools, 用于控制task instance的并行数,<br>它由以下元素组成, 默认任务会被分配到default_pool池中, 它的工作槽有128个位置:<ul>
<li>工作槽, 用于指定可同时运行的任务数</li>
<li>等待队列, 当工作槽满时, 任务就进入等待队列, 直到工作槽有空闲位置</li>
<li>priority_weight, 用于定义队列中的任务优先级以及在工作槽有空闲位置时优先执行哪些任务,<br>默认任务本身的priority_weight为1, 但在评估任务优先级时会计算任务本身及其下游任务的总和.</li>
</ul>
</li>
<li>Celery Queue, 只在使用CeleryExecutor时才有用, 用于给任务贴标签,<br>这样工作节点就可以通过标签来筛选要执行哪些任务. 默认任务会被分配到default_queue.</li>
</ul>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="395px" preserveAspectRatio="none" style="width:864px;height:395px;background:#FFFFFF;" version="1.1" viewBox="0 0 864 395" width="864px" zoomAndPan="magnify"><defs/><g><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="23" x2="23" y1="67.2969" y2="317.2266"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="169.5" x2="169.5" y1="67.2969" y2="317.2266"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="286" x2="286" y1="67.2969" y2="317.2266"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="542" x2="542" y1="67.2969" y2="317.2266"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="665" x2="665" y1="67.2969" y2="317.2266"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="760" x2="760" y1="67.2969" y2="317.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21" x="9.5" y="63.9951">Db</text><path d="M5,15 C5,5 23,5 23,5 C23,5 41,5 41,15 L41,41 C41,51 23,51 23,51 C23,51 5,51 5,41 L5,15 " fill="#E2E2F0" style="stroke:#181818;stroke-width:1.5;"/><path d="M5,15 C5,25 23,25 23,25 C23,25 41,25 41,15 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21" x="9.5" y="329.2217">Db</text><path d="M5,342.5234 C5,332.5234 23,332.5234 23,332.5234 C23,332.5234 41,332.5234 41,342.5234 L41,368.5234 C41,378.5234 23,378.5234 23,378.5234 C23,378.5234 5,378.5234 5,368.5234 L5,342.5234 " fill="#E2E2F0" style="stroke:#181818;stroke-width:1.5;"/><path d="M5,342.5234 C5,352.5234 23,352.5234 23,352.5234 C23,352.5234 41,352.5234 41,342.5234 " fill="none" style="stroke:#181818;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69" x="132.5" y="63.9951">scheduler</text><ellipse cx="170" cy="35" fill="#E2E2F0" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#181818" points="166,23,172,18,170,23,172,28,166,23" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="69" x="132.5" y="329.2217">scheduler</text><ellipse cx="170" cy="348.5234" fill="#E2E2F0" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#181818" points="166,336.5234,172,331.5234,170,336.5234,172,341.5234,166,336.5234" style="stroke:#181818;stroke-width:1.0;"/><path d="M237,41 L335,41 C340,41 340,54.1484 340,54.1484 C340,54.1484 340,67.2969 335,67.2969 L237,67.2969 C232,67.2969 232,54.1484 232,54.1484 C232,54.1484 232,41 237,41 " fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M335,41 C330,41 330,54.1484 330,54.1484 C330,67.2969 335,67.2969 335,67.2969 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="237" y="58.9951">AirflowPools</text><path d="M237,316.2266 L335,316.2266 C340,316.2266 340,329.375 340,329.375 C340,329.375 340,342.5234 335,342.5234 L237,342.5234 C232,342.5234 232,329.375 232,329.375 C232,329.375 232,316.2266 237,316.2266 " fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M335,316.2266 C330,316.2266 330,329.375 330,329.375 C330,342.5234 335,342.5234 335,342.5234 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="237" y="334.2217">AirflowPools</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="484" y="63.9951">CeleryExecutor</text><ellipse cx="542" cy="35" fill="#E2E2F0" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#181818" points="538,23,544,18,542,23,544,28,538,23" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="484" y="329.2217">CeleryExecutor</text><ellipse cx="542" cy="348.5234" fill="#E2E2F0" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#181818" points="538,336.5234,544,331.5234,542,336.5234,544,341.5234,538,336.5234" style="stroke:#181818;stroke-width:1.0;"/><path d="M615,41 L716,41 C721,41 721,54.1484 721,54.1484 C721,54.1484 721,67.2969 716,67.2969 L615,67.2969 C610,67.2969 610,54.1484 610,54.1484 C610,54.1484 610,41 615,41 " fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M716,41 C711,41 711,54.1484 711,54.1484 C711,67.2969 716,67.2969 716,67.2969 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="615" y="58.9951">CeleryQueue</text><path d="M615,316.2266 L716,316.2266 C721,316.2266 721,329.375 721,329.375 C721,329.375 721,342.5234 716,342.5234 L615,342.5234 C610,342.5234 610,329.375 610,329.375 C610,329.375 610,316.2266 615,316.2266 " fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M716,316.2266 C711,316.2266 711,329.375 711,329.375 C711,342.5234 716,342.5234 716,342.5234 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="615" y="334.2217">CeleryQueue</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="53" x="731" y="63.9951">Worker</text><ellipse cx="760.5" cy="35" fill="#E2E2F0" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#181818" points="756.5,23,762.5,18,760.5,23,762.5,28,756.5,23" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="53" x="731" y="329.2217">Worker</text><ellipse cx="760.5" cy="348.5234" fill="#E2E2F0" rx="12" ry="12" style="stroke:#181818;stroke-width:0.5;"/><polygon fill="#181818" points="756.5,336.5234,762.5,331.5234,760.5,336.5234,762.5,341.5234,756.5,336.5234" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="34,94.4297,24,98.4297,34,102.4297,30,98.4297" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="28" x2="169" y1="98.4297" y2="98.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="40" y="93.3638">get no status tasks</text><polygon fill="#181818" points="274,123.5625,284,127.5625,274,131.5625,278,127.5625" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="170" x2="280" y1="127.5625" y2="127.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="177" y="122.4966">dispatch tasks</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="286" x2="328" y1="156.6953" y2="156.6953"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="328" x2="328" y1="156.6953" y2="169.6953"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="287" x2="328" y1="169.6953" y2="169.6953"/><polygon fill="#181818" points="297,165.6953,287,169.6953,297,173.6953,293,169.6953" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="293" y="151.6294">dispatch tasks by task priority_weight</text><polygon fill="#181818" points="297,194.8281,287,198.8281,297,202.8281,293,198.8281" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="291" x2="541" y1="198.8281" y2="198.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="303" y="193.7622">get high priority_weight tasks</text><polygon fill="#181818" points="653.5,223.9609,663.5,227.9609,653.5,231.9609,657.5,227.9609" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="542" x2="659.5" y1="227.9609" y2="227.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="549" y="222.895">dispatch tasks</text><polygon fill="#181818" points="676.5,253.0938,666.5,257.0938,676.5,261.0938,672.5,257.0938" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="670.5" x2="759.5" y1="257.0938" y2="257.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="682.5" y="252.0278">get tasks</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="760.5" x2="802.5" y1="286.2266" y2="286.2266"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="802.5" x2="802.5" y1="286.2266" y2="299.2266"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="761.5" x2="802.5" y1="299.2266" y2="299.2266"/><polygon fill="#181818" points="771.5,295.2266,761.5,299.2266,771.5,303.2266,767.5,299.2266" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="90" x="767.5" y="281.1606">execute tasks</text><!--MD5=[1a3b1baee63d328adbba741b95ce7308]
@startuml
database Db
control scheduler
queue AirflowPools
control CeleryExecutor
queue CeleryQueue
control Worker

scheduler - -> Db: get no status tasks
scheduler - -> AirflowPools: dispatch tasks
AirflowPools - -> AirflowPools: dispatch tasks by task priority_weight
CeleryExecutor - -> AirflowPools: get high priority_weight tasks
CeleryExecutor - -> CeleryQueue: dispatch tasks
Worker - -> CeleryQueue: get tasks
Worker - -> Worker: execute tasks
@enduml

PlantUML version 1.2022.2(Sat Mar 05 16:30:19 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>

<p>DAG的多维度并发控制的参数:</p>
<ul>
<li>airflow.cfg的parallelism, airflow集群中同时运行的最大task instance数量</li>
<li>airflow.cfg的dag_concurrency, 一个dag run中可以同时执行的task instance数量, 超出则排队;<br>可以通过DAG的concurrency进行自定义</li>
<li>max_active_runs, 针对同一个DAG, 同一时间最多运行几个DAG Run,<br>如果没有设置, 默认读取airflow.cfg的max_active_runs_per_dag</li>
<li>task_concurrency, 控制Operator对应的task同一时间最多运行几个task instance</li>
<li>pool, 指定task的Pools, 通过Pools来控制某类task的最大并发数</li>
</ul>
<p>调度的并发控制参数:</p>
<ul>
<li>airflow.cfg的max_threads, 调度线程数, 可以设置为CPU数-1</li>
<li>airflow.cfg的scheduler_heartbeat_sec, scheduler扫描task并将task调度起来的频率</li>
</ul>
]]></content>
      <categories>
        <category>ETL</category>
      </categories>
      <tags>
        <tag>ETL</tag>
        <tag>数据处理</tag>
      </tags>
  </entry>
</search>
