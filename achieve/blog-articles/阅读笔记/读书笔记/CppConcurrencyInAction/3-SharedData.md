# 线程间共享数据

不变量(invariants)是线程安全的.

条件竞争(race condition)

- 良性的条件竞争,即使执行顺序改变, 也不影响结果.
- 恶性的条件竞争通常发生于多个线程对同一个数据块进行修改.


避免恶性条件竞争

- 对数据进行保护, 确保只有进行修改的线程才能看到修改的中间状态; 从其他线程的角度, 修改不是已经完成就是还未开始.
    + 互斥量(mutex)
- 无锁编程(lock-free)
- 软件事务内存(STM, software transactional memory)

具有访问能力的指针或引用可以访问被保护的数据, 而不会被互斥锁限制.
所以互斥锁保护的数据需要对接口的设计相当谨慎,确保互斥锁能锁住任何对保护数据的访问,并不留后门.

简化接口有利于数据控制,可以保证互斥锁将一个操作完全锁住.

一个给定操作需要两个或两个以上的互斥锁时, 就有可能出现**死锁**.

避免死锁的一些建议:

- 让多个互斥锁总是以相同的顺序上锁
- 尽可能让一个线程只持有一个锁, 若要获取多个锁, 使用std::lock
- 避免在持有锁时调用外部接口
- 
