# 服务器性能剖析

使用**性能剖析(profiling)**来测量服务器的时间花费在哪里.

优化的原则:

- 性能即**响应时间**.
- 无法测量就无法有效的优化
- 

数据库服务器的性能用查询的响应时间来度量, 单位是每个查询话费的时间.

**合适的测量范围**是说只测量需要优化的活动.

完成一项任务所需要的时间分为两部分: **执行时间和等待时间**.

优化执行时间, 最好是通过测量**定位不同的子任务花费的时间**, 
然后优化去掉一些子任务, 降低子任务的执行频率或者提升子任务的效率.

优化等待时间相对要复杂一些, 它往往是由其他系统间接影响导致.

性能剖析一般有两个步骤:

1. 测量任务所花费的时间
2. 对结果进行统计和排序, 将重要任务排到前面


- 基于执行时间的分析, 研究的是**什么任务的执行时间最长**
- 基于等待时间的分析, 研究的是判断任务在**什么地方被阻塞的时间最长**

对系统的性能剖析建议**自上而下**的进行, 这样可以追踪自用户发起到服务器响应的整个流程.

尽可能的测量一切可以测量的地方.

## 剖析MySQL查询

通过**慢查询日志**来剖析整个MySQL服务器的查询性能, 
可以通过设置**long_query_time**来捕获超过该设置响应时间的查询, 
响应时间可以支持到**微秒级**.

慢查询日志几乎没有开销, 除了需要占用大量磁盘.

可以通过[Percona Toolkit --- pt-query-digest][]对慢查询日志进行分析, 生成报告, 更好的去分析问题.

### 单条查询的剖析

可以使用以下几种方法对单条查询进行剖析:

- show status
- show profile
- 检查慢查询日志的条目, 前提是使用Percona Server

#### show profile

默认是禁用的, 可以通过服务器变量在会话(连接)级别动态修改.

```
mysql> set profiling=1;
```

`show profiles`查看所有查询的profiling的信息.
`show profile for query <query_id>`查看单条查询的详细信息，　包括每个步骤及花费的时间．

profiling的信息来源于**INFORMATION_SCHEMA**数据库中对应的表.

#### show status

`show status`查看各种计数器.

`show global staus`查看**服务器级别**的全局计数器;

收集合适级别的


---

[Percona Toolkit --- pt-query-digest]: https://www.percona.com/doc/percona-toolkit/LATEST/pt-query-digest.html
[new relic]: https://newrelic.com/